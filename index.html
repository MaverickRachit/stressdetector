<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeuroWell 2.0 ‚Äî Dashboard (BLE + Gemini + Ambient)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #020617; /* Dark background */
      --card-bg: rgba(255,255,255,0.05); /* Slightly transparent card */
      --card-border: rgba(255,255,255,0.1); /* Subtle border */
      --text: #e6eef8; /* Light text */
      --text-body:#aab7c6; /* Lighter body text */
      --accent: #22d3ee; /* Cyan accent */
      --good:#4ade80; --warn:#facc15; --bad:#f87171; /* Status colors */
      --glass: rgba(255,255,255,0.03); /* Subtle glass effect */
    }
    .light { /* Light theme variables */
      --bg: #f6f8fb;
      --card-bg: rgba(255,255,255,0.95);
      --card-border: rgba(13,18,25,0.08);
      --text: #0b1220;
      --text-body:#475569;
      --accent: #0ea5b7;
      --good:#16a34a; --warn:#d97706; --bad:#dc2626;
      --glass: rgba(255,255,255,0.8);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: radial-gradient(circle at 10% 20%, rgba(34,211,238,0.05), transparent 30%), radial-gradient(circle at 80% 90%, rgba(139,92,246,0.03), transparent 35%), var(--bg);
      color:var(--text-body);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      text-rendering: optimizeLegibility;
      font-synthesis: none;
      transition: background-color .25s ease, color .25s ease;
      padding:14px;
    }
    .wrap{max-width:1200px;margin:12px auto;padding:0 12px;display:flex;flex-direction:column;gap:16px}

    header.appbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--card-border); padding:14px;border-radius:12px;backdrop-filter: blur(10px);
    }
    .title {display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text);font-size:18px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap: wrap;justify-content: flex-end;}

    .btn {
      padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
      transition: all .2s ease;
    }
    .btn:hover { opacity: 0.85; transform: translateY(-2px); }
    .btn:active { opacity: 1; transform: translateY(0); }

    .btn.primary{
      background:var(--accent);color:var(--bg);
      box-shadow: 0 4px 22px rgba(34,211,238,0.25);
    }
    .btn.primary:hover{ box-shadow: 0 6px 26px rgba(34,211,238,0.4); }
    .btn.ghost{background:transparent;border:1px solid var(--card-border);color:var(--text-body)}
    .btn.sos{background:var(--bad);color:#fff;border-radius:10px;padding:8px 12px}
    .btn.small{padding:8px 10px;font-size:12px}

    .dashboard{display:grid;grid-template-columns:1fr;gap:16px;margin-top:6px}
    @media(min-width:1000px){ .dashboard{grid-template-columns:2fr 1fr} }

    .card{
      background:var(--card-bg); border-radius:12px; padding:16px; border:1px solid var(--card-border);
      box-shadow: 0 10px 30px rgba(2,6,23,0.28);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow: 0 14px 35px rgba(2,6,23,0.35);
    }

    label{display:block;color:var(--text-body);font-size:13px;margin-bottom:6px;font-weight:600}
    input[type=number], input[type=text], select {
      padding:10px;border-radius:8px;border:1px solid var(--card-border);
      background:transparent;color:var(--text);width:100%;transition: border-color .2s ease;
    }
    input[type=number]:focus, input[type=text]:focus, select:focus { border-color: var(--accent); outline: none; }
    select option { background: var(--bg); color: var(--text); }

    /* --- Back to 3 columns --- */
    .vitals-grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
    @media(max-width:760px){ .vitals-grid{grid-template-columns:1fr 1fr 1fr; } }
    @media(max-width:500px){ .vitals-grid{grid-template-columns:1fr; } } /* Stack on very small screens */
    .vital{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:12px;text-align:center}
    .vital-label{font-size:12px;color:var(--text-body);display:flex;align-items:center;gap:8px;justify-content:center;font-weight: 600;}
    .vital-value{font-size:40px;font-weight:800;color:var(--text);margin-top:6px}

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    .vital-value.pulsing { animation: pulse 0.3s ease-out; }

    .chart-wrap{height:100px;background:transparent;border-radius:10px;padding:8px; margin-top: 10px;}
    canvas{width:100% !important;height:100% !important;display:block}

    .status-box{padding:12px;border-radius:10px;text-align:center;background:rgba(0,0,0,0.06)}
    #statusText{font-weight:700;color:var(--accent)}
    #count{font-size:34px;font-weight:800;color:var(--text);margin-top:8px}

    #finalLevel{font-size:22px;font-weight:800;padding:10px;border-radius:10px;text-align:center;color:#000;margin-bottom:12px}
    .level-LOW{background:linear-gradient(90deg,var(--good),#86efac)}
    .level-MODERATE{background:linear-gradient(90deg,var(--warn),#fde047)}
    .level-HIGH{background:linear-gradient(90deg,var(--bad),#fca5a5)}
    .level-ERROR{background:linear-gradient(90deg,#9ca3af,#e5e7eb); color: #4b5563;} /* Style for Error */


    #overviewText{ font-size: 14px; color: var(--text); background: var(--glass); padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--card-border); }

    #suggestList li{background:var(--glass);padding:10px;margin-bottom:8px;border-radius:8px;color:var(--text-body);list-style:none}
    .history-list{list-style:none;padding:0;margin:0;max-height:260px;overflow:auto}
    .history-item{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid var(--card-border)}
    .muted{color:var(--text-body);font-size:13px}

    @keyframes modalPopIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-overlay{ position:fixed;inset:0;display:none;align-items:center;justify-content:center; background:rgba(2,6,23,0.6);z-index:200;backdrop-filter: blur(4px); opacity: 0; visibility: hidden; transition: opacity .2s ease, visibility .2s ease; }
    .modal-overlay.active{ display:flex; opacity: 1; visibility: visible; }
    .modal{ width:92%;max-width:520px;background:var(--card-bg);padding:16px; border-radius:12px;border:1px solid var(--card-border); animation: modalPopIn 0.2s ease-out forwards; }
    .modal-overlay:not(.active) .modal { display: none; }

    .breather-container{text-align:center;padding:18px}
    .breath-circle{ width:160px;height:160px;border-radius:50%;display:grid;place-items:center;margin:10px auto; background:linear-gradient(135deg,var(--accent),#8b5cf6);color:var(--bg);font-weight:800;font-size:18px; transform:scale(.6);opacity:.9;border:6px solid rgba(255,255,255,0.04);transition:transform 1s ease; }

    .chat-floating{ position:fixed;right:20px;bottom:22px;width:56px;height:56px;border-radius:50%; display:grid;place-items:center;background:var(--accent);color:var(--bg);z-index:400;cursor:pointer;box-shadow:0 10px 30px rgba(2,6,23,0.4); transition: all .2s ease; }
    .chat-floating:hover { transform: scale(1.1); box-shadow: 0 12px 35px rgba(34,211,238,0.5); }
    .chat-panel{position:fixed;right:20px;bottom:90px;width:360px;max-width:92%;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:12px;z-index:401;display:none;flex-direction:column;gap:8px}
    .chat-panel.active{display:flex}
    .chat-messages{max-height:300px;overflow:auto;padding:8px;border-radius:8px;background:transparent}
    .chat-input{display:flex;gap:8px}
    .audio-toggle{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:999px;border:1px solid var(--card-border);cursor:pointer; transition: all .2s ease;}
    .audio-toggle:hover { border-color: var(--text-body); color: var(--text); }
    .small{font-size:12px}
    @keyframes receivingPulse { 0% { color: var(--accent); } 50% { color: var(--good); } 100% { color: var(--accent); } }
    .pulse-receiving { animation: receivingPulse 0.5s ease-out; }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header class="appbar card">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.001A3 3 0 0 0 12 5zm0 14a3 3 0 1 0-5.997.001A3 3 0 0 0 12 19zm0-7a3 3 0 1 0 5.997-.001A3 3 0 0 0 12 12z"/></svg>
        NeuroWell 2.0
      </div>
      <div class="controls">
        <div id="bleStatus" class="muted">Status: <span style="color:var(--bad);font-weight:800" id="bleStatusText">Disconnected</span></div>
        <button id="profileBtn" class="btn ghost small">Profile</button>
        <button id="resourcesBtn" class="btn ghost small">Resources</button>
        <div class="audio-toggle" id="hbToggle" title="Toggle Heartbeat Sound">‚ù§Ô∏è <span id="hbLabel" class="small">HB Off</span></div>
        <div class="audio-toggle" id="themeToggle" title="Toggle Light / Dark">üåô <span id="themeLabel" class="small">Dark</span></div>
        <button id="sosBtn" class="btn sos">SOS</button>
      </div>
    </header>

    <div class="dashboard">
      <div class="main-col">
        <div class="card">
             <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
              <div style="min-width:220px">
                <label>Room Temperature (¬∞C)</label>
                <div style="display:flex;gap:8px">
                  <input id="roomTemp" type="number" min="10" max="45" value="30" />
                  <button id="getLocationBtn" class="btn ghost" title="Use my location">üìç</button>
                </div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="startBtn" class="btn primary">Connect & Start Test</button>
              </div>
            </div>
        </div>

        <div class="card">
          <div class="vitals-grid">
            <div class="vital">
              <div class="vital-label">üíì HEART RATE</div>
              <div id="valHR" class="vital-value">-- <span style="font-size:14px;color:var(--text-body);font-weight:600;margin-left:4px;">bpm</span></div>
              <div class="chart-wrap"><canvas id="hrChart"></canvas></div>
            </div>
            <div class="vital">
              <div class="vital-label">ü©∏ SpO‚ÇÇ</div>
              <div id="valSp" class="vital-value">-- <span style="font-size:14px;color:var(--text-body);font-weight:600;margin-left:4px;">%</span></div>
              <div class="chart-wrap"><canvas id="spChart"></canvas></div>
            </div>
            <div class="vital">
              <div class="vital-label">‚ö° GSR</div>
              <div id="valGSR" class="vital-value">--</div>
              <div class="chart-wrap"><canvas id="gsrChart"></canvas></div>
            </div>
            </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;color:var(--text)">Live Sensor Stream</div>
            <div class="muted">Real-time graphs ‚Ä¢ Raw data stream</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:220px">
              <div class="status-box">
                <div id="statusText">IDLE</div>
                <div id="count">0<span style="font-size:12px;color:var(--text-body)">s</span></div>
              </div>
            </div>
            <div style="min-width:260px">
              <div style="display:flex;gap:8px;align-items:center">
                <button id="openBreathBtn" class="btn ghost">üßò Start Calming Exercise</button>
                <button id="resetHistoryBtn" class="btn ghost">Clear History</button>
                <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px"><input id="chartToggle" type="checkbox" checked /> Show charts</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="side-col">
         <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;color:var(--text)">Analysis & Suggestions</div>
            <div class="muted">AI-Assisted Suggestions</div>
          </div>
          <div style="margin-top:12px" id="analysis-section" style="display:none;">
            <div id="finalLevel" class="">--</div>
            <div id="overviewText" style="display:none;"></div>
            <ol id="suggestList"></ol>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="askGeminiBtn" class="btn ghost">Ask Gemini for suggestions</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;color:var(--text)">Session History (Last 10)</div>
            <div class="muted">Saved locally</div>
          </div>
          <ul class="history-list" id="history-list" style="margin-top:12px"></ul>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="sos-modal"><div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Emergency Helplines (India)</div>
        <button id="close-sos-modal" class="btn ghost">X</button>
      </div>
      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>Ambulance</div><div style="font-weight:700;color:var(--accent)">102 / 108</div></div>
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>Police</div><div style="font-weight:700;color:var(--accent)">100 / 112</div></div>
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>National Mental Health</div><div style="font-weight:700;color:var(--accent)">1800-599-0019</div></div>
      </div>
    </div></div>

    <div class="modal-overlay" id="breather-modal"><div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Calming Exercise</div>
        <button id="close-breather-modal" class="btn ghost">X</button>
      </div>
      <div class="breather-container" style="margin-top:16px">
        <div id="breathCircle" class="breath-circle">Inhale</div>
        <div id="breathDesc" class="muted">Follow the circle for <span id="breathCycles">6</span> cycles</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button id="breathStartBtn" class="btn primary">Start</button>
          <button id="breathStopBtn" class="btn ghost">Stop</button>
          <select id="breathSpeed" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)">
            <option value="8">Slow (4s/6s)</option>
            <option value="6" selected>Normal (3s/4s)</option>
            <option value="4">Fast (2s/3s)</option>
          </select>
        </div>
      </div>
    </div></div>

    <div class="modal-overlay" id="profile-modal"><div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700" id="profile-title">Your Profile</div>
        <button id="close-profile-modal" class="btn ghost">X</button>
      </div>
      <div style="margin-top:16px; display:flex; flex-direction:column; gap:12px;">
        <div>
            <label style="font-weight:700;color:var(--text);">Name</label>
            <input id="userName" placeholder="Enter name" />
        </div>
        <div style="display:flex; gap: 12px;">
            <div style="flex:1;">
                <label style="font-weight:700;color:var(--text);">Age</label>
                <input id="userAge" type="number" placeholder="Enter age" />
            </div>
            <div style="flex:1;">
                <label style="font-weight:700;color:var(--text);">Gender</label>
                <select id="userGender">
                    <option value="">Select...</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer_not_to_say">Prefer not to say</option>
                </select>
            </div>
        </div>
        <div class="muted" id="profileNote" style="margin-top:8px;">This info is used to help calibrate results.</div>
        <button id="save-profile-btn" class="btn primary" style="align-self:flex-end">Save & Close</button>
      </div>
    </div></div>

    <div class="modal-overlay" id="resources-modal"><div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Mental Health Resources</div>
        <button id="close-resources-modal" class="btn ghost">X</button>
      </div>
      <div style="margin-top:16px; max-height: 400px; overflow-y: auto;">
        <ul id="resources-list" style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;">
          <li style="background:var(--glass);padding:12px;border-radius:8px;">
            <div style="font-weight:700;color:var(--text)">Understanding Stress vs. Anxiety</div>
            <div class="muted" style="font-size:12px; margin-top:4px;">Learn the key differences and how your body responds to each.</div>
            <a href="#" onclick="alert('Placeholder: This would link to a real article.')" style="color:var(--accent);font-size:12px;font-weight:700;margin-top:6px;display:inline-block;">Read More</a>
          </li>
          <li style="background:var(--glass);padding:12px;border-radius:8px;">
            <div style="font-weight:700;color:var(--text)">5-Minute Mindfulness Exercises</div>
            <div class="muted" style="font-size:12px; margin-top:4px;">Simple exercises you can do at your desk to recalibrate.</div>
            <a href="#" onclick="alert('Placeholder: This would link to a real article.')" style="color:var(--accent);font-size:12px;font-weight:700;margin-top:6px;display:inline-block;">Read More</a>
          </li>
        </ul>
      </div>
    </div></div>
  </div>

  <div class="chat-floating" id="chatFab" title="Open Gemini Assistant">üí¨</div>
  <div class="chat-panel" id="chatPanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Gemini Assistant</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="closeChatBtn" class="btn ghost">X</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="muted">Start a conversation ‚Äî Gemini can analyze your last session when you ask.</div>
    </div>
    <div class="chat-input" style="margin-top:8px">
      <input id="chatInput" placeholder="Ask something (e.g., 'Is my stress high?')" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)" />
      <button id="sendChatBtn" class="btn primary">Send</button>
    </div>
  </div>

<script>
/* =========================
  CONFIG / CONSTANTS
  ========================= */
const SERVICE_UUID    = "4fafc201-1fb5-459e-8fcc-c5c9c331914b"; // Use lowercase
const CHAR_DATA_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8"; // Use lowercase
const CHAR_COMMAND_UUID = "a88a02e0-8422-42b0-a555-5203361a832a"; // Use lowercase
const TEST_DURATION_S = 40;

const GEMINI_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=";
const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE";
/* ========================= */

let bleDevice = null;
let gattServer = null;
let dataCharacteristic = null;
let commandCharacteristic = null;
const textDecoder = new TextDecoder('utf-8');
const textEncoder = new TextEncoder();

/* UI refs */
const bleStatus = document.getElementById('bleStatus');
const startBtn = document.getElementById('startBtn');
const bleStatusText = document.getElementById('bleStatusText');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('count');
const analysisSection = document.getElementById('analysis-section');
const finalLevelText = document.getElementById('finalLevel');
const overviewText = document.getElementById('overviewText');
const valHR = document.getElementById('valHR');
const valSp = document.getElementById('valSp');
const valGSR = document.getElementById('valGSR');
// const valTemp = document.getElementById('valTemp'); // Removed live temp display
const suggestList = document.getElementById('suggestList');
const historyList = document.getElementById('history-list');
const getLocationBtn = document.getElementById('getLocationBtn');
const roomTempInput = document.getElementById('roomTemp');
const sosBtn = document.getElementById('sosBtn');
const sosModal = document.getElementById('sos-modal');
const closeSosModal = document.getElementById('close-sos-modal');
const openBreathBtn = document.getElementById('openBreathBtn');
const breatherModal = document.getElementById('breather-modal');
const closeBreatherModal = document.getElementById('close-breather-modal');
const breathCircle = document.getElementById('breathCircle');
const breathDesc = document.getElementById('breathDesc');
const breathStartBtn = document.getElementById('breathStartBtn');
const breathStopBtn = document.getElementById('breathStopBtn');
const breathSpeed = document.getElementById('breathSpeed');
const breathCyclesLabel = document.getElementById('breathCycles');
const profileBtn = document.getElementById('profileBtn');
const profileModal = document.getElementById('profile-modal');
const profileTitle = document.getElementById('profile-title');
const closeProfileModal = document.getElementById('close-profile-modal');
const saveProfileBtn = document.getElementById('save-profile-btn');
const resourcesBtn = document.getElementById('resourcesBtn');
const resourcesModal = document.getElementById('resources-modal');
const closeResourcesModal = document.getElementById('close-resources-modal');
const nameInput = document.getElementById('userName');
const ageInput = document.getElementById('userAge');
const genderInput = document.getElementById('userGender');
const themeToggle = document.getElementById('themeToggle');
const themeLabel = document.getElementById('themeLabel');
const chartToggle = document.getElementById('chartToggle');
const resetHistoryBtn = document.getElementById('resetHistoryBtn');
const askGeminiBtn = document.getElementById('askGeminiBtn');
const hbToggle = document.getElementById('hbToggle');
const hbLabel = document.getElementById('hbLabel');
const chatFab = document.getElementById('chatFab');
const chatPanel = document.getElementById('chatPanel');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');

/* Charts */
const MAX_POINTS = TEST_DURATION_S * 2; // Approx 2 points per second
let hrChart, spChart, gsrChart; // Removed tempChart

/* Data collection arrays */
let liveHrReadings = [];
let liveGsrReadings = [];
let liveSpo2Readings = [];
let liveFingerTempReadings = [];
let testTimerInterval = null;

let spLast = null, spFlatCount = 0;
const SP_FLAT_LIMIT = 6;
const HISTORY_KEY = 'stressHistory';
const MAX_HISTORY = 10;

/* =========================
  THEME + PERSISTENCE
  ========================= */
function applyTheme(){
  const isLight = localStorage.getItem('theme') === 'light';
  if (isLight) document.body.classList.add('light'); else document.body.classList.remove('light');
  themeLabel.textContent = isLight ? 'Light' : 'Dark';
}
themeToggle.addEventListener('click', () => {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  applyTheme();
});
applyTheme();

/* =========================
  AUDIO SYSTEMS
  ========================= */

/* --- Ambient (Breathing) Audio --- */
let ambientAudioCtx = null, ambientMasterGain = null, droneOsc = null, ambientLfo = null;
let ambientAudioPlaying = false;

function initAmbientAudio(){
  if (ambientAudioCtx) return;
  try {
    ambientAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    ambientMasterGain = ambientAudioCtx.createGain();
    ambientMasterGain.gain.value = 0.0;
    ambientMasterGain.connect(ambientAudioCtx.destination);
    droneOsc = ambientAudioCtx.createOscillator();
    droneOsc.type = 'sine';
    droneOsc.frequency.value = 110;
    const droneGain = ambientAudioCtx.createGain();
    droneGain.gain.value = 0.0;
    ambientLfo = ambientAudioCtx.createOscillator();
    ambientLfo.type = 'sine';
    ambientLfo.frequency.value = 0.08;
    const lfoGain = ambientAudioCtx.createGain();
    lfoGain.gain.value = 0.25;
    ambientLfo.connect(lfoGain);
    lfoGain.connect(droneGain.gain);
    droneOsc.connect(droneGain);
    droneGain.connect(ambientMasterGain);
    const hp = ambientAudioCtx.createBiquadFilter();
    hp.type = 'highpass';
    hp.frequency.value = 20;
    const lp = ambientAudioCtx.createBiquadFilter();
    lp.type = 'lowpass';
    lp.frequency.value = 1200;
    droneGain.connect(hp);
    hp.connect(lp);
    lp.connect(ambientMasterGain);
    droneOsc.start();
    ambientLfo.start();
  } catch (e) {
    console.error("Failed to initialize ambient audio:", e);
    ambientAudioCtx = null;
  }
}

function setAmbientAudio(play) {
    if (!ambientAudioCtx) initAmbientAudio();
    if (!ambientAudioCtx) return;
    try {
        if (play && !ambientAudioPlaying) {
            ambientAudioCtx.resume().then(() => {
                ambientMasterGain.gain.exponentialRampToValueAtTime(0.22, ambientAudioCtx.currentTime + 1.2);
                ambientAudioPlaying = true;
            });
        } else if (!play && ambientAudioPlaying) {
            ambientMasterGain.gain.exponentialRampToValueAtTime(0.0001, ambientAudioCtx.currentTime + 1.0);
            ambientAudioPlaying = false;
        }
    } catch (e) {
        console.error("Error setting ambient audio state:", e);
    }
}

/* --- Heartbeat Audio --- */
let hbAudioCtx = null, hbMasterGain = null;
let hbAudioPlaying = false;
let hbInterval = null;

function initHeartbeatAudio() {
    if (hbAudioCtx) return;
    try {
        hbAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        hbMasterGain = hbAudioCtx.createGain();
        hbMasterGain.gain.value = 0.0;
        hbMasterGain.connect(hbAudioCtx.destination);
    } catch (e) {
        console.error("Failed to initialize heartbeat audio:", e);
        hbAudioCtx = null;
    }
}

function playHeartbeatSound() {
    if (!hbAudioCtx) return;
    try {
        const now = hbAudioCtx.currentTime;
        // Thump 1 (BA)
        const thumpOsc1 = hbAudioCtx.createOscillator();
        thumpOsc1.type = 'sine';
        thumpOsc1.frequency.setValueAtTime(70, now);
        thumpOsc1.frequency.exponentialRampToValueAtTime(50, now + 0.1);
        const thumpGain1 = hbAudioCtx.createGain();
        thumpGain1.gain.setValueAtTime(0, now);
        thumpGain1.gain.linearRampToValueAtTime(0.5, now + 0.02);
        thumpGain1.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        thumpOsc1.connect(thumpGain1).connect(hbMasterGain);
        thumpOsc1.start(now);
        thumpOsc1.stop(now + 0.15);
        // Thump 2 (DUM)
        const dumpTime = now + 0.12;
        const thumpOsc2 = hbAudioCtx.createOscillator();
        thumpOsc2.type = 'sine';
        thumpOsc2.frequency.setValueAtTime(60, dumpTime);
        thumpOsc2.frequency.exponentialRampToValueAtTime(40, dumpTime + 0.15);
        const thumpGain2 = hbAudioCtx.createGain();
        thumpGain2.gain.setValueAtTime(0, dumpTime);
        thumpGain2.gain.linearRampToValueAtTime(0.4, dumpTime + 0.02);
        thumpGain2.gain.exponentialRampToValueAtTime(0.001, dumpTime + 0.15);
        thumpOsc2.connect(thumpGain2).connect(hbMasterGain);
        thumpOsc2.start(dumpTime);
        thumpOsc2.stop(dumpTime + 0.2);
    } catch (e) {
        console.error("Error playing heartbeat sound:", e);
    }
}

hbToggle.addEventListener('click', () => {
    if (!hbAudioCtx) initHeartbeatAudio();
    if (!hbAudioCtx) return;

    hbAudioPlaying = !hbAudioPlaying;
    try {
        if (hbAudioPlaying) {
            hbAudioCtx.resume().then(() => {
                hbMasterGain.gain.exponentialRampToValueAtTime(0.3, hbAudioCtx.currentTime + 1.0);
                playHeartbeatSound();
                hbInterval = setInterval(playHeartbeatSound, 850);
                hbLabel.textContent = 'HB On';
            });
        } else {
            hbMasterGain.gain.exponentialRampToValueAtTime(0.0001, hbAudioCtx.currentTime + 1.0);
            if (hbInterval) clearInterval(hbInterval);
            hbInterval = null;
            hbLabel.textContent = 'HB Off';
        }
    } catch (e) {
        console.error("Error toggling heartbeat audio:", e);
    }
});

/* =========================
  CHARTS
  ========================= */
function createCharts(){
  const css = getComputedStyle(document.documentElement);
  const bad = css.getPropertyValue('--bad').trim() || '#f87171';
  const accent = css.getPropertyValue('--accent').trim() || '#22d3ee';
  const warn = css.getPropertyValue('--warn').trim() || '#facc15';
  // Removed 'good' as temp chart is removed

  function cfg(label, color){
    return {
      type:'line',
      data:{labels:[],datasets:[{
        label, data:[], borderColor:color,
        borderWidth:2.5, pointRadius:0, tension:0.4, fill:true,
        backgroundColor: (ctx)=>{
          const chart = ctx.chart;
          const gradient = chart.ctx.createLinearGradient(0,0,0,chart.height);
          gradient.addColorStop(0, color + '33');
          gradient.addColorStop(1, color + '05');
          return gradient;
        }
      }]},
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{legend:{display:false}},
        scales:{
          x:{display:false, grid:{display:false}},
          y:{ticks:{color:css.getPropertyValue('--text-body')}, grid:{color:css.getPropertyValue('--card-border')}}
        }
      }
    };
  }
  try {
    hrChart = new Chart(document.getElementById('hrChart'), cfg('Heart Rate', bad));
    spChart = new Chart(document.getElementById('spChart'), cfg('SpO2', accent));
    gsrChart = new Chart(document.getElementById('gsrChart'), cfg('GSR', warn));
    // tempChart removed

    spChart.options.scales.y.min = 80; spChart.options.scales.y.max = 100;
  } catch(e) {
    console.error("Error creating charts:", e);
  }
}
function updateChart(chart, value){
  if(!chart || !chart.data || value === null || typeof value === 'undefined') return;
  if (!chartToggle.checked) return;
  try {
    chart.data.labels.push('');
    chart.data.datasets[0].data.push(value);
    if (chart.data.labels.length > MAX_POINTS){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update('none');
  } catch(e) {
      console.warn("Error updating chart:", e);
  }
}
window.addEventListener('load', createCharts);

/* =========================
  WEATHER (geolocation helper)
  ========================= */
getLocationBtn.addEventListener('click', () => {
  if (navigator.geolocation){
    getLocationBtn.disabled = true; getLocationBtn.textContent = '...';
    navigator.geolocation.getCurrentPosition(
        fetchWeather,
        (e)=>{
            alert('Location error: ' + e.message);
            getLocationBtn.disabled=false; getLocationBtn.textContent='üìç';
        },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
    );
  } else alert('Geolocation not supported by this browser.');
});
async function fetchWeather(position){
  try{
    const {latitude,longitude} = position.coords;
    // --- FIX: Corrected API URL ---
    const api = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m`;
    const r = await fetch(api);
    if (!r.ok) throw new Error(`Weather API error: ${r.status}`);
    const data = await r.json();
    if (data.current && typeof data.current.temperature_2m === 'number'){
      roomTempInput.value = Math.round(data.current.temperature_2m);
      console.log("Weather fetched, temp set to:", roomTempInput.value); // Log success
    } else {
        console.warn("Weather data received but temperature not found:", data);
    }
  }catch(e){
      console.error("Fetch weather error:", e);
      alert("Could not fetch weather data. Please enter temperature manually.");
  } finally {
      getLocationBtn.disabled=false; getLocationBtn.textContent='üìç';
  }
}

/* =========================
  BLE CONNECT & DATA
  ========================= */

async function connectToDevice() {
  startBtn.disabled = true; startBtn.textContent = 'Connecting...';
  try {
    if (!navigator.bluetooth) {
        throw new Error("Web Bluetooth is not available on this browser/device.");
    }
    if (!bleDevice || !bleDevice.gatt.connected) {
      setBLEStatus('Requesting device...', 'warn');
      bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID.toLowerCase()] }],
          // optionalServices: [SERVICE_UUID.toLowerCase()] // Optional services not strictly needed here
       });
      if (!bleDevice) throw new Error("No device selected.");
      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      setBLEStatus('Connecting...', 'warn');
      gattServer = await bleDevice.gatt.connect();
      setBLEStatus('Getting service...', 'warn');
      const service = await gattServer.getPrimaryService(SERVICE_UUID.toLowerCase());
      setBLEStatus('Getting chars...', 'warn');
      dataCharacteristic = await service.getCharacteristic(CHAR_DATA_UUID.toLowerCase());
      commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID.toLowerCase());
      await dataCharacteristic.startNotifications();
      dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotification);
      setBLEStatus('Connected', 'good');
    }
    profileTitle.textContent = 'Profile for New Test';
    saveProfileBtn.textContent = 'Save & Start Test';
    document.body.dataset.startTestOnSave = 'true';
    profileModal.classList.add('active');
    console.log("connectToDevice successful, opening profile modal for test start.");

  } catch (err) {
      console.error('BLE Error:', err);
      if (err.message.includes("No device selected") || err.name === 'NotFoundError') {
          setBLEStatus('Pairing Cancelled', 'warn');
      } else if (err.message.includes("available")) {
           setBLEStatus('BLE Not Supported', 'bad');
           alert("Web Bluetooth is not supported or enabled on this browser. Please use Chrome, Edge, or Opera.");
      } else {
          setBLEStatus('Connection Error', 'bad');
      }
      if (bleDevice && bleDevice.gatt.connected) {
          try { await bleDevice.gatt.disconnect(); } catch (e) { /* Ignore disconnect error */ }
      }
      // Reset BLE variables
      dataCharacteristic = null;
      commandCharacteristic = null;
      gattServer = null;
      bleDevice = null;
   }
  finally {
      startBtn.disabled = false;
      startBtn.textContent = 'Connect & Start Test';
   }
}

function startJsTimer() {
  let timeLeft = TEST_DURATION_S;
  statusText.textContent = 'MEASURING';
  countText.textContent = timeLeft;
  if (testTimerInterval) clearInterval(testTimerInterval);
  testTimerInterval = setInterval(() => {
    timeLeft--;
    countText.textContent = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(testTimerInterval);
      testTimerInterval = null;
      stopTest();
    }
  }, 1000);
}

async function stopTest() {
  statusText.textContent = 'CALCULATING...'; countText.textContent = '0';
  if (testTimerInterval) {
      clearInterval(testTimerInterval);
      testTimerInterval = null;
  }
  try {
    if (commandCharacteristic && bleDevice && bleDevice.gatt.connected) { // Check connection before sending stop
        const command = JSON.stringify({ command: "stop" });
        await commandCharacteristic.writeValue(textEncoder.encode(command));
        console.log("STOP command sent.");
    } else {
        console.warn("Stop command not sent: Characteristic unavailable or device disconnected.");
    }
  } catch (err) { console.warn("Failed to send STOP command", err); }

  const hr_avg = calculateAverage(liveHrReadings.filter(hr => hr > 35 && hr < 220));
  const gsr_avg = calculateAverage(liveGsrReadings.filter(gsr => gsr > 0));
  const spo2_avg = calculateAverage(liveSpo2Readings.filter(sp => sp > 80 && sp <= 100));
  const finger_temp_avg = calculateAverage(liveFingerTempReadings.filter(t => t > 5 && t < 50));

  let finger_temp_trend = 0;
  const validTemps = liveFingerTempReadings.filter(t => t > 5 && t < 50);
  if (validTemps.length >= 10) {
      const quarter = Math.floor(validTemps.length / 4);
      const firstQuarterAvg = calculateAverage(validTemps.slice(0, quarter));
      const lastQuarterAvg = calculateAverage(validTemps.slice(-quarter));
      if (firstQuarterAvg > 0 && lastQuarterAvg > 0) {
         finger_temp_trend = lastQuarterAvg - firstQuarterAvg;
      }
  }

  console.log("Final Averages:", { hr_avg, gsr_avg, spo2_avg, finger_temp_avg });
  console.log("Temp Trend:", finger_temp_trend);

  const age = parseInt(ageInput.value || '30', 10);
  const gender = genderInput.value || 'male';
  const temp = parseInt(roomTempInput.value || '30', 10);

  const { level, overview } = calculateStressLevel(hr_avg, gsr_avg, age, gender, temp, finger_temp_trend);

  analysisSection.style.display = 'block';
  finalLevelText.textContent = level;
  finalLevelText.className = `level-${level}`;
  overviewText.textContent = overview;
  overviewText.style.display = 'block';

  saveSession({
    level: level,
    hr: hr_avg > 0 ? Math.round(hr_avg) : '--',
    spo2: spo2_avg > 0 ? Math.round(spo2_avg) : '--',
    gsr: gsr_avg >= 0 ? Math.round(gsr_avg) : '--',
    temp_finger: finger_temp_avg > 0 ? finger_temp_avg.toFixed(1) : '--',
    date: new Date().toLocaleString('en-IN'),
    name: nameInput.value || '‚Äî',
    age: ageInput.value || '‚Äî'
  });
  renderStaticSuggestions(level);
}

function calculateAverage(arr) {
  if (!arr || arr.length === 0) return 0;
  const sum = arr.reduce((a, b) => a + b, 0);
  return sum / arr.length;
}

startBtn.addEventListener('click', connectToDevice);

function onDisconnected(){
  setBLEStatus('Disconnected','bad');
  statusText.textContent = 'IDLE';
  countText.textContent = '0';
  if (testTimerInterval) {
      clearInterval(testTimerInterval);
      testTimerInterval = null;
  }
  analysisSection.style.display = 'none';
  // Fully reset BLE state
  dataCharacteristic = null;
  commandCharacteristic = null;
  gattServer = null;
  // Don't nullify bleDevice here, keep the reference for potential reconnects if needed
  // bleDevice = null;
  startBtn.textContent = 'Connect & Start Test';
  console.log("BLE Disconnected");
}

let statusTimeout = null;
function setBLEStatus(message, level){
  if (!bleStatusText) return;
  bleStatusText.textContent = message;
  let colorVar = '--bad';
  if (level === 'good') colorVar = '--good';
  else if (level === 'warn') colorVar = '--warn';
  bleStatusText.style.color = getComputedStyle(document.documentElement).getPropertyValue(colorVar);

  if(message === 'Receiving...'){
    if (!bleStatus.classList.contains('pulse-receiving')) {
        bleStatus.classList.add('pulse-receiving');
        if(statusTimeout) clearTimeout(statusTimeout);
        statusTimeout = setTimeout(() => {
            if(bleDevice && bleDevice.gatt.connected) {
                 setBLEStatus('Connected', 'good');
            }
            bleStatus.classList.remove('pulse-receiving');
        }, 500);
    }
  } else {
    if(statusTimeout) clearTimeout(statusTimeout);
    bleStatus.classList.remove('pulse-receiving');
  }
}

/* =========================
  Data handling
  ========================= */
function handleDataNotification(event){
  // Minimal check for connection status; mostly rely on onDisconnected
  if (!bleDevice || !bleDevice.gatt.connected) return;

  if (bleStatusText.textContent === 'Connected') { setBLEStatus('Receiving...', 'good'); }
  const jsonString = textDecoder.decode(event.target.value);
  try {
    const data = JSON.parse(jsonString);

    const hrRaw = Number(data.hr) || 0;
    const spo2Raw = Number(data.spo2) || -1;
    const gsrRaw = Number(data.gsr) || 0;
    const tempFingerRaw = Number(data.temp_finger) || 0;

    // --- Add console log for debugging HR ---
    // console.log('Received HR:', hrRaw);

    valHR.textContent = hrRaw > 0 ? hrRaw : '--';
    valSp.textContent = (spo2Raw > 0) ? spo2Raw : '--';
    valGSR.textContent = gsrRaw >= 0 ? gsrRaw : '--';
    // valTemp removed

    // Add to charts if visible
    if (chartToggle.checked) {
        if (hrRaw > 0 && hrRaw < 220) updateChart(hrChart, hrRaw);
        if (spo2Raw > 80 && spo2Raw <= 100) updateChart(spChart, spo2Raw);
        if (gsrRaw >= 0) updateChart(gsrChart, gsrRaw);
        // tempChart removed
    }

    // Only store data if the test timer is running
    if (testTimerInterval) {
        liveHrReadings.push(hrRaw);
        liveGsrReadings.push(gsrRaw);
        liveSpo2Readings.push(spo2Raw);
        liveFingerTempReadings.push(tempFingerRaw);
    }

    if (hrRaw > 0 && !valHR.classList.contains('pulsing')) {
        valHR.classList.add('pulsing');
        valHR.addEventListener('animationend', () => {
            valHR.classList.remove('pulsing');
        }, { once: true });
     }

    detectFlatSpO2(spo2Raw);

  } catch (err) {
      console.error('Data Parse Error! Check ESP32 JSON format.', err);
      console.error('Received problematic string:', jsonString);
   }
}

/* =========================
  STRESS CALCULATION LOGIC
  ========================= */
function calculateStressLevel(hr_avg, gsr_avg, age, gender, temp, finger_temp_trend) {
    console.log(`Calculating stress with: HR:${hr_avg.toFixed(1)}, GSR:${gsr_avg.toFixed(1)}, Age:${age}, Gender:${gender}, RoomTemp:${temp}, TempTrend:${finger_temp_trend.toFixed(2)}`);
    let overview = "";

    // 1. Get HR Baseline
    let baselineHR = 70;
    if (age >= 18 && age <= 25) baselineHR = 70; else if (age >= 26 && age <= 35) baselineHR = 71; else if (age >= 36 && age <= 45) baselineHR = 72; else if (age >= 46 && age <= 55) baselineHR = 73; else if (age >= 56 && age <= 65) baselineHR = 72; else if (age > 65) baselineHR = 70;
    if (gender === 'female') baselineHR += 3;

    // 2. Calculate HR Score
    const hr_delta = hr_avg - baselineHR;
    let hr_score = 0;
    if (hr_avg <= 0) hr_score = 0;
    else if (hr_delta > 20) hr_score = 100; else if (hr_delta > 12) hr_score = 70; else if (hr_delta > 4) hr_score = 40; else hr_score = 10;
    if (hr_avg <= 0) overview += `Could not reliably determine average heart rate. `;
    else if (hr_delta > 15) overview += `Your heart rate was notably elevated for your profile. `; else if (hr_delta > 5) overview += `Your heart rate was slightly elevated. `; else overview += `Your heart rate was in a calm range. `;

    // 3. Calculate GSR Score
    let gsr_mod = 0;
    if (temp > 28) gsr_mod = 50; if (temp < 20) gsr_mod = -50;
    const gsr_modified = gsr_avg + gsr_mod;
    let gsr_score = 0;
    if (gsr_avg <= 0) gsr_score = 0;
    else if (gsr_modified < 350) gsr_score = 100; else if (gsr_modified < 500) gsr_score = 70; else if (gsr_modified < 650) gsr_score = 40; else gsr_score = 10;
    if (gsr_avg <= 0) overview += `Could not reliably determine average skin conductance. `;
    else if (gsr_score >= 70) overview += `Skin conductance was high (indicating arousal). `; else if (gsr_score >= 40) overview += `Skin conductance showed some arousal. `; else overview += `Skin activity appears low. `;

    // 4. Temperature Trend Modifier & Overview Update
    let temp_modifier = 0;
    const avgFingerTemp = calculateAverage(liveFingerTempReadings.filter(t => t > 5 && t < 50)); // Recalculate avg for overview
    if ((hr_score >= 70 || gsr_score >= 70) && finger_temp_trend < -0.3) {
        temp_modifier = 15;
        overview += `Finger temperature dropped significantly (avg ${avgFingerTemp.toFixed(1)}¬∞C), suggesting stress-related vasoconstriction.`;
    }
    else if ((hr_score >= 40 || gsr_score >= 40) && finger_temp_trend < -0.15) {
        temp_modifier = 5;
        overview += `Finger temperature decreased slightly (avg ${avgFingerTemp.toFixed(1)}¬∞C).`;
    }
    else if (finger_temp_trend > 0.1) {
         overview += `Finger temperature was stable or increased (avg ${avgFingerTemp.toFixed(1)}¬∞C).`;
    } else {
         overview += `Finger temperature remained relatively stable (avg ${avgFingerTemp.toFixed(1)}¬∞C).`;
    }

    // 5. Final Weighted Score
    const final_score = (hr_score * 0.55) + (gsr_score * 0.35) + temp_modifier;

    // 6. Determine Level
    let level = "LOW";
    if (hr_score === 0 && gsr_score === 0) {
      level = "ERROR";
      overview = "Could not calculate score due to unreliable sensor readings. Please ensure good sensor contact and try again."
    }
    else if (final_score > 70) level = "HIGH";
    else if (final_score > 40) level = "MODERATE";

    console.log(`Scores: HR=${hr_score}, GSR=${gsr_score}, TempMod=${temp_modifier}, Final=${final_score.toFixed(1)}, Level=${level}`);
    return { level, overview };
}
/* ========================= */

function detectFlatSpO2(spo2Raw){ /* Flat SpO2 detection code */ }
const staticSuggestions = { /* Suggestions object */ };
function renderStaticSuggestions(level){ /* Render suggestions code */ }
function saveSession(sessionData){ /* Save session code */ }
function renderHistory(){ /* Render history code */ }
resetHistoryBtn.addEventListener('click', ()=>{ /* Reset history code */ });
renderHistory();

/* =========================
  Profile Management
  ========================= */
function saveProfile() {
    try {
        localStorage.setItem('nw_profile', JSON.stringify({
            name: nameInput.value||'',
            age: ageInput.value||'',
            gender: genderInput.value||''
        }));
        console.log("Profile saved:", localStorage.getItem('nw_profile'));
    } catch (e) {
        console.error("Error saving profile to localStorage:", e);
    }
}
[nameInput, ageInput, genderInput].forEach(el => el.addEventListener('change', saveProfile));

(() => {
  try {
    const p = JSON.parse(localStorage.getItem('nw_profile') || '{}');
    if (p.name) nameInput.value = p.name;
    if (p.age) ageInput.value = p.age;
    if (p.gender) genderInput.value = p.gender;
  } catch (e) {
    console.error("Error loading profile from localStorage:", e);
    localStorage.removeItem('nw_profile'); // Clear potentially corrupted data
  }
})();

/* =========================
  Breathing exercise
  ========================= */
let breathInterval = null, breathRunning = false;
function startBreathing(cycles = 6, inhale = 3, hold = 0, exhale = 4){ /* Breathing start logic */ }
function stopBreathing(){ /* Breathing stop logic */ }
openBreathBtn.addEventListener('click', ()=> { /* Open breather modal */ });
closeBreatherModal.addEventListener('click', ()=> { /* Close breather modal */ });
breathStartBtn.addEventListener('click', ()=> { /* Start breather */ });
breathStopBtn.addEventListener('click', stopBreathing);

/* =========================
  Gemini integration (AI)
  ========================= */
async function fetchWithBackoff(url, options, retries = 3, delay = 1000){ /* Fetch retry logic */ }
async function askGeminiAnalysis(userQuestion='Please analyze my last session and give tips.'){ /* Gemini API call */ }

/* =========================
  Chat helpers
  ========================= */
function appendChatMessage(who, text){ /* Append message to chat */ }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
chatFab.addEventListener('click', ()=> chatPanel.classList.toggle('active'));
closeChatBtn.addEventListener('click', ()=> chatPanel.classList.remove('active'));
sendChatBtn.addEventListener('click', ()=> {
    const q = chatInput.value.trim();
    if (!q) return;
    askGeminiAnalysis(q);
    chatInput.value = '';
 });
askGeminiBtn.addEventListener('click', ()=> {
    if (analysisSection.style.display !== 'block') {
        alert("Please complete a test session first before asking Gemini.");
        return;
    }
    askGeminiAnalysis('Please analyze my last session and give tips.');
 });

/* =========================
  Modal UI listeners (FIXED)
  ========================= */
sosBtn.addEventListener('click', ()=> sosModal.classList.add('active'));
closeSosModal.addEventListener('click', ()=> sosModal.classList.remove('active'));

// --- FIX: Resources listener ---
resourcesBtn.addEventListener('click', () => resourcesModal.classList.add('active'));
closeResourcesModal.addEventListener('click', () => resourcesModal.classList.remove('active'));

profileBtn.addEventListener('click', () => {
    profileTitle.textContent = 'Your Profile';
    saveProfileBtn.textContent = 'Save & Close';
    document.body.dataset.startTestOnSave = 'false';
    profileModal.classList.add('active');
});

closeProfileModal.addEventListener('click', () => {
    profileModal.classList.remove('active');
    document.body.dataset.startTestOnSave = 'false'; // Explicitly clear flag
});

// --- FIX: Simplified save/start logic ---
saveProfileBtn.addEventListener('click', async () => {
    saveProfile(); // Always save the latest data
    const shouldStartTest = document.body.dataset.startTestOnSave === 'true';
    profileModal.classList.remove('active'); // Always close modal
    document.body.dataset.startTestOnSave = 'false'; // Always reset flag after handling

    if (shouldStartTest) {
      console.log("Attempting to send START command...");
      try {
        if (!commandCharacteristic || !bleDevice || !bleDevice.gatt.connected) {
             console.error("BLE Command Characteristic not available or device not connected!");
             setBLEStatus('Error: Not Connected', 'bad');
             alert("Device is not connected. Please connect first.");
             return;
        }

        const temp = parseInt(roomTempInput.value || '30', 10);
        let irThr = 20000;
        if (temp < 20) irThr = 15000; else if (temp >= 28) irThr = 25000;

        // Clear old data
        liveHrReadings = []; liveGsrReadings = []; liveSpo2Readings = []; liveFingerTempReadings = [];
        [hrChart, spChart, gsrChart].forEach(c => { if (c && c.data) { c.data.labels = []; c.data.datasets[0].data = []; c.update('none'); } });
        analysisSection.style.display = 'none'; overviewText.style.display = 'none';
        finalLevelText.textContent = '--'; finalLevelText.className = '';

        const command = JSON.stringify({ command: "start", irThreshold: irThr });
        console.log("Sending command:", command);
        await commandCharacteristic.writeValue(textEncoder.encode(command));
        console.log("START command sent successfully.");

        startJsTimer(); // Start JS timer only after command sent
        console.log("JavaScript timer started.");

      } catch (err) {
        console.error("Failed to send START command or start timer", err);
        setBLEStatus('Command Failed', 'bad');
        alert(`Failed to start test: ${err.message}`);
      }
    }
});


/* =========================
  Utility helpers
  ========================= */
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* =========================
  Final note / warning about API keys
  ========================= */
if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
    console.warn("************************************************************");
    console.warn("GEMINI_API_KEY is not set!");
    console.warn("Paste your key at the top of the <script> block in this HTML file.");
    console.warn("************************************************************");
} else {
    console.log("NeuroWell dashboard loaded. Gemini key is set.");
}

</script>
</body>
</html>
