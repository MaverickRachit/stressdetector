<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Stress Monitor 3.0 (AI-Powered)</title>
  
  <!-- 1. Import Chart.js for animated graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- 2. Use the Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /*
     * ========================================
     * NEW STYLING (Glassmorphism, Gradients, Animations)
     * ========================================
    */
    :root {
      --bg: #020617; /* Dark Navy Blue */
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-border: rgba(255, 255, 255, 0.1);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #22d3ee; /* Cyan */
      
      --good: #4ade80;
      --warn: #facc15;
      --bad: #f87171;
    }
    
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      /* Subtle gradient background */
      background-image: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.15), transparent 50%),
                        radial-gradient(circle at 80% 90%, rgba(139, 92, 246, 0.1), transparent 50%);
      background-attachment: fixed;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 24px;
    }
    
    /* Main Dashboard Grid */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    @media (min-width: 1024px) {
      .dashboard {
        grid-template-columns: 2fr 1fr;
      }
    }
    .main-col, .side-col {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Glassmorphism Card Style */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      box-shadow: 0 8px 32px rgba(2, 6, 23, 0.3);
      transition: all 0.3s ease;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }
    
    /* Config & Connect */
    .config-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    @media (min-width: 640px) {
      .config-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .config-grid-span {
      grid-column: 1 / -1;
    }
    .temp-group {
      display: flex;
      gap: 12px;
    }
    .temp-group input { flex-grow: 1; }

    label {
      display: block;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    input[type=number], button {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.2);
      color: var(--text);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
    }
    button {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    button.primary {
      background: var(--accent);
      color: var(--bg);
      font-weight: 700;
      box-shadow: 0 4px 20px rgba(34, 211, 238, 0.2);
      border: none;
    }
    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(34, 211, 238, 0.3);
    }
    button.secondary {
      background: #334155; /* Grayish blue */
      font-weight: 500;
      border: none;
    }
    button.secondary:hover {
      background: #475569;
    }
    button:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Vitals Card */
    .vitals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .vital {
      text-align: center;
      background: rgba(0, 0, 0, 0.15);
      padding: 20px;
      border-radius: 12px;
    }
    .vital-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .vital-value {
      font-size: 40px;
      font-weight: 800;
      color: var(--text);
      line-height: 1;
    }
    .vital-value span { font-size: 18px; font-weight: 500; color: var(--text-muted); margin-left: 4px; }
    
    /* Animated Heart Icon */
    .heart-icon {
      width: 24px;
      height: 24px;
      fill: var(--bad);
      animation: beat 1s infinite ease-in-out;
      /* Animation duration will be set by JS */
    }
    @keyframes beat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    /* Status Card */
    .status-box {
      background: rgba(0, 0, 0, 0.15);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .status-box #statusText {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 1px;
    }
    .status-box #count {
      font-size: 64px;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
    }
    .status-box #count span {
      font-size: 20px;
      font-weight: 500;
      color: var(--text-muted);
    }

    /* Result Card */
    #finalLevel {
      font-size: 32px;
      font-weight: 800;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      color: #000;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    /* Gradient backgrounds for stress levels */
    .level-LOW { background: linear-gradient(90deg, var(--good), #86efac); }
    .level-MODERATE { background: linear-gradient(90deg, var(--warn), #fde047); }
    .level-HIGH { background: linear-gradient(90deg, var(--bad), #fca5a5); }

    #suggestList li {
      background: rgba(0, 0, 0, 0.15);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 15px;
      line-height: 1.6;
    }
    #suggestList li strong {
      color: var(--accent);
    }
    
    /* Breathing Pacemaker */
    .breather {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .breather-circle {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, var(--accent), #818cf8);
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: var(--bg);
      font-size: 20px;
      font-weight: 600;
      /* 5s inhale, 5s exhale = 10s cycle */
      animation: breathe 10s infinite ease-in-out;
    }
    .breather-text {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-muted);
    }
    @keyframes breathe {
      0%   { transform: scale(0.6); opacity: 0.7; }
      50%  { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.6); opacity: 0.7; }
    }
    
    /* History List */
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .history-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--card-border);
      font-size: 14px;
    }
    .history-item:last-child { border: none; }
    .history-item span { font-weight: 600; color: var(--text); }
    .history-level-LOW { color: var(--good); }
    .history-level-MODERATE { color: var(--warn); }
    .history-level-HIGH { color: var(--bad); }

  </style>
</head>
<body>
  
  <div class="wrap">
    
    <!-- Header -->
    <header class="card">
      <h1 style="display: flex; align-items: center; gap: 12px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit"><path d="M12 5a3 3 0 1 0-5.997.001A3 3 0 0 0 12 5zm0 14a3 3 0 1 0-5.997.001A3 3 0 0 0 12 19zm0-7a3 3 0 1 0 5.997-.001A3 3 0 0 0 12 12zm0 0V5m0 7v7m0-7h7.5m-7.5 7H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2.5"/><path d="M5 12h2.5m14 0h-7.5"/><path d="M9 19v-2.34a2.26 2.26 0 0 1 .9-1.8L12 13l-2.1-1.86a2.26 2.26 0 0 1-.9-1.8V7"/></svg>
        Stress Monitor 3.0 (AI)
      </h1>
      <div id="bleStatus" style="color: var(--text-muted); font-weight: 500;">
        Status: <span style="color: var(--bad); font-weight: 600;">Disconnected</span>
      </div>
    </header>

    <!-- Main Dashboard -->
    <div class="dashboard">

      <!-- Left Column -->
      <div class="main-col">
        
        <!-- Config Card -->
        <div class="card">
          <div class="config-grid">
            
            <!-- NEW: Temp + Location Button -->
            <div>
              <label for="roomTemp">Room Temperature (¬∞C)</label>
              <div class="temp-group">
                <input id="roomTemp" type="number" min="10" max="45" value="30">
                <button id="getLocationBtn" class="secondary" title="Use my location">üìç</button>
              </div>
            </div>

            <div>
              <label for="irThreshold">IR Threshold (Sensor Tuning)</label>
              <input id="irThreshold" type="number" min="1000" max="200000" value="20000">
            </div>

            <div class="config-grid-span">
              <button id="startBtn" class="primary">Connect & Start Test</button>
            </div>
          </div>
        </div>
        
        <!-- Live Vitals Card -->
        <div class="card">
          <div class="vitals-grid">
            <!-- Heart Rate -->
            <div class="vital">
              <div class="vital-label">
                <svg class="heart-icon" id="heartIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="var(--bad)" stroke="var(--bad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                Heart Rate
              </div>
              <div id="valHR" class="vital-value">--<span>bpm</span></div>
            </div>
            <!-- SpO2 -->
            <div class="vital">
              <div class="vital-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h3l3-9 3 18 3-9h3"/><path d="M19 10a2 2 0 1 1 0 4 2 2 0 0 1 0-4Z"/></svg>
                SpO‚ÇÇ
              </div>
              <div id="valSp" class="vital-value">--<span>%</span></div>
            </div>
            <!-- GSR -->
            <div class="vital">
              <div class="vital-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                GSR (Avg)
              </div>
              <div id="valGSR" class="vital-value">--</div>
            </div>
          </div>
        </div>

        <!-- Charts Card -->
        <div class="card">
          <div class="card-title">Live Sensor Data</div>
          <div style="height: 250px;">
            <canvas id="hrChart"></canvas>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div style="height: 200px;"><canvas id="spChart"></canvas></div>
            <div style="height: 200px;"><canvas id="gsrChart"></canvas></div>
          </div>
        </div>
      </div>
      
      <!-- Right Column -->
      <div class="side-col">
        
        <!-- Status Card -->
        <div class="card">
          <div class="card-title">Status</div>
          <div class="status-box">
            <div id="statusText">IDLE</div>
            <div id="count">0<span>s</span></div>
          </div>
        </div>
        
        <!-- Results Card -->
        <div class="card" id="results-card">
          <div class="card-title">Analysis & AI Suggestions</div>
          <div id="finalLevel" class="">--</div>
          <!-- AI Suggestions will be loaded here -->
          <ol id="suggestList" style="padding-left: 20px;"></ol>
        </div>

        <!-- Breathing Tool Card (Initially hidden) -->
        <div class="card" id="breather-card" style="display: none;">
          <div class="card-title">Calming Exercise</div>
          <div class="breather">
            <div class="breather-circle" id="breather-circle-text">Inhale...</div>
            <div class="breather-text">Follow the circle for 1 minute.</div>
          </div>
        </div>

      </div>

    </div>

    <!-- Session History Card -->
    <div class="card" style="margin-top: 24px;">
      <div class="card-title">Session History (Last 10)</div>
      <ul class="history-list" id="history-list">
        <!-- JS will populate this -->
      </ul>
    </div>

  </div>

<script>
/*
 * ========================================
 * UPGRADED JAVASCRIPT (Chart.js, BLE, History, Weather, Gemini AI)
 * ========================================
*/

// --- BLE UUIDs (Must match ESP32) ---
const SERVICE_UUID      = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_DATA_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_COMMAND_UUID = "a88a02e0-8422-42b0-a555-5203361a832a";

// --- Gemini API URL (Uses v1beta) ---
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
const API_KEY = ""; // No key needed when run in this environment

// --- Global BLE Objects ---
let bleDevice = null;
let gattServer = null;
let dataCharacteristic = null;
let commandCharacteristic = null;
const textDecoder = new TextDecoder('utf-8');
const textEncoder = new TextEncoder();

// --- UI Elements ---
const startBtn = document.getElementById('startBtn');
const bleStatusText = document.getElementById('bleStatus');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('count');
const finalLevelText = document.getElementById('finalLevel');
const valHR = document.getElementById('valHR');
const valSp = document.getElementById('valSp');
const valGSR = document.getElementById('valGSR');
const suggestList = document.getElementById('suggestList');
const heartIcon = document.getElementById('heartIcon');
const breatherCard = document.getElementById('breather-card');
const breatherCircleText = document.getElementById('breather-circle-text');
const historyList = document.getElementById('history-list');
const getLocationBtn = document.getElementById('getLocationBtn');
const roomTempInput = document.getElementById('roomTemp');

// --- Chart.js Setup ---
const MAX_CHART_POINTS = 30;
let hrChart, spChart, gsrChart;

function createCharts() {
  const chartConfig = (label, color) => ({
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: label,
        data: [],
        borderColor: color,
        borderWidth: 4, // Thicker line
        pointRadius: 0,
        tension: 0.4, // Wavy "water" line
        fill: true,
        backgroundColor: (ctx) => {
          const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, ctx.chart.height);
          gradient.addColorStop(0, `${color}90`); // Stronger gradient start
          gradient.addColorStop(1, `${color}10`); // Faded gradient end
          return gradient;
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500, easing: 'easeOutQuart' },
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: { 
          display: true, 
          ticks: { color: 'var(--text-muted)' },
          grid: { color: 'var(--card-border)' }
        }
      }
    }
  });

  hrChart = new Chart(document.getElementById('hrChart'), chartConfig('Heart Rate', '#f87171'));
  spChart = new Chart(document.getElementById('spChart'), chartConfig('SpO2', '#22d3ee'));
  gsrChart = new Chart(document.getElementById('gsrChart'), chartConfig('GSR', '#facc15'));
  
  // Customize SpO2 chart range
  spChart.options.scales.y.min = 85;
  spChart.options.scales.y.max = 100;
}

function updateChart(chart, value) {
  if (value === 0 || value === -1) return; // Don't plot zeroes
  chart.data.labels.push('');
  chart.data.datasets[0].data.push(value);
  
  if (chart.data.labels.length > MAX_CHART_POINTS) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update('none'); // 'none' for smooth live updates
}

// --- Weather API Logic ---
getLocationBtn.addEventListener('click', () => {
  if (navigator.geolocation) {
    getLocationBtn.disabled = true;
    getLocationBtn.textContent = '...';
    navigator.geolocation.getCurrentPosition(fetchWeather, handleLocationError);
  } else {
    alert("Geolocation is not supported by this browser.");
  }
});

async function fetchWeather(position) {
  const { latitude, longitude } = position.coords;
  const weatherApiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
  
  try {
    const response = await fetch(weatherApiUrl);
    const data = await response.json();
    if (data.current_weather && data.current_weather.temperature) {
      roomTempInput.value = Math.round(data.current_weather.temperature);
    }
  } catch (error) {
    console.error("Error fetching weather:", error);
  } finally {
    getLocationBtn.disabled = false;
    getLocationBtn.textContent = 'üìç';
  }
}

function handleLocationError(error) {
  console.error("Error getting location:", error.message);
  alert(`Error: ${error.message}. Please enter temperature manually.`);
  getLocationBtn.disabled = false;
  getLocationBtn.textContent = 'üìç';
}


// --- Web Bluetooth Logic ---
startBtn.addEventListener('click', async () => {
  startBtn.disabled = true;
  
  try {
    if (!bleDevice || !bleDevice.gatt.connected) {
      setBLEStatus('Requesting device...', 'var(--warn)');
      statusText.textContent = 'CONNECTING';

      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }],
        optionalServices: [SERVICE_UUID]
      });
      
      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      setBLEStatus('Connecting to device...', 'var(--warn)');
      gattServer = await bleDevice.gatt.connect();

      setBLEStatus('Getting Service...', 'var(--warn)');
      const service = await gattServer.getPrimaryService(SERVICE_UUID);

      setBLEStatus('Getting Characteristics...', 'var(--warn)');
      dataCharacteristic = await service.getCharacteristic(CHAR_DATA_UUID);
      commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID);
      
      await dataCharacteristic.startNotifications();
      dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotification);
      
      setBLEStatus('Connected', 'var(--good)');
      startBtn.textContent = 'Start 40s Test';
    }

    // 3. Send the "Start" command
    statusText.textContent = 'STARTING';
    const temp = parseInt(roomTempInput.value || '30');
    const irThr = parseInt(document.getElementById('irThreshold').value || '20000');
    
    // Clear UI for new test
    finalLevelText.textContent = '--';
    finalLevelText.className = '';
    suggestList.innerHTML = '';
    breatherCard.style.display = 'none';
    
    // Reset charts
    [hrChart, spChart, gsrChart].forEach(chart => {
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update();
    });

    const command = JSON.stringify({ roomTemp: temp, irThreshold: irThr });
    await commandCharacteristic.writeValue(textEncoder.encode(command));
    
    statusText.textContent = 'MEASURING';

  } catch (error) {
    console.error('BLE Error:', error);
    setBLEStatus(`Error: ${error.name}`, 'var(--bad)');
    if (bleDevice) bleDevice.gatt.disconnect();
  } finally {
    startBtn.disabled = false;
  }
});

// Main data handler
function handleDataNotification(event) {
  const jsonString = textDecoder.decode(event.target.value);
  
  try {
    const data = JSON.parse(jsonString);

    const hr = data.hr || 0;
    const spo2 = data.spo2 || -1;
    const gsr = data.gsr || 0;

    // Update Live Vitals
    valHR.textContent = hr > 0 ? hr.toFixed(0) : '--';
    valSp.textContent = spo2 > 0 ? spo2 : '--';
    valGSR.textContent = gsr > 0 ? gsr.toFixed(0) : '--';
    
    // Update live heart animation
    if (hr > 40) {
      heartIcon.style.animationDuration = `${(60 / hr).toFixed(2)}s`;
    }

    // Update Live Charts
    updateChart(hrChart, hr);
    updateChart(spChart, spo2);
    updateChart(gsrChart, gsr);

    statusText.textContent = data.status || 'UNKNOWN';

    if (data.status === "MEASURING") {
      countText.textContent = data.timeLeft ? Math.ceil(data.timeLeft / 1000) : '0';
    }

    // Handle the final "DONE" packet
    if (data.status === "DONE") {
      countText.textContent = 0;
      const level = data.finalLevel || 'ERROR';
      finalLevelText.textContent = level;
      finalLevelText.className = `level-${level}`;
      
      // *** NEW: Call Gemini AI for suggestions ***
      getAISuggestions(level, data.hr, data.spo2, data.gsr, parseInt(roomTempInput.value || '30'));
      
      // Show breather tool if stressed
      if (level === 'HIGH' || level === 'MODERATE') {
        breatherCard.style.display = 'block';
        startBreatherAnimation();
      }
      
      // Save to history
      saveSession({
        level: level,
        hr: data.hr.toFixed(0),
        spo2: data.spo2,
        gsr: data.gsr.toFixed(0),
        date: new Date().toLocaleString('en-IN')
      });
    }

  } catch (error) {
    console.error('Error parsing JSON:', jsonString, error);
  }
}

// --- NEW: Gemini AI Suggestions ---
async function getAISuggestions(level, hr, spo2, gsr, temp) {
  suggestList.innerHTML = `<li>üß† Analyzing results and generating personalized AI suggestions...</li>`;

  const systemPrompt = `You are an empathetic and professional wellness assistant. A user has just completed a stress test. Their results are provided.
You MUST:
1.  Briefly (1-2 sentences) analyze their stress level in a reassuring tone.
2.  Provide 3-4 concise, actionable, and encouraging suggestions with emojis.
3.  Use Google Search to find 2-3 top-rated online counseling or therapy services available in India.
4.  Return the response ONLY in the specified JSON format.`;

  const userPrompt = `My stress test results:
- Stress Level: ${level}
- Avg Heart Rate: ${hr.toFixed(0)} bpm
- Avg SpO2: ${spo2}%
- Avg GSR: ${gsr.toFixed(0)} (raw value)
- Room Temp: ${temp}¬∞C
Please provide analysis, suggestions, and find online therapy resources in India.`;

  // Define the JSON schema for the response
  const schema = {
    type: "OBJECT",
    properties: {
      "analysis": { "type": "STRING", "description": "A brief, 1-2 sentence analysis of the user's stress level." },
      "suggestions": {
        type: "ARRAY",
        items: { "type": "STRING" },
        description: "A list of 3-4 actionable suggestions with emojis."
      },
      "resources": {
        type: "ARRAY",
        items: {
          type: "OBJECT",
          properties: {
            "name": { "type": "STRING", "description": "The name of the counseling service." },
            "uri": { "type": "STRING", "description": "The website URL for the service." }
          }
        },
        description: "A list of online therapy/counseling resources found via Google Search, available in India."
      }
    },
    required: ["analysis", "suggestions", "resources"]
  };

  const payload = {
    contents: [{ parts: [{ text: userPrompt }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] },
    tools: [{ "google_search": {} }], // Enable Google Search
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: schema,
      temperature: 0.7
    }
  };

  try {
    // Call the API with exponential backoff
    const response = await fetchWithBackoff(API_URL + API_KEY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

    const result = await response.json();
    const candidate = result.candidates?.[0];
    
    if (candidate && candidate.content?.parts?.[0]?.text) {
      const jsonText = candidate.content.parts[0].text;
      const aiResponse = JSON.parse(jsonText);
      renderAISuggestions(aiResponse);
    } else {
      throw new Error("Invalid AI response structure.");
    }

  } catch (error) {
    console.error("Error getting AI suggestions:", error);
    suggestList.innerHTML = `<li>‚ö†Ô∏è Error loading AI suggestions. Please try again later.</li>`;
  }
}

function renderAISuggestions(response) {
  let html = '';
  
  // 1. Analysis
  if (response.analysis) {
    html += `<li><p>${response.analysis.replace(/\n/g, '<br>')}</p></li>`;
  }

  // 2. Suggestions
  if (response.suggestions && response.suggestions.length > 0) {
    html += response.suggestions.map(s => `<li>${s}</li>`).join('');
  }

  // 3. Resources
  if (response.resources && response.resources.length > 0) {
    html += `<li><strong>Professional Help Resources (India):</strong></li>`;
    html += response.resources.map(r => 
      `<li>üåê <strong>${r.name}</strong>: <a href="${r.uri}" target="_blank" rel="noopener noreferrer" style="color: var(--accent);">${r.uri}</a></li>`
    ).join('');
  }

  suggestList.innerHTML = html;
}

// Utility for retrying fetch (exponential backoff)
async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
  try {
    const response = await fetch(url, options);
    if (!response.ok && retries > 0 && (response.status === 429 || response.status >= 500)) {
      // Retry on rate limits or server errors
      await new Promise(resolve => setTimeout(resolve, delay));
      return fetchWithBackoff(url, options, retries - 1, delay * 2);
    }
    return response;
  } catch (error) {
    if (retries > 0) {
      await new Promise(resolve => setTimeout(resolve, delay));
      return fetchWithBackoff(url, options, retries - 1, delay * 2);
    }
    throw error;
  }
}

// --- Bluetooth & UI Cleanup ---
function onDisconnected() {
  setBLEStatus('Disconnected', 'var(--bad)');
  statusText.textContent = 'IDLE';
  countText.textContent = '0';
  
  bleDevice = null;
  startBtn.textContent = 'Connect & Start Test';
}

function setBLEStatus(message, color) {
  const span = bleStatusText.querySelector('span');
  span.textContent = message;
  span.style.color = color;
}

// Breathing animation text
let breatherInterval;
function startBreatherAnimation() {
  if (breatherInterval) clearInterval(breatherInterval);
  breatherCircleText.textContent = 'Inhale...';
  setTimeout(() => {
    breatherCircleText.textContent = 'Exhale...';
  }, 5000); // Half of the 10s animation
  // Loop
  breatherInterval = setInterval(() => {
    breatherCircleText.textContent = 'Inhale...';
    setTimeout(() => {
      breatherCircleText.textContent = 'Exhale...';
    }, 5000);
  }, 10000);
}

// --- Session History (localStorage) ---
const HISTORY_KEY = 'stressHistory';
const MAX_HISTORY = 10;

function saveSession(sessionData) {
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  history.unshift(sessionData); // Add to the front
  
  if (history.length > MAX_HISTORY) {
    history = history.slice(0, MAX_HISTORY);
  }
  
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  if (history.length === 0) {
    historyList.innerHTML = `<li style="color: var(--text-muted); text-align: center; padding: 20px;">No sessions recorded yet.</li>`;
    return;
  }
  
  historyList.innerHTML = history.map(item => `
    <li class="history-item">
      <div><span class="history-level-${item.level}">${item.level}</span></div>
      <div>HR: <span>${item.hr}</span></div>
      <div>SpO‚ÇÇ: <span>${item.spo2}%</span></div>
      <div style="color: var(--text-muted); font-size: 12px;">${item.date}</div>
    </li>
  `).join('');
}

// --- Initial Load ---
window.addEventListener('load', () => {
  createCharts();
  renderHistory();
});

</script>
</body>
</html>

