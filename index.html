<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeuroWell 2.0 ‚Äî Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#020617; --card-bg:rgba(255,255,255,0.04); --card-border:rgba(255,255,255,0.08);
      --text:#e6eef8; --text-body:#aab7c6; --accent:#22d3ee; --good:#4ade80; --warn:#facc15; --bad:#f87171;
    }
    .light{ --bg:#f6f8fb; --card-bg:rgba(255,255,255,0.95); --card-border:rgba(13,18,25,0.06);
      --text:#0b1220; --text-body:#475569; --accent:#0ea5b7; --good:#16a34a; --warn:#d97706; --bad:#dc2626; }

    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:
      radial-gradient(circle at 10% 20%, rgba(34,211,238,0.07), transparent 35%),
      radial-gradient(circle at 80% 90%, rgba(139,92,246,0.04), transparent 40%), var(--bg);
      color:var(--text-body); padding:14px; transition:all .25s ease;}
    .wrap{max-width:1200px;margin:12px auto;display:flex;flex-direction:column;gap:14px;padding:0 12px}

    .card{background:var(--card-bg);border-radius:12px;padding:14px;border:1px solid var(--card-border);box-shadow:0 10px 30px rgba(2,6,23,0.28);transition:transform .18s}
    .card:hover{transform:translateY(-6px)}

    header.appbar{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px}
    .title{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text)}
    .controls{display:flex;align-items:center;gap:10px}

    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:var(--bg)}
    .btn.ghost{background:transparent;border:1px solid var(--card-border);color:var(--text-body)}
    .btn.sos{background:var(--bad);color:#fff;padding:8px 12px;border-radius:10px}

    .dashboard{display:grid;grid-template-columns:1fr;gap:18px}
    @media(min-width:1000px){.dashboard{grid-template-columns:2fr 1fr}}

    .config-grid{display:grid;grid-template-columns:1fr 280px;gap:12px;align-items:center}
    label{display:block;color:var(--text-body);font-size:13px;margin-bottom:6px;font-weight:600}
    input[type=number], input[type=text]{padding:10px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text);width:100%}

    .vitals-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .vital{padding:12px;border-radius:12px;text-align:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
    .vital-label{font-size:13px;color:var(--text-body)}
    .vital-value{font-size:36px;font-weight:800;color:var(--text);margin-top:8px}

    .chart-wrap{height:140px;padding:8px}
    canvas{width:100% !important;height:100% !important}

    .status-box{text-align:center;padding:12px;border-radius:10px;background:rgba(0,0,0,0.06)}
    #statusText{font-weight:800;color:var(--accent)}
    #count{font-size:34px;font-weight:800;color:var(--text);margin-top:8px}

    .breath-circle{width:160px;height:160px;border-radius:50%;display:grid;place-items:center;margin:10px auto;font-weight:800;font-size:18px;
      background:linear-gradient(135deg,var(--accent),#8b5cf6);color:var(--bg);transform:scale(.6);transition:transform 1s cubic-bezier(.2,.9,.3,1);border:6px solid rgba(255,255,255,0.04)}

    .chat-floating{position:fixed;right:20px;bottom:22px;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:var(--accent);color:var(--bg);z-index:400;cursor:pointer;box-shadow:0 10px 30px rgba(2,6,23,0.4)}
    .chat-panel{position:fixed;right:20px;bottom:90px;width:360px;max-width:92%;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:12px;z-index:401;display:none;flex-direction:column;gap:8px}
    .chat-panel.active{display:flex}
    .chat-messages{max-height:300px;overflow:auto;padding:8px;border-radius:8px;background:transparent}
    .chat-input{display:flex;gap:8px}

    .muted{color:var(--text-body);font-size:13px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="appbar card">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.001A3 3 0 0 0 12 5z"/><path d="M12 19a3 3 0 1 0-5.997.001A3 3 0 0 0 12 19z"/></svg>
        NeuroWell 2.0
      </div>

      <div class="controls">
        <div id="bleStatus" class="muted">Status: <span id="bleStatusText" style="color:var(--bad);font-weight:800">Disconnected</span></div>
        <div id="audioToggle" class="muted small" style="cursor:pointer">üîà <span id="audioLabel">Sound Off</span></div>
        <div id="themeToggle" class="muted small" style="cursor:pointer">üåô <span id="themeLabel">Dark</span></div>
        <button id="sosBtn" class="btn sos">SOS</button>
      </div>
    </header>

    <div class="dashboard">
      <div>
        <div class="card">
          <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
              <div style="min-width:220px">
                <label>Room Temperature (¬∞C)</label>
                <div style="display:flex;gap:8px">
                  <input id="roomTemp" type="number" min="10" max="45" value="30" />
                  <button id="getLocationBtn" class="btn ghost">üìç</button>
                </div>
              </div>

              <div style="display:flex;gap:8px;align-items:center">
                <div style="display:flex;gap:8px;align-items:center">
                  <label style="margin:0 6px 0 0;font-weight:700;color:var(--text)">Name</label>
                  <input id="userName" placeholder="Skip or enter name" />
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <label style="margin:0 6px 0 0;font-weight:700;color:var(--text)">Age</label>
                  <input id="userAge" type="number" placeholder="Skip" style="width:90px" />
                </div>
                <button id="startBtn" class="btn primary">Connect & Start Test</button>
              </div>
            </div>

            <div class="muted">Optional: entering name & age helps personalize suggestions. You can skip.</div>
          </div>
        </div>

        <div class="card">
          <div class="vitals-grid">
            <div class="vital">
              <div class="vital-label">üíì Heart Rate</div>
              <div id="valHR" class="vital-value">-- <span style="font-size:12px;color:var(--text-body)">bpm</span></div>
              <div class="chart-wrap"><canvas id="hrChart"></canvas></div>
            </div>

            <div class="vital">
              <div class="vital-label">ü©∏ SpO‚ÇÇ</div>
              <div id="valSp" class="vital-value">-- <span style="font-size:12px;color:var(--text-body)">%</span></div>
              <div class="chart-wrap"><canvas id="spChart"></canvas></div>
            </div>

            <div class="vital">
              <div class="vital-label">‚ö° GSR</div>
              <div id="valGSR" class="vital-value">--</div>
              <div class="chart-wrap"><canvas id="gsrChart"></canvas></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800;color:var(--text)">Live Sensor Stream</div>
            <div class="muted">Real-time graphs ‚Ä¢ smoothing enabled</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:220px">
              <div class="status-box">
                <div id="statusText">IDLE</div>
                <div id="count">0<span style="font-size:12px;color:var(--text-body)">s</span></div>
              </div>
            </div>

            <div style="min-width:260px">
              <div style="display:flex;gap:8px;align-items:center">
                <button id="openBreathBtn" class="btn ghost">üßò Start Breathing</button>
                <button id="resetHistoryBtn" class="btn ghost">Clear History</button>
                <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px"><input id="chartToggle" type="checkbox" checked /> Show charts</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800;color:var(--text)">Suggestions</div>
            <div class="muted">AI-powered tips (optional)</div>
          </div>

          <div style="margin-top:12px" id="analysis-section">
            <div id="finalLevel" class="">--</div>
            <ol id="suggestList"></ol>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="askAI" class="btn ghost">Get suggestions</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800;color:var(--text)">Session History (Last 10)</div>
            <div class="muted">Saved locally</div>
          </div>
          <ul class="history-list" id="history-list" style="margin-top:12px"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Breathing Modal -->
  <div class="modal-overlay" id="breather-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:200">
    <div style="width:92%;max-width:520px;background:var(--card-bg);padding:16px;border-radius:12px;border:1px solid var(--card-border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Calming Exercise</div>
        <button id="close-breather-modal" class="btn ghost">X</button>
      </div>
      <div style="text-align:center;padding:18px">
        <div id="breathCircle" class="breath-circle">Inhale</div>
        <div id="breathDesc" class="muted">Follow the circle for <span id="breathCycles">6</span> cycles</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button id="breathStartBtn" class="btn primary">Start</button>
          <button id="breathStopBtn" class="btn ghost">Stop</button>
          <select id="breathSpeed" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)">
            <option value="8">Slow (4s/6s)</option>
            <option value="6" selected>Normal (3s/4s)</option>
            <option value="4">Fast (2s/3s)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Assistant Chat -->
  <div class="chat-floating" id="chatFab" title="Open Assistant">üí¨</div>
  <div class="chat-panel" id="chatPanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Assistant</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="closeChatBtn" class="btn ghost">X</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="muted">Ask for suggestions about your last session or sensor readings.</div>
    </div>
    <div class="chat-input" style="margin-top:8px">
      <input id="chatInput" placeholder="Ask something (e.g., 'What should I do?')" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)" />
      <button id="sendChatBtn" class="btn primary">Send</button>
    </div>
  </div>

<script>
/* =========================
   Constants (match ESP32)
   ========================= */
const SERVICE_UUID    = "4FAFC201-1FB5-459E-8FCC-C5C9C331914B";
const CHAR_DATA_UUID  = "BEB5483E-36E1-4688-B7F5-EA07361B26A8";
const CHAR_COMMAND_UUID = "A88A02E0-8422-42B0-A555-5203361A832A";

/* AI endpoint (client-side key placeholder) */
const AI_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
const GEMINI_API_KEY = ""; // <- Paste your key here if you want AI suggestions. Keep secret in production.

/* Globals */
let bleDevice=null, gattServer=null, dataCharacteristic=null, commandCharacteristic=null;
const textDecoder = new TextDecoder('utf-8'), textEncoder = new TextEncoder();

/* UI refs */
const startBtn = document.getElementById('startBtn');
const bleStatusText = document.getElementById('bleStatusText');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('count');
const valHR = document.getElementById('valHR');
const valSp = document.getElementById('valSp');
const valGSR = document.getElementById('valGSR');
const suggestList = document.getElementById('suggestList');
const historyList = document.getElementById('history-list');
const getLocationBtn = document.getElementById('getLocationBtn');
const roomTempInput = document.getElementById('roomTemp');

const openBreathBtn = document.getElementById('openBreathBtn');
const breatherModal = document.getElementById('breather-modal');
const closeBreatherModal = document.getElementById('close-breather-modal');
const breathCircle = document.getElementById('breathCircle');
const breathStartBtn = document.getElementById('breathStartBtn');
const breathStopBtn = document.getElementById('breathStopBtn');
const breathSpeed = document.getElementById('breathSpeed');
const breathCyclesLabel = document.getElementById('breathCycles');

const nameInput = document.getElementById('userName');
const ageInput = document.getElementById('userAge');
const themeToggle = document.getElementById('themeToggle');
const themeLabel = document.getElementById('themeLabel');
const audioToggle = document.getElementById('audioToggle');
const audioLabel = document.getElementById('audioLabel');
const chartToggle = document.getElementById('chartToggle');
const resetHistoryBtn = document.getElementById('resetHistoryBtn');
const askAI = document.getElementById('askAI');

/* Chat UI */
const chatFab = document.getElementById('chatFab');
const chatPanel = document.getElementById('chatPanel');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');

/* Charts & smoothing */
const MAX_POINTS = 40;
let hrChart, spChart, gsrChart;
const HR_BUFFER = [], SP_BUFFER = [], GSR_BUFFER = [];
const SMOOTH_WINDOW = 6;

/* flat-spo2 detection */
let spLast=null, spFlatCount=0, SP_FLAT_LIMIT=6;

/* history */
const HISTORY_KEY='stressHistory', MAX_HISTORY=10;

/* -------------------------
   Theme
   ------------------------- */
function applyTheme(){
  const isLight = localStorage.getItem('theme') === 'light';
  if (isLight) document.body.classList.add('light'); else document.body.classList.remove('light');
  themeLabel.textContent = isLight ? 'Light' : 'Dark';
}
themeToggle.addEventListener('click', ()=> {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  applyTheme();
});
applyTheme();

/* -------------------------
   Audio: breathing tone (Web Audio)
   ------------------------- */
let audioCtx=null, mainGain=null, osc1=null, lfo=null, audioPlaying=false;
function initAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  mainGain = audioCtx.createGain(); mainGain.gain.value = 0; mainGain.connect(audioCtx.destination);

  osc1 = audioCtx.createOscillator(); osc1.type='sine'; osc1.frequency.value = 220;
  const osc1Gain = audioCtx.createGain(); osc1Gain.gain.value = 0.0;
  lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.08;
  const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 0.25;

  lfo.connect(lfoGain); lfoGain.connect(osc1Gain.gain);
  osc1.connect(osc1Gain); osc1Gain.connect(mainGain);

  const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 50;
  const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 1200;
  osc1Gain.connect(hp); hp.connect(lp); lp.connect(mainGain);

  osc1.start(); lfo.start();
}
function toggleAudio(){
  if (!audioCtx) initAudio();
  if (!audioPlaying){
    audioCtx.resume().then(()=> {
      mainGain.gain.exponentialRampToValueAtTime(0.18, audioCtx.currentTime + 1.2);
      audioPlaying = true; audioLabel.textContent='Sound On';
    });
  } else {
    mainGain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.0);
    audioPlaying = false; audioLabel.textContent='Sound Off';
  }
}
audioToggle.addEventListener('click', ()=> { try { toggleAudio(); } catch(e){ console.warn(e); } });

/* -------------------------
   Charts
   ------------------------- */
function createCharts(){
  const css = getComputedStyle(document.documentElement);
  const bad = css.getPropertyValue('--bad').trim() || '#f87171';
  const accent = css.getPropertyValue('--accent').trim() || '#22d3ee';
  const warn = css.getPropertyValue('--warn').trim() || '#facc15';

  function cfg(label, color){
    return {
      type:'line',
      data:{labels:[],datasets:[{label,data:[],borderColor:color,borderWidth:3,pointRadius:0,tension:0.35,fill:true,
        backgroundColor:(ctx)=>{const c=ctx.chart;const g=c.ctx.createLinearGradient(0,0,0,c.height);g.addColorStop(0,color+'33');g.addColorStop(1,color+'05');return g}}]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},
        scales:{x:{display:false,grid:{display:false}},y:{ticks:{color:css.getPropertyValue('--text-body')},grid:{color:css.getPropertyValue('--card-border')}}}
    };
  }
  hrChart = new Chart(document.getElementById('hrChart'), cfg('HR', bad));
  spChart = new Chart(document.getElementById('spChart'), cfg('SpO2', accent));
  gsrChart = new Chart(document.getElementById('gsrChart'), cfg('GSR', warn));
  spChart.options.scales.y.min = 80; spChart.options.scales.y.max = 100;
}
function updateChart(chart, value){
  if (!chart || !chart.data) return;
  if (!document.getElementById('chartToggle').checked) return;
  chart.data.labels.push(''); chart.data.datasets[0].data.push(value);
  if (chart.data.labels.length > MAX_POINTS){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
  chart.update('none');
}
window.addEventListener('load', createCharts);

/* -------------------------
   Weather helper
   ------------------------- */
getLocationBtn.addEventListener('click', ()=> {
  if (navigator.geolocation) {
    getLocationBtn.disabled = true; getLocationBtn.textContent = '...';
    navigator.geolocation.getCurrentPosition(fetchWeather, (e)=>{ alert('Location error: '+e.message); getLocationBtn.disabled=false; getLocationBtn.textContent='üìç'; });
  } else alert('Geolocation not supported.');
});
async function fetchWeather(position){
  try{ const {latitude,longitude} = position.coords; const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`); const d = await r.json(); if (d.current_weather && typeof d.current_weather.temperature === 'number') roomTempInput.value = Math.round(d.current_weather.temperature); } catch(e){ console.error(e) } finally { getLocationBtn.disabled=false; getLocationBtn.textContent='üìç'; }
}

/* -------------------------
   BLE connect & data
   ------------------------- */
startBtn.addEventListener('click', async ()=>{
  startBtn.disabled = true;
  try {
    if (!bleDevice || !bleDevice.gatt.connected) {
      setBLEStatus('Requesting device...', 'warn'); statusText.textContent='CONNECTING';
      bleDevice = await navigator.bluetooth.requestDevice({ filters:[{ services: [SERVICE_UUID] }], optionalServices:[SERVICE_UUID] });
      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      setBLEStatus('Connecting...', 'warn');
      gattServer = await bleDevice.gatt.connect();
      setBLEStatus('Getting service...', 'warn');
      const service = await gattServer.getPrimaryService(SERVICE_UUID);
      setBLEStatus('Getting characteristics...', 'warn');
      dataCharacteristic = await service.getCharacteristic(CHAR_DATA_UUID);
      commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID);
      await dataCharacteristic.startNotifications();
      dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotification);
      setBLEStatus('Connected', 'good');
      startBtn.textContent = 'Start 40s Test';
    }

    // Send start command to ESP32: roomTemp and a suggested IR threshold hint
    statusText.textContent = 'STARTING';
    const temp = parseInt(roomTempInput.value || '30', 10);
    let irThr = 20000; if (temp < 20) irThr = 15000; else if (temp >= 28) irThr = 25000;
    analysisSection.style.display = 'none'; finalLevelText.textContent='--'; finalLevelText.className='';
    suggestList.innerHTML = '';
    [hrChart, spChart, gsrChart].forEach(c => { if (c){ c.data.labels=[]; c.data.datasets[0].data=[]; c.update(); }});
    const cmd = JSON.stringify({ roomTemp: temp, irThreshold: irThr });
    try { await commandCharacteristic.writeValue(textEncoder.encode(cmd)); } catch(e){ console.warn('Command write failed', e); }
    statusText.textContent = 'MEASURING';
  } catch(e){
    console.error('BLE error', e);
    setBLEStatus('Error', 'bad');
    if (bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect();
  } finally { startBtn.disabled = false; }
});

function onDisconnected(){ setBLEStatus('Disconnected','bad'); statusText.textContent='IDLE'; countText.textContent='0'; analysisSection.style.display='none'; bleDevice=null; startBtn.textContent='Connect & Start Test'; }
function setBLEStatus(msg, level){ document.getElementById('bleStatusText').textContent = msg; if(level==='good') document.getElementById('bleStatusText').style.color = getComputedStyle(document.documentElement).getPropertyValue('--good'); else if(level==='warn') document.getElementById('bleStatusText').style.color = getComputedStyle(document.documentElement).getPropertyValue('--warn'); else document.getElementById('bleStatusText').style.color = getComputedStyle(document.documentElement).getPropertyValue('--bad'); }

/* -------------------------
   Data handling + smoothing
   ------------------------- */
function pushAndSmooth(buffer, v){
  if (typeof v !== 'number' || isNaN(v)) return null;
  buffer.push(v);
  if (buffer.length > SMOOTH_WINDOW) buffer.shift();
  return buffer.reduce((a,b)=>a+b,0) / buffer.length;
}

function handleDataNotification(event){
  const jsonString = textDecoder.decode(event.target.value);
  try {
    const data = JSON.parse(jsonString);
    const hrRaw = Number(data.hr) || 0;
    const spo2Raw = Number(data.spo2) || -1;
    const gsrRaw = Number(data.gsr) || 0;

    const hr = pushAndSmooth(HR_BUFFER, hrRaw) || 0;
    const spo2 = (spo2Raw>0) ? pushAndSmooth(SP_BUFFER, spo2Raw) : -1;
    const gsr = pushAndSmooth(GSR_BUFFER, gsrRaw) || 0;

    valHR.textContent = hr>0 ? Math.round(hr) : '--';
    valSp.textContent = spo2>0 ? Math.round(spo2) : '--';
    valGSR.textContent = gsr>0 ? Math.round(gsr) : '--';

    if (hr>0 && hr<220) updateChart(hrChart, Math.round(hr));
    if (spo2>0 && spo2<=100) updateChart(spChart, Math.round(spo2));
    if (gsr>=0) updateChart(gsrChart, Math.round(gsr));

    statusText.textContent = data.status || 'UNKNOWN';
    if (data.status === 'MEASURING') {
      countText.textContent = data.timeLeft ? Math.ceil(data.timeLeft / 1000) : '0';
      document.getElementById('analysis-section').style.display = 'none';
    }

    if (data.status === 'DONE') {
      countText.textContent = 0;
      document.getElementById('analysis-section').style.display = 'block';
      const level = data.finalLevel || 'ERROR';
      document.getElementById('finalLevel').textContent = level;
      document.getElementById('finalLevel').className = `level-${level}`;
      saveSession({
        level,
        hr: hr>0 ? Math.round(hr) : '--',
        spo2: spo2>0 ? Math.round(spo2) : '--',
        gsr: gsr>0 ? Math.round(gsr) : '--',
        date: new Date().toLocaleString('en-IN'),
        name: nameInput.value || '‚Äî',
        age: ageInput.value || '‚Äî'
      });
      renderStaticSuggestions(level);
    }

    detectFlatSpO2(spo2Raw);

  } catch (err) {
    console.error('Parse error', jsonString, err);
  }
}

/* detect flat spO2 and ask user to adjust */
function detectFlatSpO2(spo2Raw){
  if (typeof spo2Raw !== 'number') return;
  if (spo2Raw === spLast) spFlatCount++; else { spFlatCount=0; spLast=spo2Raw; }
  if (spFlatCount >= SP_FLAT_LIMIT){
    suggestList.innerHTML = `<li>‚ö†Ô∏è SpO‚ÇÇ is not varying ‚Äî sensor may not detect pulse. Tips:
      <ul style="margin:6px 0 0 18px">
        <li>Cover the sensor fully with your finger (moderate pressure).</li>
        <li>Reduce ambient light (cover with hand/housing).</li>
        <li>Try warming the finger or use another finger.</li>
      </ul>
    </li>`;
    try {
      if (commandCharacteristic){
        const cmd = JSON.stringify({ action:'recalibrate', hint:'increase_ir' });
        commandCharacteristic.writeValue(textEncoder.encode(cmd)).catch(()=>{/*ignore*/});
      }
    } catch(e){/*ignore*/}
  }
}

/* -------------------------
   Local suggestions & history
   ------------------------- */
const staticSuggestions = {
  LOW: ["üòå You're calm. Keep hydrating and short breaks.", "üßò Try breathing practice for 3‚Äì5 minutes."],
  MODERATE: ["‚ö† Slight stress. Try 4-4-6 breathing x3.", "üö∂ Step away for 5 minutes and stretch."],
  HIGH: ["üõë High stress. Pause and perform deep breathing (4s in, 6s out).", "üó£ If persistent, contact someone or seek professional help."]
};
function renderStaticSuggestions(level){
  suggestList.innerHTML=''; (staticSuggestions[level]||staticSuggestions.MODERATE).forEach(s=>{ const li=document.createElement('li'); li.innerHTML=s; suggestList.appendChild(li); });
}

/* history */
function saveSession(sessionData){
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
  history.unshift(sessionData); if (history.length>MAX_HISTORY) history=history.slice(0,MAX_HISTORY);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); renderHistory();
}
function renderHistory(){ const history=JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); if(!history.length){ historyList.innerHTML='<li style="text-align:center;color:var(--text-body);padding:12px">No sessions recorded.</li>'; return; }
  historyList.innerHTML = history.map(h=>`<li style="display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid var(--card-border)"><div style="flex:1"><div style="font-weight:700">${h.name||'‚Äî'}</div><div class="muted" style="font-size:12px">${h.date}</div></div><div style="min-width:80px;text-align:right"><div style="font-weight:700">${h.level}</div><div class="muted" style="font-size:12px">HR:${h.hr}</div></div></li>`).join(''); }
resetHistoryBtn.addEventListener('click', ()=>{ localStorage.removeItem(HISTORY_KEY); renderHistory(); });
renderHistory();

/* persist profile */
[nameInput, ageInput].forEach(el=>el.addEventListener('change', ()=> localStorage.setItem('nw_profile', JSON.stringify({name:nameInput.value||'', age:ageInput.value||''}))));
(() => { const p=JSON.parse(localStorage.getItem('nw_profile')||'{}'); if(p.name) nameInput.value=p.name; if(p.age) ageInput.value=p.age; })();

/* -------------------------
   Breathing exercise
   ------------------------- */
let breathInterval=null, breathRunning=false;
function startBreathing(cycles=6, inhale=3, hold=0, exhale=4){
  stopBreathing(); breathRunning=true; let step=0, cycleCount=0;
  breathCircle.style.transition=`transform ${inhale}s cubic-bezier(.2,.9,.3,1), opacity .2s`;
  breathCircle.textContent='Inhale'; breathCircle.style.transform='scale(1)'; breathCyclesLabel.textContent=cycles;
  breathInterval = setTimeout(function loop(){
    if (!breathRunning) return;
    if (step===0){
      if (hold>0){ breathCircle.textContent='Hold'; breathCircle.style.transition=`transform ${hold}s linear`; step=1; breathInterval=setTimeout(loop, hold*1000); }
      else { step=2; breathCircle.textContent='Exhale'; breathCircle.style.transition=`transform ${exhale}s ease-out`; breathCircle.style.transform='scale(.6)'; breathInterval=setTimeout(loop, exhale*1000); }
    } else if (step===1){ step=2; breathCircle.textContent='Exhale'; breathCircle.style.transition=`transform ${exhale}s ease-out`; breathCircle.style.transform='scale(.6)'; breathInterval=setTimeout(loop, exhale*1000); }
    else if (step===2){ cycleCount++; if (cycleCount>=cycles){ stopBreathing(); return; } step=0; breathCircle.textContent='Inhale'; breathCircle.style.transition=`transform ${inhale}s cubic-bezier(.2,.9,.3,1)`; breathCircle.style.transform='scale(1)'; breathInterval=setTimeout(loop, inhale*1000); }
  }, inhale*1000);
}
function stopBreathing(){ if (breathInterval) clearTimeout(breathInterval); breathInterval=null; breathRunning=false; breathCircle.style.transform='scale(.6)'; breathCircle.textContent='Stopped'; }

openBreathBtn.addEventListener('click', ()=> document.getElementById('breather-modal').style.display='flex');
closeBreatherModal.addEventListener('click', ()=> { document.getElementById('breather-modal').style.display='none'; stopBreathing(); });
breathStartBtn.addEventListener('click', ()=> {
  const val=Number(breathSpeed.value);
  if (val===8) startBreathing(6,4,0,6); else if (val===6) startBreathing(6,3,0,4); else startBreathing(8,2,0,3);
});
breathStopBtn.addEventListener('click', ()=> stopBreathing());

/* -------------------------
   Assistant (AI) integration (anonymous "Assistant")
   ------------------------- */
function appendChatMessage(who, text){
  const div=document.createElement('div');
  if (who==='user') div.style.textAlign='right', div.innerHTML=`<div style="display:inline-block;background:var(--accent);color:var(--bg);padding:8px;border-radius:8px;margin:6px">${escapeHtml(text)}</div>`;
  else if (who==='assistant') div.innerHTML=`<div style="display:inline-block;background:rgba(255,255,255,0.03);color:var(--text);padding:8px;border-radius:8px;margin:6px">${escapeHtml(text)}</div>`;
  else div.innerHTML=`<div style="display:inline-block;color:var(--text-body);padding:6px;margin:6px">${escapeHtml(text)}</div>`;
  chatMessages.appendChild(div); chatMessages.scrollTop = chatMessages.scrollHeight;
}
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

chatFab.addEventListener('click', ()=> chatPanel.classList.toggle('active'));
closeChatBtn.addEventListener('click', ()=> chatPanel.classList.remove('active'));
sendChatBtn.addEventListener('click', ()=> {
  const q = chatInput.value.trim(); if (!q) return;
  appendChatMessage('user', q);
  askAssistant(q);
  chatInput.value='';
});

askAI.addEventListener('click', ()=> {
  // ask about last session
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); const last = history[0];
  if (!last) { appendChatMessage('assistant', 'No session found. Complete a test first.'); return; }
  const prompt = `Please analyze the last session and give a concise 2-sentence analysis and 3 actionable tips. Data: Level=${last.level}, HR=${last.hr}, SpO2=${last.spo2}, GSR=${last.gsr}, Age=${last.age}`;
  appendChatMessage('user', 'Analyze last session');
  askAssistant(prompt);
});

/* AI call helper (uses Gemini endpoint if key is present) */
async function askAssistant(prompt){
  if (!GEMINI_API_KEY) {
    appendChatMessage('assistant','Assistant is offline (no API key configured). Showing local suggestions instead.');
    const lastLevel = JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]')[0]?.level || 'MODERATE';
    renderStaticSuggestions(lastLevel);
    return;
  }

  appendChatMessage('assistant','Thinking...');
  try {
    const payload = { contents:[ { parts:[{ text: prompt }] } ], systemInstruction:{ parts:[{ text: "You are a concise wellness assistant." }] }, generationConfig:{ temperature:0.45, maxOutputTokens:400 } };
    const resp = await fetch(AI_BASE + GEMINI_API_KEY, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
    if (!resp.ok) throw new Error('AI error ' + resp.status);
    const data = await resp.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || JSON.stringify(data);
    // Replace previous "Thinking..." message with assistant response
    appendChatMessage('assistant', text);
  } catch (e) {
    console.error('AI error', e);
    appendChatMessage('assistant','Sorry ‚Äî could not fetch suggestions. Showing local tips instead.');
    const lastLevel = JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]')[0]?.level || 'MODERATE';
    renderStaticSuggestions(lastLevel);
  }
}

/* -------------------------
   Small helpers & init
   ------------------------- */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* initialize theme, charts */
applyTheme();

/* End of file */
</script>
</body>
</html>
