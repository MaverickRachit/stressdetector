<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeuroWell 2.0 ‚Äî Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #020617;
      --card-bg: rgba(255,255,255,0.04);
      --card-border: rgba(255,255,255,0.08);
      --text: #e6eef8;
      --text-body:#aab7c6;
      --accent: #22d3ee;
      --good:#4ade80; --warn:#facc15; --bad:#f87171;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
    }
    /* Light theme variables */
    .light {
      --bg: #f6f8fb;
      --card-bg: rgba(255,255,255,0.9);
      --card-border: rgba(13,18,25,0.06);
      --text: #0b1220;
      --text-body:#475569;
      --accent: #0ea5b7;
      --good:#16a34a; --warn:#d97706; --bad:#dc2626;
      --glass: rgba(255,255,255,0.7);
      --glass-2: rgba(255,255,255,0.9);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: radial-gradient(circle at 10% 20%, rgba(34,211,238,0.07), transparent 35%), radial-gradient(circle at 80% 90%, rgba(139,92,246,0.04), transparent 40%), var(--bg);
      color:var(--text-body);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background-color .25s ease, color .25s ease;
      padding:16px 12px;
    }

    .wrap{max-width:1200px;margin:12px auto;padding:0 12px;display:flex;flex-direction:column;gap:16px}

    header.appbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--card-border); padding:16px;border-radius:12px;backdrop-filter: blur(8px);
    }
    .title {display:flex;align-items:center;gap:12px;font-weight:700;color:var(--text);font-size:18px}
    .controls{display:flex;align-items:center;gap:10px}

    .btn {padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:var(--bg);box-shadow:0 6px 22px rgba(0,0,0,0.2)}
    .btn.ghost{background:transparent;border:1px solid var(--card-border);color:var(--text-body)}
    .btn.sos{background:var(--bad);color:#fff}

    .dashboard{display:grid;grid-template-columns:1fr;gap:20px;margin-top:6px}
    @media(min-width:1000px){ .dashboard{grid-template-columns:2fr 1fr} }

    .card{
      background:var(--card-bg); border-radius:14px; padding:18px; border:1px solid var(--card-border);
      box-shadow: 0 8px 30px rgba(2,6,23,0.25);
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .card:hover{ transform:translateY(-4px) }

    /* Config area */
    .config-grid{display:grid;grid-template-columns:1fr 220px;gap:12px;align-items:center}
    @media(max-width:640px){ .config-grid{grid-template-columns:1fr;}}
    label{display:block;color:var(--text-body);font-size:13px;margin-bottom:6px;font-weight:600}
    input[type=number]{padding:10px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text);width:100%}

    /* Vitals */
    .vitals-grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
    @media(max-width:760px){ .vitals-grid{grid-template-columns:1fr 1fr 1fr; } }
    .vital{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:12px;text-align:center}
    .vital-label{font-size:13px;color:var(--text-body);display:flex;align-items:center;gap:8px;justify-content:center}
    .vital-value{font-size:36px;font-weight:800;color:var(--text);margin-top:8px}

    /* charts */
    .chart-wrap{height:220px;background:transparent;border-radius:10px;padding:8px}
    canvas{width:100% !important;height:100% !important;display:block}

    /* status side */
    .status-box{padding:12px;border-radius:10px;text-align:center;background:rgba(0,0,0,0.06)}
    #statusText{font-weight:700;color:var(--accent)}
    #count{font-size:36px;font-weight:800;color:var(--text);margin-top:8px}

    /* final level */
    #finalLevel{font-size:26px;font-weight:800;padding:12px;border-radius:10px;text-align:center;color:#000;margin-bottom:12px}
    .level-LOW{background:linear-gradient(90deg,var(--good),#86efac)}
    .level-MODERATE{background:linear-gradient(90deg,var(--warn),#fde047)}
    .level-HIGH{background:linear-gradient(90deg,var(--bad),#fca5a5)}

    /* suggestions */
    #suggestList li{background:var(--glass);padding:10px;margin-bottom:8px;border-radius:8px;color:var(--text-body);list-style:none}

    /* history */
    .history-list{list-style:none;padding:0;margin:0;max-height:260px;overflow:auto}
    .history-item{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid var(--card-border)}
    .history-item .label{font-weight:700;color:var(--text)}
    .history-level-LOW{color:var(--good)} .history-level-MODERATE{color:var(--warn)} .history-level-HIGH{color:var(--bad)}

    /* modal */
    .modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:200}
    .modal-overlay.active{display:flex}
    .modal{width:92%;max-width:520px;background:var(--card-bg);padding:18px;border-radius:12px;border:1px solid var(--card-border)}

    /* breather */
    .breather-container{text-align:center;padding:18px}
    .breath-circle{
      width:160px;height:160px;border-radius:50%;display:grid;place-items:center;margin:10px auto;
      background:linear-gradient(135deg,var(--accent),#8b5cf6);color:var(--bg);font-weight:700;font-size:18px;
      transform:scale(.6);opacity:.8;border:6px solid rgba(255,255,255,0.06);
    }
    .breath-text{color:var(--text-body);margin-top:10px;font-weight:600}

    /* name/age banner */
    .profile-row{display:flex;gap:8px;align-items:center}
    .profile-row input{padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text);}

    /* small UI */
    .muted{color:var(--text-body);font-size:13px}
    .toggle{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--card-border);cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header class="appbar card">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.001A3 3 0 0 0 12 5zm0 14a3 3 0 1 0-5.997.001A3 3 0 0 0 12 19zm0-7a3 3 0 1 0 5.997-.001A3 3 0 0 0 12 12z"/><path d="M12 5v7m0 0v7m0-7h7.5m-7.5 7H4"/></svg>
        NeuroWell 2.0
      </div>

      <div class="controls">
        <div id="bleStatus" class="muted">Status: <span style="color:var(--bad);font-weight:700" id="bleStatusText">Disconnected</span></div>
        <div class="toggle" id="themeToggle" title="Toggle Light / Dark">üåô <span id="themeLabel" style="font-weight:700;margin-left:6px">Dark</span></div>
        <button id="sosBtn" class="btn sos">SOS</button>
      </div>
    </header>

    <div class="dashboard">
      <div class="main-col">

        <div class="card">
          <div style="display:flex;flex-direction:column;gap:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
              <div style="min-width:220px">
                <label>Room Temperature (¬∞C)</label>
                <div style="display:flex;gap:8px">
                  <input id="roomTemp" type="number" min="10" max="45" value="30" />
                  <button id="getLocationBtn" class="btn ghost" title="Use my location">üìç</button>
                </div>
              </div>

              <div style="display:flex;gap:8px;align-items:center">
                <div class="profile-row">
                  <label style="margin:0 6px 0 0;font-weight:700;color:var(--text);">Name</label>
                  <input id="userName" placeholder="Skip or enter name" />
                </div>
                <div class="profile-row">
                  <label style="margin:0 6px 0 0;font-weight:700;color:var(--text);">Age</label>
                  <input id="userAge" type="number" placeholder="Skip" style="width:84px" />
                </div>
                <button id="startBtn" class="btn primary">Connect & Start Test</button>
              </div>
            </div>

            <div class="muted" id="profileNote">Optional: entering name & age helps personalized suggestions. You can skip.</div>
          </div>
        </div>

        <div class="card">
          <div class="vitals-grid">
            <div class="vital">
              <div class="vital-label">üíì Heart Rate</div>
              <div id="valHR" class="vital-value">-- <span style="font-size:14px;font-weight:600;color:var(--text-body)">bpm</span></div>
              <div style="height:120px;margin-top:12px" class="chart-wrap"><canvas id="hrChart"></canvas></div>
            </div>

            <div class="vital">
              <div class="vital-label">ü©∏ SpO‚ÇÇ</div>
              <div id="valSp" class="vital-value">-- <span style="font-size:14px;font-weight:600;color:var(--text-body)">%</span></div>
              <div style="height:120px;margin-top:12px" class="chart-wrap"><canvas id="spChart"></canvas></div>
            </div>

            <div class="vital">
              <div class="vital-label">‚ö° GSR</div>
              <div id="valGSR" class="vital-value">--</div>
              <div style="height:120px;margin-top:12px" class="chart-wrap"><canvas id="gsrChart"></canvas></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;color:var(--text)">Live Sensor Stream</div>
            <div class="muted">Real-time charts with smoothing</div>
          </div>
          <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:220px">
              <div class="status-box">
                <div id="statusText">IDLE</div>
                <div id="count">0<span style="font-size:12px;color:var(--text-body)">s</span></div>
              </div>
            </div>
            <div style="min-width:260px">
              <div style="display:flex;gap:8px;align-items:center">
                <button id="openBreathBtn" class="btn ghost">üßò Start Calming Exercise</button>
                <button id="resetHistoryBtn" class="btn ghost">Clear History</button>
                <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px"><input id="chartToggle" type="checkbox" checked /> Show charts</label>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="side-col">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;color:var(--text)">Analysis & Suggestions</div>
            <div class="muted">Local AI-less suggestions</div>
          </div>

          <div style="margin-top:12px" id="analysis-section">
            <div id="finalLevel" class="">--</div>
            <ol id="suggestList"></ol>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700;color:var(--text)">Session History (Last 10)</div>
            <div class="muted">Saved to localStorage</div>
          </div>
          <ul class="history-list" id="history-list" style="margin-top:12px"></ul>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="sos-modal"><div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Emergency Helplines (India)</div>
        <button id="close-sos-modal" class="btn ghost">X</button>
      </div>
      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>Ambulance</div><div style="font-weight:700;color:var(--accent)">102 / 108</div></div>
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>Police</div><div style="font-weight:700;color:var(--accent)">100 / 112</div></div>
        <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>National Mental Health</div><div style="font-weight:700;color:var(--accent)">1800-599-0019</div></div>
      </div>
    </div></div>

    <div class="modal-overlay" id="breather-modal"><div class="modal card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Calming Exercise</div>
        <button id="close-breather-modal" class="btn ghost">X</button>
      </div>

      <div class="breather-container" style="margin-top:16px">
        <div id="breathCircle" class="breath-circle">Inhale</div>
        <div id="breathDesc" class="breath-text">Follow the circle for <span id="breathCycles">6</span> cycles</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button id="breathStartBtn" class="btn primary">Start</button>
          <button id="breathStopBtn" class="btn ghost">Stop</button>
          <select id="breathSpeed" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)">
            <option value="8">Slow (4s/6s)</option>
            <option value="6">Normal (3s/4s)</option>
            <option value="4">Fast (2s/3s)</option>
          </select>
        </div>
      </div>
    </div></div>

  </div>

<script>
/* =========================
   CONFIG / BLE (unchanged core concept)
   ========================= */
const SERVICE_UUID    = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_DATA_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_COMMAND_UUID = "a88a02e0-8422-42b0-a555-5203361a832a";

let bleDevice = null;
let gattServer = null;
let dataCharacteristic = null;
let commandCharacteristic = null;
const textDecoder = new TextDecoder('utf-8');
const textEncoder = new TextEncoder();

/* UI elements */
const startBtn = document.getElementById('startBtn');
const bleStatusText = document.getElementById('bleStatusText');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('count');
const analysisSection = document.getElementById('analysis-section');
const finalLevelText = document.getElementById('finalLevel');
const valHR = document.getElementById('valHR');
const valSp = document.getElementById('valSp');
const valGSR = document.getElementById('valGSR');
const suggestList = document.getElementById('suggestList');
const heartIcon = null;
const historyList = document.getElementById('history-list');
const getLocationBtn = document.getElementById('getLocationBtn');
const roomTempInput = document.getElementById('roomTemp');

const sosBtn = document.getElementById('sosBtn');
const sosModal = document.getElementById('sos-modal');
const closeSosModal = document.getElementById('close-sos-modal');

const openBreathBtn = document.getElementById('openBreathBtn');
const breatherModal = document.getElementById('breather-modal');
const closeBreatherModal = document.getElementById('close-breather-modal');
const breathCircle = document.getElementById('breathCircle');
const breathDesc = document.getElementById('breathDesc');
const breathStartBtn = document.getElementById('breathStartBtn');
const breathStopBtn = document.getElementById('breathStopBtn');
const breathSpeed = document.getElementById('breathSpeed');
const breathCyclesLabel = document.getElementById('breathCycles');

const nameInput = document.getElementById('userName');
const ageInput = document.getElementById('userAge');
const themeToggle = document.getElementById('themeToggle');
const themeLabel = document.getElementById('themeLabel');
const chartToggle = document.getElementById('chartToggle');
const resetHistoryBtn = document.getElementById('resetHistoryBtn');

/* Chart.js setup */
const MAX_POINTS = 40;
let hrChart, spChart, gsrChart;

/* smoothing buffers (moving average) */
const HR_BUFFER = [];
const SP_BUFFER = [];
const GSR_BUFFER = [];
const SMOOTH_WINDOW = 6;

/* flat reading detection for SpO2 (common symptom of MAX3010x no finger) */
let spLast = null;
let spFlatCount = 0;
const SP_FLAT_LIMIT = 6; // if same value repeats 6 times, treat as flat

/* History */
const HISTORY_KEY = 'stressHistory';
const MAX_HISTORY = 10;

/* utility: theme */
function applyTheme() {
  const root = document.documentElement;
  const isLight = localStorage.getItem('theme') === 'light';
  if (isLight) document.body.classList.add('light'); else document.body.classList.remove('light');
  themeLabel.textContent = isLight ? 'Light' : 'Dark';
}
themeToggle.addEventListener('click', () => {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
  applyTheme();
});
applyTheme();

/* create charts with gradient using CSS variables */
function createCharts(){
  const css = getComputedStyle(document.documentElement);
  const bad = css.getPropertyValue('--bad').trim() || '#f87171';
  const accent = css.getPropertyValue('--accent').trim() || '#22d3ee';
  const warn = css.getPropertyValue('--warn').trim() || '#facc15';

  function cfg(label, color){
    return {
      type:'line',
      data:{labels:[],datasets:[{
        label, data:[], borderColor:color, borderWidth:3, pointRadius:0, tension:0.35, fill:true,
        backgroundColor: (ctx)=>{
          const chart = ctx.chart;
          const gradient = chart.ctx.createLinearGradient(0,0,0,chart.height);
          gradient.addColorStop(0, color + '33');
          gradient.addColorStop(1, color + '05');
          return gradient;
        }
      }]},
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{legend:{display:false}},
        scales:{
          x:{display:false, grid:{display:false}},
          y:{ticks:{color:css.getPropertyValue('--text-body')}, grid:{color:css.getPropertyValue('--card-border')}}
        }
      }
    };
  }

  hrChart = new Chart(document.getElementById('hrChart'), cfg('Heart Rate', bad || '#f87171'));
  spChart = new Chart(document.getElementById('spChart'), cfg('SpO2', accent || '#22d3ee'));
  gsrChart = new Chart(document.getElementById('gsrChart'), cfg('GSR', warn || '#facc15'));

  // sensible Y for SpO2
  spChart.options.scales.y.min = 80;
  spChart.options.scales.y.max = 100;
}

function updateChart(chart, value){
  if(!chart || !chart.data) return;
  if (!chartToggle.checked) return;
  chart.data.labels.push('');
  chart.data.datasets[0].data.push(value);
  if (chart.data.labels.length > MAX_POINTS){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
  chart.update('none');
}

/* weather location helper */
getLocationBtn.addEventListener('click', () => {
  if (navigator.geolocation) {
    getLocationBtn.disabled = true; getLocationBtn.textContent = '...';
    navigator.geolocation.getCurrentPosition(fetchWeather, (e)=>{ alert('Location error: ' + e.message); getLocationBtn.disabled=false; getLocationBtn.textContent='üìç'; });
  } else alert('Geolocation not supported.');
});
async function fetchWeather(position){
  try{
    const {latitude,longitude} = position.coords;
    const api = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
    const r = await fetch(api); const data = await r.json();
    if (data.current_weather && typeof data.current_weather.temperature === 'number'){
      roomTempInput.value = Math.round(data.current_weather.temperature);
    }
  }catch(e){ console.error(e) } finally { getLocationBtn.disabled=false; getLocationBtn.textContent='üìç'; }
}

/* --- BLE connect + notifications --- */
startBtn.addEventListener('click', async () => {
  startBtn.disabled = true;
  try {
    if (!bleDevice || !bleDevice.gatt.connected) {
      setBLEStatus('Requesting device...', 'warn');
      statusText.textContent = 'CONNECTING';
      bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }], optionalServices: [SERVICE_UUID] });
      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      setBLEStatus('Connecting...', 'warn');
      gattServer = await bleDevice.gatt.connect();
      setBLEStatus('Getting service...', 'warn');
      const service = await gattServer.getPrimaryService(SERVICE_UUID);
      setBLEStatus('Getting chars...', 'warn');
      dataCharacteristic = await service.getCharacteristic(CHAR_DATA_UUID);
      commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID);
      await dataCharacteristic.startNotifications();
      dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotification);
      setBLEStatus('Connected', 'good');
      startBtn.textContent = 'Start 40s Test';
    }

    // send start command (room temp + attempted IR auto-tune hint)
    statusText.textContent = 'STARTING';
    const temp = parseInt(roomTempInput.value || '30', 10);
    let irThr = 20000;
    if (temp < 20) irThr = 15000;
    else if (temp >= 28) irThr = 25000;

    // reset UI
    analysisSection.style.display = 'none';
    finalLevelText.textContent = '--';
    finalLevelText.className = '';
    suggestList.innerHTML = '';

    [hrChart, spChart, gsrChart].forEach(c => { if (c) { c.data.labels = []; c.data.datasets[0].data = []; c.update(); } });

    const command = JSON.stringify({ roomTemp: temp, irThreshold: irThr });
    try { await commandCharacteristic.writeValue(textEncoder.encode(command)); } catch(e){ console.warn('Command write failed', e); }

    statusText.textContent = 'MEASURING';
  } catch (err) {
    console.error('BLE Err', err);
    setBLEStatus('Error', 'bad');
    if (bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect();
  } finally { startBtn.disabled = false; }
});

function onDisconnected(){
  setBLEStatus('Disconnected','bad');
  statusText.textContent = 'IDLE';
  countText.textContent = '0';
  analysisSection.style.display = 'none';
  bleDevice = null;
  startBtn.textContent = 'Connect & Start Test';
}
function setBLEStatus(message, level){
  bleStatusText.textContent = message;
  if (level === 'good') bleStatusText.style.color = getComputedStyle(document.documentElement).getPropertyValue('--good');
  else if (level === 'warn') bleStatusText.style.color = getComputedStyle(document.documentElement).getPropertyValue('--warn');
  else bleStatusText.style.color = getComputedStyle(document.documentElement).getPropertyValue('--bad');
}

/* --- Data handler & smoothing --- */
function pushAndSmooth(buffer, v){
  if (typeof v !== 'number' || isNaN(v)) return null;
  buffer.push(v);
  if (buffer.length > SMOOTH_WINDOW) buffer.shift();
  const sum = buffer.reduce((a,b)=>a+b,0);
  return sum / buffer.length;
}

function handleDataNotification(event){
  const jsonString = textDecoder.decode(event.target.value);
  try {
    const data = JSON.parse(jsonString);

    // raw values (device should send numeric fields)
    const hrRaw = Number(data.hr) || 0;
    const spo2Raw = Number(data.spo2) || -1;
    const gsrRaw = Number(data.gsr) || 0;

    // smoothing
    const hr = pushAndSmooth(HR_BUFFER, hrRaw) || 0;
    const spo2 = (spo2Raw > 0) ? pushAndSmooth(SP_BUFFER, spo2Raw) : -1;
    const gsr = pushAndSmooth(GSR_BUFFER, gsrRaw) || 0;

    // update displayed values (apply constraints)
    valHR.textContent = hr > 0 ? Math.round(hr) : '--';
    valSp.textContent = (spo2 > 0) ? Math.round(spo2) : '--';
    valGSR.textContent = gsr > 0 ? Math.round(gsr) : '--';

    // dynamic heart animation (slower when HR low)
    // (left as CSS animation hooks or future implementation)

    // charts: supply only valid numeric values within range
    if (hr > 0 && hr < 220) updateChart(hrChart, Math.round(hr));
    if (spo2 > 0 && spo2 <= 100) updateChart(spChart, Math.round(spo2));
    if (gsr >= 0) updateChart(gsrChart, Math.round(gsr));

    // status & counting
    statusText.textContent = data.status || 'UNKNOWN';
    if (data.status === 'MEASURING') {
      countText.textContent = data.timeLeft ? Math.ceil(data.timeLeft / 1000) : '0';
      analysisSection.style.display = 'none';
    }

    if (data.status === 'DONE') {
      countText.textContent = 0;
      analysisSection.style.display = 'block';
      const level = data.finalLevel || 'ERROR';
      finalLevelText.textContent = level;
      finalLevelText.className = `level-${level}`;
      // store session
      saveSession({
        level,
        hr: hr > 0 ? Math.round(hr) : '--',
        spo2: spo2 > 0 ? Math.round(spo2) : '--',
        gsr: gsr > 0 ? Math.round(gsr) : '--',
        date: new Date().toLocaleString('en-IN'),
        name: nameInput.value || '‚Äî',
        age: ageInput.value || '‚Äî'
      });
      renderStaticSuggestions(level);
    }

    // --- Detect flat/unchanging SpO2 (e.g., device reading default 85) ---
    detectFlatSpO2(spo2Raw);

  } catch (err) {
    console.error('Parse Err:', jsonString, err);
  }
}

/* Detect flat spO2 repeating default (often 85 when no pulse) */
function detectFlatSpO2(spo2Raw){
  if (typeof spo2Raw !== 'number') return;
  if (spo2Raw === spLast){
    spFlatCount++;
  } else {
    spFlatCount = 0;
    spLast = spo2Raw;
  }

  if (spFlatCount >= SP_FLAT_LIMIT){
    // show diagnostic to user
    suggestList.innerHTML = `<li>‚ö†Ô∏è SpO‚ÇÇ is not varying ‚Äî the sensor may not be detecting pulse. Please:
      <ul style="margin:6px 0 0 16px">
        <li>Adjust finger placement (fully cover sensor, moderate pressure).</li>
        <li>Reduce ambient light or cover the sensor with your finger/housing.</li>
        <li>Try warming the finger if cold.</li>
      </ul>
    </li>`;
    // attempt a gentle "recalibrate" hint: write suggestion to device if available
    try {
      if (commandCharacteristic){
        const cmd = JSON.stringify({ action: 'recalibrate', hint: 'increase_ir' });
        commandCharacteristic.writeValue(textEncoder.encode(cmd)).catch(()=>{/*non-fatal*/});
      }
    } catch(e){ /*ignore*/ }
  }
}

/* --- Static local suggestions (no external AI) --- */
const staticSuggestions = {
  LOW: [
    "üòå You're calm. Keep the good habits ‚Äî hydrate and take breaks.",
    "üßò Try a 3‚Äì5 minute mindful breathing routine."
  ],
  MODERATE: [
    "‚ö† Slight stress detected. Try 4-4-6 breathing for 3 cycles.",
    "üö∂ Take a short break ‚Äî stand and stretch for 2 minutes."
  ],
  HIGH: [
    "üõë High stress detected. Pause and focus on breathing ‚Äî 4s inhale, 6s exhale.",
    "üó£ If feelings persist, contact someone you trust or a professional."
  ]
};

function renderStaticSuggestions(level){
  suggestList.innerHTML = '';
  const arr = staticSuggestions[level] || staticSuggestions.MODERATE;
  arr.forEach(s => {
    const li = document.createElement('li'); li.innerHTML = s; suggestList.appendChild(li);
  });
}

/* --- Session history localStorage --- */
function saveSession(sessionData){
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  history.unshift(sessionData);
  if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderHistory();
}
function renderHistory(){
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  if (!history.length){
    historyList.innerHTML = `<li style="text-align:center;color:var(--text-body);padding:16px">No sessions recorded yet.</li>`; return;
  }
  historyList.innerHTML = history.map(h => `
    <li class="history-item">
      <div style="flex:1"><div class="label">${h.name || '‚Äî'}</div><div class="muted" style="font-size:12px">${h.date}</div></div>
      <div style="min-width:70px;text-align:right"><div class="label">${h.level}</div><div class="muted" style="font-size:12px">HR:${h.hr}</div></div>
    </li>
  `).join('');
}
resetHistoryBtn.addEventListener('click', ()=>{ localStorage.removeItem(HISTORY_KEY); renderHistory(); });
renderHistory();

/* --- Breathing exercise (smooth) --- */
let breathInterval = null;
let breathRunning = false;
function startBreathing(cycles = 6, inhale = 3, hold = 0, exhale = 4){
  stopBreathing();
  let step = 0; // 0 inhale, 1 hold, 2 exhale
  let cycleCount = 0;
  breathRunning = true;
  breathCircle.style.transition = `transform ${inhale}s cubic-bezier(.2,.9,.3,1), opacity .2s`;
  breathCircle.textContent = 'Inhale';
  breathCircle.style.transform = 'scale(1)';
  breathCyclesLabel.textContent = cycles;
  breathDesc.textContent = `Follow the circle for ${cycles} cycles`;

  breathInterval = setTimeout(function loop(){
    if (!breathRunning) return;
    if (step === 0){
      // after inhale -> hold
      if (hold > 0){
        breathCircle.textContent = 'Hold';
        breathCircle.style.transition = `transform ${hold}s linear`;
        step = 1;
        breathInterval = setTimeout(loop, hold*1000);
      } else {
        // skip hold, go to exhale
        step = 2;
        breathCircle.textContent = 'Exhale';
        breathCircle.style.transition = `transform ${exhale}s ease-out`;
        breathCircle.style.transform = 'scale(.6)';
        breathInterval = setTimeout(loop, exhale*1000);
      }
    } else if (step === 1){
      step = 2;
      breathCircle.textContent = 'Exhale';
      breathCircle.style.transition = `transform ${exhale}s ease-out`;
      breathCircle.style.transform = 'scale(.6)';
      breathInterval = setTimeout(loop, exhale*1000);
    } else if (step === 2){
      cycleCount++;
      if (cycleCount >= cycles){ stopBreathing(); return; }
      // start inhale
      step = 0;
      breathCircle.textContent = 'Inhale';
      breathCircle.style.transition = `transform ${inhale}s cubic-bezier(.2,.9,.3,1)`;
      breathCircle.style.transform = 'scale(1)';
      breathInterval = setTimeout(loop, inhale*1000);
    }
  }, inhale*1000);
}

function stopBreathing(){
  if (breathInterval) clearTimeout(breathInterval);
  breathInterval = null;
  breathRunning = false;
  breathCircle.style.transform = 'scale(.6)';
  breathCircle.textContent = 'Stopped';
}

/* breathing modal controls */
openBreathBtn.addEventListener('click', ()=> {
  breatherModal.classList.add('active');
});
closeBreatherModal.addEventListener('click', ()=> { breatherModal.classList.remove('active'); stopBreathing(); });
breathStartBtn.addEventListener('click', ()=> {
  const val = Number(breathSpeed.value);
  if (val === 8) startBreathingSession(6); // slow
  else if (val === 6) startBreathingSession(6,3,0,4);
  else startBreathingSession(8,2,0,3);
});
breathStopBtn.addEventListener('click', ()=> { stopBreathing(); });

function startBreathingSession(cycles=6, inhale=3, hold=0, exhale=4){
  breathCyclesLabel.textContent = cycles;
  breathCircle.style.transform = 'scale(.6)';
  // nicer defaults
  startBreathing(cycles, inhale, hold, exhale);
}

/* --- SOS modal --- */
sosBtn.addEventListener('click', ()=> sosModal.classList.add('active'));
closeSosModal.addEventListener('click', ()=> sosModal.classList.remove('active'));

/* --- Name/age persistence (optional) --- */
function loadProfile(){
  const p = JSON.parse(localStorage.getItem('nw_profile') || '{}');
  if (p.name) nameInput.value = p.name;
  if (p.age) ageInput.value = p.age;
}
function saveProfile(){
  const p = { name: nameInput.value || '', age: ageInput.value || '' };
  localStorage.setItem('nw_profile', JSON.stringify(p));
}
[nameInput, ageInput].forEach(el => el.addEventListener('change', saveProfile));
loadProfile();

/* --- Chart show/hide toggle --- */
chartToggle.addEventListener('change', ()=> {
  // when turned on, update charts to current buffers
  if (chartToggle.checked){
    // push recent buffer values into charts to show data
    HR_BUFFER.slice(-10).forEach(v=>updateChart(hrChart, v));
    SP_BUFFER.slice(-10).forEach(v=>updateChart(spChart, v));
    GSR_BUFFER.slice(-10).forEach(v=>updateChart(gsrChart, v));
  }
});

/* initialize charts on load */
window.addEventListener('load', ()=> {
  createCharts();
});

/* Helpful: prevent empty UI on initial load */
document.addEventListener('DOMContentLoaded', ()=> {
  renderHistory();
});

/* --- small polyfills / helpers could go here if needed --- */
</script>
</body>
</html>
