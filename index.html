<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NeuroWell 2.0 (AI & Emergency)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /*
     * ========================================
     * STYLING WITH LIGHT/DARK MODE
     * ========================================
     */
     
    /* 1. DEFAULT DARK MODE (as :root) */
    :root {
      --bg: #020617; /* Dark Navy Blue */
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-border: rgba(255, 255, 255, 0.1);
      --text: #e2e8f0;
      --text-body: #94a3b8;
      --text-muted: #94a3b8;
      --input-bg: rgba(0, 0, 0, 0.2);
      
      --accent: #22d3ee; /* Cyan */
      --good: #4ade80;
      --warn: #facc15;
      --bad: #f87171;
    }

    /* 2. LIGHT MODE (activated by class on <body>) */
    body.light-mode {
      --bg: #f0f2f5; /* Light grayish-blue (not white) */
      --card-bg: rgba(255, 255, 255, 0.7);
      --card-border: rgba(0, 0, 0, 0.1);
      --text: #1e293b; /* Dark Slate */
      --text-body: #334155; /* Medium Slate */
      --text-muted: #64748b; /* Light Slate */
      --input-bg: rgba(255, 255, 255, 0.5);

      --accent: #0891b2; /* Darker Cyan */
      /* --good, --warn, --bad can stay the same */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-body);
      background-image: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.15), transparent 50%),
                        radial-gradient(circle at 80% 90%, rgba(139, 92, 246, 0.1), transparent 50%);
      background-attachment: fixed;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* Hide light-mode background gradients */
    body.light-mode {
        background-image: none;
    }

    .wrap {
      max-width: 1200px;
      margin: 16px auto;
      padding: 0 16px;
    }

    /* Main Dashboard Grid */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    @media (min-width: 1024px) {
      .dashboard {
        grid-template-columns: 2fr 1fr;
      }
      .wrap {
        margin: 24px auto;
        padding: 0 24px;
      }
    }
    .main-col, .side-col {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Glassmorphism Card Style */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      box-shadow: 0 8px 32px rgba(2, 6, 23, 0.3);
      transition: all 0.3s ease;
    }
    
    body.light-mode .card {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: var(--text);
    }

    /* Config & Connect */
    .config-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    .config-grid-span {
      grid-column: 1 / -1;
    }
    .temp-group {
      display: flex;
      gap: 12px;
    }
    .temp-group input { flex-grow: 1; }

    label {
      display: block;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    input[type=number], button {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
    }
    /* Fix for number input spin buttons */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    
    button {
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      border: none;
    }
    button.primary {
      background: var(--accent);
      color: var(--bg);
      box-shadow: 0 4px 20px rgba(34, 211, 238, 0.2);
    }
    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(34, 211, 238, 0.3);
    }
    button.secondary {
      background: #334155;
      color: var(--text);
    }
    body.light-mode button.secondary {
        background: #e2e8f0;
        color: #334155;
    }
    button.secondary:hover { background: #475569; }
    body.light-mode button.secondary:hover { background: #cbd5e1; }
    
    button.sos {
      background: var(--bad);
      color: #fff; /* Always white text on red */
      font-weight: 700;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      width: auto;
    }
    button:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Theme Toggle Button */
    .theme-toggle {
        background: var(--input-bg);
        border: 1px solid var(--card-border);
        width: 44px; /* Fixed width */
        height: 44px; /* Fixed height */
        padding: 10px;
        border-radius: 10px;
    }
    .theme-toggle:hover {
        background: var(--card-border);
    }
    .theme-toggle svg {
        stroke: var(--text-muted);
    }
    /* Logic to show/hide icons */
    .theme-toggle #theme-icon-moon { display: none; }
    body.light-mode .theme-toggle #theme-icon-sun { display: none; }
    body.light-mode .theme-toggle #theme-icon-moon { display: inline-block; }


    /* Vitals Card */
    .vitals-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    @media (min-width: 640px) {
      .vitals-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .vital {
      text-align: center;
      background: rgba(0, 0, 0, 0.15);
      padding: 20px;
      border-radius: 12px;
    }
    body.light-mode .vital {
        background: #f8fafc;
        border: 1px solid var(--card-border);
    }
    .vital-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .vital-value {
      font-size: clamp(32px, 5vw, 40px);
      font-weight: 800;
      color: var(--text);
      line-height: 1;
    }
    .vital-value span { font-size: 18px; font-weight: 500; color: var(--text-muted); margin-left: 4px; }

    /* Animated Heart Icon */
    .heart-icon {
      width: 24px;
      height: 24px;
      fill: var(--bad);
      stroke: var(--bad);
      animation: beat 1s infinite ease-in-out;
    }
    @keyframes beat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    /* Status Card */
    .status-box {
      background: rgba(0, 0, 0, 0.15);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    body.light-mode .status-box {
        background: #f8fafc;
        border: 1px solid var(--card-border);
    }
    .status-box #statusText {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 1px;
    }
    .status-box #count {
      font-size: clamp(48px, 10vw, 64px);
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
    }
    .status-box #count span {
      font-size: 20px;
      font-weight: 500;
      color: var(--text-muted);
    }

    /* Result Card */
    #finalLevel {
      font-size: 32px;
      font-weight: 800;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      color: #000;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .level-LOW { background: linear-gradient(90deg, var(--good), #86efac); }
    .level-MODERATE { background: linear-gradient(90deg, var(--warn), #fde047); }
    .level-HIGH { background: linear-gradient(90deg, var(--bad), #fca5a5); }
    
    body.light-mode #finalLevel {
        color: var(--text);
        text-shadow: none;
    }
    body.light-mode .level-LOW { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    body.light-mode .level-MODERATE { background: #fefce8; color: #854d0e; border: 1px solid #fde047; }
    body.light-mode .level-HIGH { background: #ffe4e6; color: #9f1239; border: 1px solid #fca5a5; }

    #suggestList {
      padding-left: 20px;
    }
    #suggestList li {
      background: rgba(0, 0, 0, 0.15);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-body);
    }
    body.light-mode #suggestList li {
        background: #f8fafc;
        border: 1px solid var(--card-border);
    }
    #suggestList li strong { color: var(--accent); }

    /* Breathing Pacemaker */
    .breather-circle {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, var(--accent), #818cf8);
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: var(--bg);
      font-size: 20px;
      font-weight: 600;
      animation: breathe 10s infinite ease-in-out;
      animation-play-state: paused;
      margin: 20px auto 15px auto;
    }
    .breather-text {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-body);
      text-align: center;
      height: 40px;
    }
    .breather-timer {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      text-align: center;
      margin-top: 10px;
    }
    @keyframes breathe {
      0%   { transform: scale(0.6); opacity: 0.7; }
      50%  { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.6); opacity: 0.7; }
    }

    /* History List */
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .history-item {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 16px;
      padding: 12px 0;
      border-bottom: 1px solid var(--card-border);
      font-size: 14px;
    }
    .history-item:last-child { border: none; }
    .history-item span { font-weight: 600; color: var(--text); }
    .history-level-LOW { color: var(--good); }
    .history-level-MODERATE { color: var(--warn); }
    .history-level-HIGH { color: var(--bad); }

    .history-item-date {
      grid-column: 1 / -1;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }

    @media (min-width: 640px) {
      .history-item {
        grid-template-columns: 1fr 1fr 1fr 1fr;
        align-items: center;
      }
      .history-item-date {
        grid-column: auto;
        margin-top: 0;
        font-size: 14px;
        color: var(--text-muted);
      }
    }

    /* Modal Styling */
    .modal-overlay {
      position: fixed;
      z-index: 100;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    body.light-mode .modal-overlay {
        background: rgba(240, 242, 245, 0.6); /* Light bg for overlay */
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: all 0.3s ease;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1);
    }
    .modal-content .card-title {
      border-bottom: 1px solid var(--card-border);
      padding-bottom: 15px;
    }
    .helpline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--card-border);
    }
    .helpline:last-child { border: none; }
    .helpline-name { font-weight: 600; color: var(--text-body); }
    .helpline-number {
      font-weight: 700;
      font-size: 18px;
      color: var(--accent);
    }

    /* Article List */
    .article-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .article-item a {
      display: block;
      background: rgba(0, 0, 0, 0.15);
      padding: 16px;
      border-radius: 12px;
      text-decoration: none;
      color: var(--text-body);
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }
    body.light-mode .article-item a {
        background: #f8fafc;
        border: 1px solid var(--card-border);
    }
    .article-item a:hover {
      border-color: var(--card-border);
      background: rgba(0, 0, 0, 0.25);
      transform: translateY(-2px);
    }
    body.light-mode .article-item a:hover {
        border-color: var(--accent);
        background: #fff;
    }
    .article-item a strong {
      color: var(--text);
      font-weight: 600;
      font-size: 16px;
      display: block;
      margin-bottom: 4px;
    }
    .article-item a p {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }

  </style>
</head>
<body>

  <div class="wrap">

    <header class="card">
      <h1 style="display: flex; align-items: center; gap: 12px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit"><path d="M12 5a3 3 0 1 0-5.997.001A3 3 0 0 0 12 5zm0 14a3 3 0 1 0-5.997.001A3 3 0 0 0 12 19zm0-7a3 3 0 1 0 5.997-.001A3 3 0 0 0 12 12zm0 0V5m0 7v7m0-7h7.5m-7.5 7H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2.5"/><path d="M5 12h2.5m14 0h-7.5"/><path d="M9 19v-2.34a2.26 2.26 0 0 1 .9-1.8L12 13l-2.1-1.86a2.26 2.26 0 0 1-.9-1.8V7"/></svg>
        NeuroWell 2.0
      </h1>
      <div style="display: flex; align-items: center; gap: 15px;">
        <div id="bleStatus" style="color: var(--text-muted); font-weight: 500;">
          Status: <span style="color: var(--bad); font-weight: 600;">Disconnected</span>
        </div>
        <button id="themeToggleBtn" class="theme-toggle" title="Toggle theme">
          <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 18.36l1.42-1.42M18.36 4.22l1.42-1.42"/></svg>
          <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </button>
        <button id="sosBtn" class="sos">SOS</button>
      </div>
    </header>

    <div class="dashboard">

      <div class="main-col">

        <div class="card">
          <div class="config-grid">
            <div class="config-grid-span">
              <label for="roomTemp">Room Temperature (¬∞C)</label>
              <div class="temp-group">
                <input id="roomTemp" type="number" min="10" max="45" value="30">
                <button id="getLocationBtn" class="secondary" title="Use my location">üìç</button>
              </div>
            </div>

            <div class="config-grid-span">
              <button id="startBtn" class="primary">Connect & Start Test</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="vitals-grid">
            <div class="vital">
              <div class="vital-label">
                <svg class="heart-icon" id="heartIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="var(--bad)" stroke="var(--bad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                Heart Rate
              </div>
              <div id="valHR" class="vital-value">--<span>bpm</span></div>
            </div>
            <div class="vital">
              <div class="vital-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h3l3-9 3 18 3-9h3"/><path d="M19 10a2 2 0 1 1 0 4 2 2 0 0 1 0-4Z"/></svg>
                SpO‚ÇÇ
              </div>
              <div id="valSp" class="vital-value">--<span>%</span></div>
            </div>
            <div class="vital">
              <div class="vital-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                GSR (Avg)
              </div>
              <div id="valGSR" class="vital-value">--</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Live Sensor Data</div>
          <div style="height: 250px;">
            <canvas id="hrChart"></canvas>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div style="height: 200px;"><canvas id="spChart"></canvas></div>
            <div style="height: 200px;"><canvas id="gsrChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="side-col">

        <div class="card" id="status-analysis-card">
          <div class="card-title">Status</div>
          <div class="status-box">
            <div id="statusText">IDLE</div>
            <div id="count">0<span>s</span></div>
          </div>

          <div id="analysis-section" style="display: none; margin-top: 24px;">
            <div class="card-title" style="padding-bottom: 0; margin-bottom: 20px;">Analysis & AI Suggestions</div>
            <div id="finalLevel" class="">--</div>
            <ol id="suggestList"></ol>
          </div>
        </div>
        
        <div class="card">
          <div class="card-title">Wellness Library</div>
          <ul class="article-list">
            <li class="article-item">
              <a href="https://www.who.int/news-room/feature-stories/detail/stress-and-your-health" target="_blank" rel="noopener">
                <strong>Understanding Stress</strong>
                <p>Learn about the 'fight or flight' response (WHO).</p>
              </a>
            </li>
            <li class="article-item">
              <a href="https://www.healthline.com/health/breathing-exercises-for-anxiety" target="_blank" rel="noopener">
                <strong>Mindful Breathing</strong>
                <p>Simple breathing exercises to try now.</p>
              </a>
            </li>
            <li class="article-item">
              <a href="https://www.sleepfoundation.org/mental-health" target="_blank" rel="noopener">
                <strong>The Power of Sleep</strong>
                <p>How better sleep improves mental health.</p>
              </a>
            </li>
          </ul>
        </div>

      </div>
    </div>

    <div class="card" style="margin-top: 24px;">
      <div class="card-title">Session History (Last 10)</div>
      <ul class="history-list" id="history-list">
      </ul>
    </div>

  </div>

  <div class="modal-overlay" id="sos-modal">
    <div class="modal-content card">
      <div class="card-title">
        Emergency Helplines (India)
        <button id="close-sos-modal" style="width: auto; padding: 5px 10px; font-weight: 700;">X</button>
      </div>
      <div class="helpline-list">
        <div class="helpline">
          <div class="helpline-name">Ambulance</div>
          <div class="helpline-number">102 / 108</div>
        </div>
        <div class="helpline">
          <div class="helpline-name">Police</div>
          <div class="helpline-number">100 / 112</div>
        </div>
        <div class="helpline">
          <div class="helpline-name">National Mental Health</div>
          <div class="helpline-number">1800-599-0019</div>
        </div>
        <div class="helpline">
          <div class="helpline-name">KIRAN (Mental Health)</div>
          <div class="helpline-number">1800-599-0019</div>
        </div>
        <div class="helpline">
          <div class="helpline-name">Senior Citizen Helpline</div>
          <div class="helpline-number">14567</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="breather-modal">
    <div class="modal-content card">
      <div class="card-title">
        Calming Exercise
        <button id="close-breather-modal" style="width: auto; padding: 5px 10px; font-weight: 700;">X</button>
      </div>
      <div class="breather">
        <div class="breather-circle" id="breather-circle-text">Inhale...</div>
        <div class="breather-text" id="breather-text">Follow the circle for 1 minute.</div>
        <div class="breather-timer" id="breather-timer">60s</div>
      </div>
    </div>
  </div>


<script>
/*
 * ========================================
 * JAVASCRIPT
 * ========================================
*/

// --- BLE UUIDs (Must match ESP32) ---
const SERVICE_UUID    = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_DATA_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_COMMAND_UUID = "a88a02e0-8422-42b0-a555-5203361a832a";

// --- Gemini API URL (Uses v1beta) ---
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
const API_KEY = ""; // No key needed when run in this environment

// --- Global BLE Objects ---
let bleDevice = null;
let gattServer = null;
let dataCharacteristic = null;
let commandCharacteristic = null;
const textDecoder = new TextDecoder('utf-8');
const textEncoder = new TextEncoder();

// --- UI Elements ---
const startBtn = document.getElementById('startBtn');
const bleStatusText = document.getElementById('bleStatus');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('count');
const analysisSection = document.getElementById('analysis-section');
const finalLevelText = document.getElementById('finalLevel');
const valHR = document.getElementById('valHR');
const valSp = document.getElementById('valSp');
const valGSR = document.getElementById('valGSR');
const suggestList = document.getElementById('suggestList');
const heartIcon = document.getElementById('heartIcon');
const historyList = document.getElementById('history-list');
const getLocationBtn = document.getElementById('getLocationBtn');
const roomTempInput = document.getElementById('roomTemp');
const themeToggleBtn = document.getElementById('themeToggleBtn');
const sunIcon = document.getElementById('theme-icon-sun');
const moonIcon = document.getElementById('theme-icon-moon');

// Modal Elements
const sosBtn = document.getElementById('sosBtn');
const sosModal = document.getElementById('sos-modal');
const closeSosModal = document.getElementById('close-sos-modal');
const breatherModal = document.getElementById('breather-modal');
const closeBreatherModal = document.getElementById('close-breather-modal');
const breatherCircle = document.getElementById('breather-circle-text');
const breatherCircleText = document.getElementById('breather-circle-text');
const breatherText = document.getElementById('breather-text');
const breatherTimer = document.getElementById('breather-timer');

// --- Fallback Suggestions ---
const staticSuggestions = {
  LOW: [
    "üòå **You're in a calm state.** Great job! Keep up the mindful practices.",
    "üíß **Stay hydrated.** Even mild dehydration can affect your mood. Grab some water.",
    "üßò **Maintain good posture.** Sit up straight, relax your shoulders. It makes a difference.",
    "üö∂‚Äç‚ôÇÔ∏è **Take a short walk.** A 5-10 minute walk can help maintain this positive state.",
    "üé∂ **Listen to music.** Put on a favorite relaxing song."
  ],
  MODERATE: [
    "‚ö†Ô∏è **Slightly elevated stress.** Let's try to manage this before it builds up.",
    "üí® **Try 4-7-8 Breathing:** Inhale for 4s, hold for 7s, exhale slowly for 8s. Repeat 3 times.",
    "ü§∏‚Äç‚ôÄÔ∏è **Stretch it out.** Roll your neck and shoulders. Stand up and touch your toes.",
    "üéß **Listen to calming music.** Put on a favorite playlist or some ambient sounds for 5 minutes.",
    "üå≥ **Look at nature.** If you can, look out the window at a tree or the sky. It helps."
  ],
  HIGH: [
    "üõë **High stress detected.** Please pause what you're doing. Your well-being is the priority.",
    "üå¨Ô∏è **Focus on your breath.** Try to slow your breathing. Inhale for 4s, exhale for 6s.",
    "üßä **Ground yourself (5-4-3-2-1):** Name 5 things you see, 4 things you feel, 3 you hear, 2 you smell, 1 you taste.",
    "üèÉ‚Äç‚ôÇÔ∏è **Change your environment.** If possible, step outside or go to a different room for a few minutes.",
    "üó£Ô∏è **Talk to someone.** If this feeling persists, please reach out to a friend or family member."
  ]
};

// --- Chart.js Setup ---
const MAX_CHART_POINTS = 30;
let hrChart, spChart, gsrChart;

function createCharts() {
  const chartConfig = (label, color) => ({
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: label,
        data: [],
        borderColor: color,
        borderWidth: 4,
        pointRadius: 0,
        tension: 0.4,
        fill: true,
        backgroundColor: (ctx) => {
          const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, ctx.chart.height);
          gradient.addColorStop(0, `${color}80`);
          gradient.addColorStop(1, `${color}10`);
          return gradient;
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500, easing: 'easeOutQuart' },
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false, grid: { display: false } },
        y: {
          display: true,
          ticks: { color: 'var(--text-muted)' }, // Uses CSS variable
          grid: { color: 'var(--card-border)' }  // Uses CSS variable
        }
      }
    }
  });

  hrChart = new Chart(document.getElementById('hrChart'), chartConfig('Heart Rate', 'var(--bad)'));
  spChart = new Chart(document.getElementById('spChart'), chartConfig('SpO2', 'var(--accent)'));
  gsrChart = new Chart(document.getElementById('gsrChart'), chartConfig('GSR', 'var(--warn)'));

  spChart.options.scales.y.min = 85;
  spChart.options.scales.y.max = 100;
}

// *** MODIFIED ***
// Allows 0 values to be plotted, but filters out undefined/null/-1
function updateChart(chart, value) {
  if (!chart || value === undefined || value === null || value === -1) {
      return; // Do not plot invalid data
  }
  
  chart.data.labels.push('');
  chart.data.datasets[0].data.push(value);

  if (chart.data.labels.length > MAX_CHART_POINTS) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update('none');
}

// --- Weather API Logic ---
getLocationBtn.addEventListener('click', () => {
  if (navigator.geolocation) {
    getLocationBtn.disabled = true;
    getLocationBtn.textContent = '...';
    navigator.geolocation.getCurrentPosition(fetchWeather, handleLocationError);
  } else {
    alert("Geolocation is not supported by this browser.");
  }
});

async function fetchWeather(position) {
  const { latitude, longitude } = position.coords;
  const weatherApiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;

  try {
    const response = await fetch(weatherApiUrl);
    const data = await response.json();
    if (data.current_weather && data.current_weather.temperature) {
      roomTempInput.value = Math.round(data.current_weather.temperature);
    }
  } catch (error) {
    console.error("Error fetching weather:", error);
  } finally {
    getLocationBtn.disabled = false;
    getLocationBtn.textContent = 'üìç';
  }
}

function handleLocationError(error) {
  console.error("Error getting location:", error.message);
  alert(`Error: ${error.message}. Please enter temperature manually.`);
  getLocationBtn.disabled = false;
  getLocationBtn.textContent = 'üìç';
}


// --- Web Bluetooth Logic ---
startBtn.addEventListener('click', async () => {
  startBtn.disabled = true;

  try {
    if (!bleDevice || !bleDevice.gatt.connected) {
      setBLEStatus('Requesting device...', 'var(--warn)');
      statusText.textContent = 'CONNECTING';

      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }],
        optionalServices: [SERVICE_UUID]
      });

      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      setBLEStatus('Connecting to device...', 'var(--warn)');
      gattServer = await bleDevice.gatt.connect();

      setBLEStatus('Getting Service...', 'var(--warn)');
      const service = await gattServer.getPrimaryService(SERVICE_UUID);

      setBLEStatus('Getting Characteristics...', 'var(--warn)');
      dataCharacteristic = await service.getCharacteristic(CHAR_DATA_UUID);
      commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID);

      await dataCharacteristic.startNotifications();
      dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotification);

      setBLEStatus('Connected', 'var(--good)');
      startBtn.textContent = 'Start 40s Test';
    }

    statusText.textContent = 'STARTING';
    const temp = parseInt(roomTempInput.value || '30');

    let irThr = 20000; 
    if (temp < 20) { irThr = 15000; }
    else if (temp >= 28) { irThr = 25000; }

    analysisSection.style.display = 'none';
    finalLevelText.textContent = '--';
    finalLevelText.className = '';
    suggestList.innerHTML = '';

    [hrChart, spChart, gsrChart].forEach(chart => {
      if (chart) {
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.update();
      }
    });

    const command = JSON.stringify({ roomTemp: temp, irThreshold: irThr });
    await commandCharacteristic.writeValue(textEncoder.encode(command));

    statusText.textContent = 'MEASURING';

  } catch (error) {
    console.error('BLE Error:', error);
    setBLEStatus(`Error: ${error.name}`, 'var(--bad)');
    if (bleDevice) bleDevice.gatt.disconnect();
  } finally {
    startBtn.disabled = false;
  }
});

// *** MODIFIED ***
// Main data handler with debugging
function handleDataNotification(event) {
  const jsonString = textDecoder.decode(event.target.value);

  try {
    const data = JSON.parse(jsonString);

    // *** IMPORTANT DEBUGGING STEP ***
    // Open the console (F12) to see what your ESP32 is sending.
    // The keys (like "hr", "spo2", "gsr", "status") MUST match.
    console.log("Received data object from ESP32:", data);
    
    // Safer assignments: use 'undefined' check
    const hr = data.hr !== undefined ? data.hr : 0;
    const spo2 = data.spo2 !== undefined ? data.spo2 : -1;
    const gsr = data.gsr !== undefined ? data.gsr : 0;
    const status = data.status; // Get status

    // Update text values
    valHR.textContent = hr > 0 ? hr.toFixed(0) : '--';
    valSp.textContent = spo2 > 0 ? spo2 : '--';
    valGSR.textContent = gsr > 0 ? gsr.toFixed(0) : '--';

    // Animate heart
    if (hr > 40) {
      heartIcon.style.animationDuration = `${(60 / hr).toFixed(2)}s`;
    }

    // Update charts
    updateChart(hrChart, hr);
    updateChart(spChart, spo2);
    updateChart(gsrChart, gsr);

    statusText.textContent = status || 'UNKNOWN';

    // Check status from the data object
    if (status === "MEASURING") {
      countText.textContent = data.timeLeft ? Math.ceil(data.timeLeft / 1000) : '0';
      analysisSection.style.display = 'none';
    }
    
    // Check if status is "DONE" to save history
    if (status === "DONE") {
      console.log("Session 'DONE'. Saving history..."); // Debug log
      countText.textContent = 0;
      analysisSection.style.display = 'block';
      const level = data.finalLevel || 'ERROR';
      finalLevelText.textContent = level;
      finalLevelText.className = `level-${level}`;

      getAISuggestions(level, data.hr, data.spo2, data.gsr, parseInt(roomTempInput.value || '30'));

      saveSession({
        level: level,
        hr: data.hr.toFixed(0),
        spo2: data.spo2,
        gsr: data.gsr.toFixed(0),
        date: new Date().toLocaleString('en-IN')
      });
    }

  } catch (error) {
    console.error('Error parsing JSON from ESP32. Raw string:', jsonString, error);
  }
}

// --- Gemini AI Suggestions ---
async function getAISuggestions(level, hr, spo2, gsr, temp) {
  suggestList.innerHTML = `<li>üß† Analyzing results and generating personalized AI suggestions...</li>`;

  const systemPrompt = `You are an empathetic and professional wellness assistant. A user has just completed a stress test. Their results are provided.
You MUST:
1.  Briefly (1-2 sentences) analyze their stress level in a reassuring tone.
2.  Provide 3-4 concise, actionable, and encouraging suggestions with emojis.
3.  Use Google Search to find 2-3 top-rated online counseling or therapy services available in India.
4.  Return the response ONLY in the specified JSON format.`;

  const userPrompt = `My stress test results:
- Stress Level: ${level}
- Avg Heart Rate: ${hr.toFixed(0)} bpm
- Avg SpO2: ${spo2}%
- Avg GSR: ${gsr.toFixed(0)} (raw value)
- Room Temp: ${temp}¬∞C
Please provide analysis, suggestions, and find online therapy resources in India.`;

  const schema = {
    type: "OBJECT",
    properties: {
      "analysis": { "type": "STRING", "description": "A brief, 1-2 sentence analysis of the user's stress level." },
      "suggestions": {
        type: "ARRAY",
        items: { "type": "STRING" },
        description: "A list of 3-4 actionable suggestions with emojis."
      },
      "resources": {
        type: "ARRAY",
        items: {
          type: "OBJECT",
          properties: {
            "name": { "type": "STRING", "description": "The name of the counseling service." },
            "uri": { "type": "STRING", "description": "The website URL for the service." }
          }
        },
        description: "A list of online therapy/counseling resources found via Google Search, available in India."
      }
    },
    required: ["analysis", "suggestions", "resources"]
  };

  const payload = {
    contents: [{ parts: [{ text: userPrompt }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] },
    tools: [{ "google_search": {} }],
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: schema,
      temperature: 0.7
    }
  };

  try {
    const response = await fetchWithBackoff(API_URL + API_KEY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

    const result = await response.json();
    const candidate = result.candidates?.[0];

    if (candidate && candidate.content?.parts?.[0]?.text) {
      const jsonText = candidate.content.parts[0].text;
      const aiResponse = JSON.parse(jsonText);
      renderAISuggestions(level, aiResponse);
    } else {
      throw new Error("Invalid AI response structure.");
    }
  } catch (error) {
    console.error("Error getting AI suggestions:", error);
    renderStaticSuggestions(level);
  }
}

function renderAISuggestions(level, response) {
  let html = '';

  if (response.analysis) {
    html += `<li><p>${response.analysis.replace(/\n/g, '<br>')}</p></li>`;
  }
  if (response.suggestions && response.suggestions.length > 0) {
    html += response.suggestions.map(s => `<li>${s}</li>`).join('');
  }
  if (level === 'HIGH' || level === 'MODERATE') {
    html += `<li><button id="open-breather-btn" class="secondary" style="width: 100%; margin-top: 10px;">üßò Start Calming Exercise</button></li>`;
  }
  if (response.resources && response.resources.length > 0) {
    html += `<li><strong>Professional Help Resources (India):</strong></li>`;
    html += response.resources.map(r =>
      `<li>üåê <strong>${r.name}</strong>: <a href="${r.uri}" target="_blank" rel="noopener noreferrer" style="color: var(--accent);">${r.uri}</a></li>`
    ).join('');
  }
  suggestList.innerHTML = html;

  addBreatherButtonListener();
}

function renderStaticSuggestions(level) {
  suggestList.innerHTML = ''; // Start clean
  const suggestions = staticSuggestions[level] || staticSuggestions.MODERATE;
  let html = suggestions.map(s => `<li>${s}</li>`).join('');

  if (level === 'HIGH' || level === 'MODERATE') {
    html += `<li><button id="open-breather-btn" class="secondary" style="width: 100%; margin-top: 10px;">üßò Start Calming Exercise</button></li>`;
  }
  suggestList.innerHTML = html;

  addBreatherButtonListener();
}

function addBreatherButtonListener() {
  const openBreatherBtn = document.getElementById('open-breather-btn');
  if (openBreatherBtn) {
    openBreatherBtn.addEventListener('click', () => {
      breatherModal.classList.add('active');
      startBreatherAnimation();
    });
  }
}

// Utility for retrying fetch
async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
  try {
    const response = await fetch(url, options);
    if (!response.ok && retries > 0 && (response.status === 429 || response.status >= 500)) {
      await new Promise(resolve => setTimeout(resolve, delay));
      return fetchWithBackoff(url, options, retries - 1, delay * 2);
    }
    return response;
  } catch (error) {
    if (retries > 0) {
      await new Promise(resolve => setTimeout(resolve, delay));
      return fetchWithBackoff(url, options, retries - 1, delay * 2);
    }
    throw error;
  }
}

// --- Bluetooth & UI Cleanup ---
function onDisconnected() {
  setBLEStatus('Disconnected', 'var(--bad)');
  statusText.textContent = 'IDLE';
  countText.textContent = '0';
  analysisSection.style.display = 'none';
  bleDevice = null;
  startBtn.textContent = 'Connect & Start Test';
}

function setBLEStatus(message, color) {
  const span = bleStatusText.querySelector('span');
  span.textContent = message;
  span.style.color = color;
}

// --- Breathing Animation ---
let breatherInterval;
let breatherTimerInterval;
let breatherTimeout;

function startBreatherAnimation() {
    if (breatherInterval) clearInterval(breatherInterval);
    if (breatherTimerInterval) clearInterval(breatherTimerInterval);
    if (breatherTimeout) clearTimeout(breatherTimeout);

    let secondsLeft = 60;
    const encouragements = [
        "You're doing great.", "Focus on your breath.", "Let the tension go.",
        "Be present.", "Relax your shoulders.", "Just breathe."
    ];

    breatherCircle.style.animationPlayState = 'running';
    breatherCircleText.textContent = 'Inhale...';
    breatherText.textContent = "Let's reset with this 1-minute exercise.";
    breatherTimer.textContent = `${secondsLeft}s`;

    setTimeout(() => {
         breatherCircleText.textContent = 'Exhale...';
         breatherText.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
    }, 5000); 

    breatherInterval = setInterval(() => {
        breatherCircleText.textContent = 'Inhale...';
        breatherText.textContent = encouragements[Math.floor(Math.random() * encouragements.length)];
        setTimeout(() => {
            breatherCircleText.textContent = 'Exhale...';
        }, 5000); 
    }, 10000); 

    breatherTimerInterval = setInterval(() => {
        secondsLeft--;
        breatherTimer.textContent = `${secondsLeft}s`;
        if (secondsLeft <= 0) {
            clearInterval(breatherTimerInterval);
        }
    }, 1000);

    breatherTimeout = setTimeout(() => {
        stopBreatherAnimation(true); 
    }, 60000);
}

function stopBreatherAnimation(completed = false) {
    if (breatherInterval) clearInterval(breatherInterval);
    if (breatherTimerInterval) clearInterval(breatherTimerInterval);
    if (breatherTimeout) clearTimeout(breatherTimeout);

    breatherCircle.style.animationPlayState = 'paused'; 

    if (completed) {
        breatherCircleText.textContent = 'Done!';
        breatherText.textContent = "Great job. You completed the exercise!";
        breatherTimer.textContent = 'üëç';
        
        setTimeout(() => {
            if (breatherModal.classList.contains('active')) {
                breatherModal.classList.remove('active');
                resetBreather();
            }
        }, 2000);
    } else {
        resetBreather();
    }
}

function resetBreather() {
    breatherCircleText.textContent = 'Inhale...';
    breatherText.textContent = 'Follow the circle for 1 minute.';
    breatherTimer.textContent = '60s';
}
// --- End of Breathing Animation ---


// --- Session History (localStorage) ---
const HISTORY_KEY = 'stressHistory';
const MAX_HISTORY = 10;

function saveSession(sessionData) {
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  history.unshift(sessionData);
  if (history.length > MAX_HISTORY) {
    history = history.slice(0, MAX_HISTORY);
  }
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  if (history.length === 0) {
    historyList.innerHTML = `<li style="color: var(--text-muted); text-align: center; padding: 20px;">No sessions recorded yet.</li>`;
    return;
  }
  historyList.innerHTML = history.map(item => `
    <li class="history-item">
      <div class="history-item-level"><span class="history-level-${item.level}">${item.level}</span></div>
      <div class="history-item-hr">HR: <span>${item.hr}</span></div>
      <div class="history-item-spo2">SpO‚ÇÇ: <span>${item.spo2}%</span></div>
      <div class="history-item-date">${item.date}</div>
    </li>
  `).join('');
}

// --- Theme Toggle Logic ---
themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
    
    // Save preference to localStorage
    const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
    localStorage.setItem('theme', theme);
    
    // Update chart colors (they need to re-read the CSS variables)
    updateChartColors();
});

function applySavedTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
    } else {
        document.body.classList.remove('light-mode');
    }
    // No need to update charts here, createCharts() will run after
}

// Function to update chart colors after theme switch
function updateChartColors() {
    // Get the computed style of the body to find the *current* variable values
    const computedStyle = getComputedStyle(document.body);
    const tickColor = computedStyle.getPropertyValue('--text-muted');
    const gridColor = computedStyle.getPropertyValue('--card-border');

    [hrChart, spChart, gsrChart].forEach(chart => {
        if (chart) {
            chart.options.scales.y.ticks.color = tickColor;
            chart.options.scales.y.grid.color = gridColor;
            chart.update('none'); // 'none' to update without animation
        }
    });
}


// --- Initial Load & Modal Listeners ---
window.addEventListener('load', () => {
  applySavedTheme(); // Apply theme before creating charts
  createCharts();
  renderHistory();
  
  breatherCircle.style.animationPlayState = 'paused';

  // SOS Modal
  sosBtn.addEventListener('click', () => sosModal.classList.add('active'));
  closeSosModal.addEventListener('click', () => sosModal.classList.remove('active'));

  // Breather Modal
  closeBreatherModal.addEventListener('click', () => {
    breatherModal.classList.remove('active');
    stopBreatherAnimation(false);
  });

  // Close modal on overlay click
  [sosModal, breatherModal].forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        if (modal === breatherModal) {
          stopBreatherAnimation(false);
        }
      }
    });
  });
});

</script>
</body>
</html>
