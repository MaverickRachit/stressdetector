<!doctype html>
<html>
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>NeuroWell 2.0 â€” Dashboard (BLE + Gemini + Ambient)</title>

Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

Â  <style>
Â  Â  :root{
Â  Â  Â  --bg: #020617;
Â  Â  Â  --card-bg: rgba(255,255,255,0.05);
Â  Â  Â  --card-border: rgba(255,255,255,0.1);
Â  Â  Â  --text: #e6eef8;
Â  Â  Â  --text-body:#aab7c6;
Â  Â  Â  --accent: #22d3ee;
Â  Â  Â  --good:#4ade80; --warn:#facc15; --bad:#f87171;
Â  Â  Â  --glass: rgba(255,255,255,0.03);
Â  Â  }
Â  Â  .light {
Â  Â  Â  --bg: #f6f8fb;
Â  Â  Â  --card-bg: rgba(255,255,255,0.95);
Â  Â  Â  --card-border: rgba(13,18,25,0.08);
Â  Â  Â  --text: #0b1220;
Â  Â  Â  --text-body:#475569;
Â  Â  Â  --accent: #0ea5b7;
Â  Â  Â  --good:#16a34a; --warn:#d97706; --bad:#dc2626;
Â  Â  Â  --glass: rgba(255,255,255,0.8);
Â  Â  }

Â  Â  *{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  margin:0;
Â  Â  Â  font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
Â  Â  Â  background: radial-gradient(circle at 10% 20%, rgba(34,211,238,0.05), transparent 30%), radial-gradient(circle at 80% 90%, rgba(139,92,246,0.03), transparent 35%), var(--bg);
Â  Â  Â  color:var(--text-body);
Â  Â  Â  -webkit-font-smoothing:antialiased;
Â  Â  Â  -moz-osx-font-smoothing:grayscale;
Â  Â  Â  text-rendering: optimizeLegibility;
Â  Â  Â  font-synthesis: none;
Â  Â  Â  transition: background-color .25s ease, color .25s ease;
Â  Â  Â  padding:14px;
Â  Â  }
Â  Â  @media (max-width: 600px) {
Â  Â  Â  body { padding: 8px; } /* Tighter padding on mobile */
Â  Â  }
Â  Â  .wrap{max-width:1200px;margin:12px auto;padding:0 12px;display:flex;flex-direction:column;gap:16px}

Â  Â  /* --- MODIFICATION: Made header responsive --- */
Â  Â  header.appbar{
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  gap:12px;
Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
Â  Â  Â  border:1px solid var(--card-border); padding:14px;border-radius:12px;backdrop-filter: blur(10px);
Â  Â  Â  flex-wrap: wrap; /* Allow wrapping on medium screens */
Â  Â  }
Â  Â  @media (max-width: 700px) {
Â  Â  Â  header.appbar {
Â  Â  Â  Â  flex-direction: column; /* Stack title and controls */
Â  Â  Â  Â  align-items: flex-start; /* Align title to the left */
Â  Â  Â  }
Â  Â  Â  .controls {
Â  Â  Â  Â  width: 100%; /* Make controls take full width */
Â  Â  Â  Â  justify-content: space-around; /* Space out buttons */
Â  Â  Â  Â  margin-top: 12px;
Â  Â  Â  }
Â  Â  }
Â  Â  /* --- END MODIFICATION --- */
Â  Â Â 
Â  Â  .title {display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text);font-size:18px}
Â  Â  .controls{display:flex;align-items:center;gap:10px;flex-wrap: wrap;justify-content: flex-end;}

Â  Â  .btn {
Â  Â  Â  padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
Â  Â  Â  transition: all .2s ease;
Â  Â  }
Â  Â  .btn:hover { opacity: 0.85; transform: translateY(-2px); }
Â  Â  .btn:active { opacity: 1; transform: translateY(0); }
Â  Â Â 
Â  Â  .btn.primary{
Â  Â  Â  background:var(--accent);color:var(--bg);
Â  Â  Â  box-shadow: 0 4px 22px rgba(34,211,238,0.25);
Â  Â  }
Â  Â  .btn.primary:hover{ box-shadow: 0 6px 26px rgba(34,211,238,0.4); }
Â  Â  .btn.ghost{background:transparent;border:1px solid var(--card-border);color:var(--text-body)}
Â  Â  .btn.sos{background:var(--bad);color:#fff;border-radius:10px;padding:8px 12px}
Â  Â  .btn.small{padding:8px 10px;font-size:12px}

Â  Â  .dashboard{display:grid;grid-template-columns:1fr;gap:16px;margin-top:6px}
Â  Â  @media(min-width:1000px){ .dashboard{grid-template-columns:2fr 1fr} }

Â  Â  .card{
Â  Â  Â  background:var(--card-bg); border-radius:12px; padding:16px; border:1px solid var(--card-border);
Â  Â  Â  box-shadow: 0 10px 30px rgba(2,6,23,0.28);
Â  Â  Â  transition: transform .2s ease, box-shadow .2s ease;
Â  Â  }
Â  Â  .card:hover{Â 
Â  Â  Â  transform:translateY(-4px);
Â  Â  Â  box-shadow: 0 14px 35px rgba(2,6,23,0.35);
Â  Â  }

Â  Â  .config-grid{display:grid;grid-template-columns:1fr 260px;gap:12px;align-items:center}
Â  Â  @media(max-width:640px){ .config-grid{grid-template-columns:1fr; } }
Â  Â  label{display:block;color:var(--text-body);font-size:13px;margin-bottom:6px;font-weight:600}
Â  Â  input[type=number], input[type=text], select {
Â  Â  Â  padding:10px;border-radius:8px;border:1px solid var(--card-border);
Â  Â  Â  background:transparent;color:var(--text);width:100%;transition: border-color .2s ease;
Â  Â  }
Â  Â  input[type=number]:focus, input[type=text]:focus, select:focus { border-color: var(--accent); outline: none; }
Â  Â  select option { background: var(--bg); color: var(--text); }

Â  Â  /* --- MODIFICATION: Made vitals grid responsive --- */
Â  Â  .vitals-grid{
Â  Â  Â  display:grid;
Â  Â  Â  gap:12px;
Â  Â  Â  grid-template-columns: 1fr; /* Mobile-first: 1 column */
Â  Â  }
Â  Â  @media(min-width: 500px){ 
Â  Â  Â  .vitals-grid { grid-template-columns: 1fr 1fr; } /* 2 columns on small tablets */
Â  Â  }
Â  Â  @media(min-width: 760px){ 
Â  Â  Â  .vitals-grid { grid-template-columns: repeat(3, 1fr); } /* 3 columns on desktop */
Â  Â  }
Â  Â  /* --- END MODIFICATION --- */

Â  Â  .vital{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:12px;text-align:center}
Â  Â  .vital-label{font-size:12px;color:var(--text-body);display:flex;align-items:center;gap:8px;justify-content:center;font-weight: 600;}
Â  Â  .vital-value{font-size:40px;font-weight:800;color:var(--text);margin-top:6px}

Â  Â  @keyframes pulse {
Â  Â  Â  0% { transform: scale(1); }
Â  Â  Â  50% { transform: scale(1.15); }
Â  Â  Â  100% { transform: scale(1); }
Â  Â  }
Â  Â  .vital-value.pulsing {
Â  Â  Â  animation: pulse 0.3s ease-out;
Â  Â  }

Â  Â  .chart-wrap{height:140px;background:transparent;border-radius:10px;padding:8px}
Â  Â  canvas{width:100% !important;height:100% !important;display:block}

Â  Â  .status-box{padding:12px;border-radius:10px;text-align:center;background:rgba(0,0,0,0.06)}
Â  Â  #statusText{font-weight:700;color:var(--accent)}
Â  Â  #count{font-size:34px;font-weight:800;color:var(--text);margin-top:8px}

Â  Â  #finalLevel{font-size:22px;font-weight:800;padding:10px;border-radius:10px;text-align:center;color:#000;margin-bottom:12px}
Â  Â  .level-LOW{background:linear-gradient(90deg,var(--good),#86efac)}
Â  Â  .level-MODERATE{background:linear-gradient(90deg,var(--warn),#fde047)}
Â  Â  .level-HIGH{background:linear-gradient(90deg,var(--bad),#fca5a5)}

Â  Â  #overviewText{
Â  Â  Â  font-size: 14px;
Â  Â  Â  color: var(--text);
Â  Â  Â  background: var(--glass);
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  }
Â  Â Â 
Â  Â  #suggestList li{background:var(--glass);padding:10px;margin-bottom:8px;border-radius:8px;color:var(--text-body);list-style:none}
Â  Â  .history-list{list-style:none;padding:0;margin:0;max-height:260px;overflow:auto}
Â  Â  .history-item{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid var(--card-border)}
Â  Â  .muted{color:var(--text-body);font-size:13px}
Â  Â Â 
Â  Â  @keyframes modalPopIn {
Â  Â  Â  from { opacity: 0; transform: scale(0.95); }
Â  Â  Â  to { opacity: 1; transform: scale(1); }
Â  Â  }
Â  Â  .modal-overlay{
Â  Â  Â  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
Â  Â  Â  background:rgba(2,6,23,0.6);z-index:200;backdrop-filter: blur(4px);
Â  Â  Â  opacity: 0; visibility: hidden;
Â  Â  Â  transition: opacity .2s ease, visibility .2s ease;
Â  Â  }
Â  Â  .modal-overlay.active{
Â  Â  Â  display:flex;
Â  Â  Â  opacity: 1; visibility: visible;
Â  Â  }
Â  Â  .modal{
Â  Â  Â  width:92%;max-width:520px;background:var(--card-bg);padding:16px;
Â  Â  Â  border-radius:12px;border:1px solid var(--card-border);
Â  Â  Â  animation: modalPopIn 0.2s ease-out forwards;
Â  Â  }
Â  Â  .modal-overlay:not(.active) .modal {
Â  Â  Â  display: none;
Â  Â  }

Â  Â  .breather-container{text-align:center;padding:18px}
Â  Â Â 
Â  Â  /* --- MODIFICATION: Larger, glowing breath circle --- */
Â  Â  .breath-circle{
Â  Â  Â  width:220px;height:220px; /* Was 160px */
Â  Â  Â  border-radius:50%;display:grid;place-items:center;margin:10px auto;
Â  Â  Â  background:linear-gradient(135deg,var(--accent),#8b5cf6);color:var(--bg);
Â  Â  Â  font-weight:800;
Â  Â  Â  font-size:26px; /* Was 18px */
Â  Â  Â  border:4px solid rgba(255,255,255,0.04);
Â  Â  Â  /* Default (exhaled) state */
Â  Â  Â  transform:scale(.6);
Â  Â  Â  opacity:.9;
Â  Â  Â  box-shadow: 0 0 20px rgba(34,211,238,0.2), 0 0 40px rgba(139,92,246,0.15);
Â  Â  Â  /* Transition will be set by JS to sync inhale/exhale time */
Â  Â  Â  transition: transform 3s ease-in-out, box-shadow 3s ease-in-out; 
Â  Â  }
Â  Â  .breath-circle.inhaling {
Â  Â  Â  /* Inhaled state */
Â  Â  Â  transform: scale(1);
Â  Â  Â  box-shadow: 0 0 35px rgba(34,211,238,0.5), 0 0 60px rgba(139,92,246,0.3);
Â  Â  }
Â  Â  .breath-circle.exhaling {
Â  Â  Â  /* Exhaled state */
Â  Â  Â  transform: scale(0.6);
Â  Â  Â  box-shadow: 0 0 20px rgba(34,211,238,0.2), 0 0 40px rgba(139,92,246,0.15);
Â  Â  }
Â  Â  /* --- END MODIFICATION --- */

Â  Â  .chat-floating{
Â  Â  Â  position:fixed;right:20px;bottom:22px;width:56px;height:56px;border-radius:50%;
Â  Â  Â  display:grid;place-items:center;background:var(--accent);color:var(--bg);z-index:400;cursor:pointer;box-shadow:0 10px 30px rgba(2,6,23,0.4);
Â  Â  Â  transition: all .2s ease;
Â  Â  }
Â  Â  .chat-floating:hover { transform: scale(1.1); box-shadow: 0 12px 35px rgba(34,211,238,0.5); }
Â  Â Â 
Â  Â  .chat-panel{position:fixed;right:20px;bottom:90px;width:360px;max-width:92%;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:12px;z-index:401;display:none;flex-direction:column;gap:8px}
Â  Â  .chat-panel.active{display:flex}
Â  Â  .chat-messages{max-height:300px;overflow:auto;padding:8px;border-radius:8px;background:transparent}
Â  Â  .chat-input{display:flex;gap:8px}

Â  Â  .audio-toggle{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:999px;border:1px solid var(--card-border);cursor:pointer; transition: all .2s ease;}
Â  Â  .audio-toggle:hover { border-color: var(--text-body); color: var(--text); }
Â  Â  .small{font-size:12px}

Â  Â  @keyframes receivingPulse {
Â  Â  Â  0% { color: var(--accent); }
Â  Â  Â  50% { color: var(--good); }
Â  Â  Â  100% { color: var(--accent); }
Â  Â  }
Â  Â  .pulse-receiving {
Â  Â  Â  animation: receivingPulse 0.5s ease-out;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="wrap" id="app">
Â  Â  <header class="appbar card">
Â  Â  Â  <div class="title">
Â  Â  Â  Â  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.001A3 3 0 0 0 12 5zm0 14a3 3 0 1 0-5.997.001A3 3 0 0 0 12 19zm0-7a3 3 0 1 0 5.997-.001A3 3 0 0 0 12 12z"/></svg>
Â  Â  Â  Â  NeuroWell 2.0
Â  Â  Â  </div>

Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <div id="bleStatus" class="muted">Status: <span style="color:var(--bad);font-weight:800" id="bleStatusText">Disconnected</span></div>
Â  Â  Â  Â  <button id="profileBtn" class="btn ghost small">Profile</button>
Â  Â  Â  Â  <button id="resourcesBtn" class="btn ghost small">Resources</button>
Â  Â  Â  Â  <div class="audio-toggle" id="hbToggle" title="Toggle Heartbeat Sound">â¤ï¸ <span id="hbLabel" class="small">HB Off</span></div>
Â  Â  Â  Â  <div class="audio-toggle" id="themeToggle" title="Toggle Light / Dark">ğŸŒ™ <span id="themeLabel" class="small">Dark</span></div>
Â  Â  Â  Â  <button id="sosBtn" class="btn sos">SOS</button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div class="dashboard">
Â  Â  Â  <div class="main-col">

Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div style="display:flex;flex-direction:column;gap:12px">
Â  Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
Â  Â  Â  Â  Â  Â  Â  <div style="min-width:220px">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Room Temperature (Â°C)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="roomTemp" type="number" min="10" max="45" value="30" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="getLocationBtn" class="btn ghost" title="Use my location">ğŸ“</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="startBtn" class="btn primary">Connect & Start Test</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="vitals-grid">
Â  Â  Â  Â  Â  Â  <div class="vital">
Â  Â  Â  Â  Â  Â  Â  <div class="vital-label">ğŸ’“ HEART RATE</div>
Â  Â  Â  Â  Â  Â  Â  <div id="valHR" class="vital-value">-- <span style="font-size:14px;color:var(--text-body);font-weight:600;margin-left:4px;">bpm</span></div>
Â  Â  Â  Â  Â  Â  Â  <div style="height:120px;margin-top:12px" class="chart-wrap"><canvas id="hrChart"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="vital">
Â  Â  Â  Â  Â  Â  Â  <div class="vital-label">ğŸ©¸ SpOâ‚‚</div>
Â  Â  Â  Â  Â  Â  Â  <div id="valSp" class="vital-value">-- <span style="font-size:14px;color:var(--text-body);font-weight:600;margin-left:4px;">%</span></div>
Â  Â  Â  Â  Â  Â  Â  <div style="height:120px;margin-top:12px" class="chart-wrap"><canvas id="spChart"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="vital">
Â  Â  Â  Â  Â  Â  Â  <div class="vital-label">âš¡ GSR</div>
Â  Â  Â  Â  Â  Â  Â  <div id="valGSR" class="vital-value">--</div>
Â  Â  Â  Â  Â  Â  Â  <div style="height:120px;margin-top:12px" class="chart-wrap"><canvas id="gsrChart"></canvas></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  Â  <div style="font-weight:700;color:var(--text)">Live Sensor Stream</div>
Â  Â  Â  Â  Â  Â  <div class="muted">Real-time graphs â€¢ Raw data stream</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
Â  Â  Â  Â  Â  Â  <div style="flex:1;min-width:220px">
Â  Â  Â  Â  Â  Â  Â  <div class="status-box">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="statusText">IDLE</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="count">0<span style="font-size:12px;color:var(--text-body)">s</span></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="min-width:260px">
Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="openBreathBtn" class="btn ghost">ğŸ§˜ Start Calming Exercise</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="resetHistoryBtn" class="btn ghost">Clear History</button>
Â  Â  Â  Â  Â  Â  Â  Â  <label style="display:inline-flex;align-items:center;gap:8px;margin-left:8px"><input id="chartToggle" type="checkbox" checked /> Show charts</label>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  </div>

Â  Â  Â  <div class="side-col">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  Â  <div style="font-weight:700;color:var(--text)">Analysis & Suggestions</div>
Â  Â  Â  Â  Â  Â  <div class="muted">AI-Assisted Suggestions</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="margin-top:12px" id="analysis-section">
Â  Â  Â  Â  Â  Â  <div id="finalLevel" class="">--</div>
Â  Â  Â  Â  Â  Â  <div id="overviewText" style="display:none;"></div>
Â  Â  Â  Â  Â  Â  <ol id="suggestList"></ol>
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px;display:flex;gap:8px">
Â  Â  Â  Â  Â  Â  Â  <button id="askGeminiBtn" class="btn ghost">Ask Gemini for suggestions</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  Â  <div style="font-weight:700;color:var(--text)">Session History (Last 10)</div>
Â  Â  Â  Â  Â  Â  <div class="muted">Saved locally</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <ul class="history-list" id="history-list" style="margin-top:12px"></ul>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="modal-overlay" id="sos-modal"><div class="modal card">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  <div style="font-weight:700">Emergency Helplines (India)</div>
Â  Â  Â  Â  <button id="close-sos-modal" class="btn ghost">X</button>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>Ambulance</div><div style="font-weight:700;color:var(--accent)">102 / 108</div></div>
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>Police</div><div style="font-weight:700;color:var(--accent)">100 / 112</div></div>
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--card-border)"><div>National Mental Health</div><div style="font-weight:700;color:var(--accent)">1800-599-0019</div></div>
Â  Â  Â  </div>
Â  Â  </div></div>

Â  Â  <div class="modal-overlay" id="breather-modal"><div class="modal card">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  <div style="font-weight:700">Calming Exercise</div>
Â  Â  Â  Â  <button id="close-breather-modal" class="btn ghost">X</button>
Â  Â  Â  </div>

Â  Â  Â  <div class="breather-container" style="margin-top:16px">
Â  Â  Â  Â  <div id="breathCircle" class="breath-circle">Inhale</div>
Â  Â  Â  Â  <div id="breathDesc" class="muted">Follow the circle for <span id="breathCycles">6</span> cycles</div>
Â  Â  Â  Â  <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
Â  Â  Â  Â  Â  <button id="breathStartBtn" class="btn primary">Start</button>
Â  Â  Â  Â  Â  <button id="breathStopBtn" class="btn ghost">Stop</button>
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="breathSpeed" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)">
Â  Â  Â  Â  Â  Â  <option value="4,7,8">Slow (4-7-8)</option>
Â  Â  Â  Â  Â  Â  <option value="3,4,6" selected>Normal (3-4-6)</option>
Â  Â  Â  Â  Â  Â  <option value="2,2,3">Fast (2-2-3)</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div></div>
Â  Â Â 
Â  Â  <div class="modal-overlay" id="profile-modal"><div class="modal card">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  <div style="font-weight:700" id="profile-title">Your Profile</div>
Â  Â  Â  Â  <button id="close-profile-modal" class="btn ghost">X</button>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:16px; display:flex; flex-direction:column; gap:12px;">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label style="font-weight:700;color:var(--text);">Name</label>
Â  Â  Â  Â  Â  Â  <input id="userName" placeholder="Enter name" />
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display:flex; gap: 12px;">
Â  Â  Â  Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-weight:700;color:var(--text);">Age</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="userAge" type="number" placeholder="Enter age" />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-weight:700;color:var(--text);">Gender</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="userGender">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="male">Male</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="female">Female</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="other">Other</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  _ <option value="prefer_not_to_say">Prefer not to say</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="muted" id="profileNote" style="margin-top:8px;">This info is used to help calibrate results.</div>
Â  Â  Â  Â  <button id="save-profile-btn" class="btn primary" style="align-self:flex-end">Save & Close</button>
Â  Â  Â  </div>
Â  Â  </div></div>

Â  Â  <div class="modal-overlay" id="resources-modal"><div class="modal card">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  <div style="font-weight:700">Mental Health Resources</div>
Â  Â  Â  Â  <button id="close-resources-modal" class="btn ghost">X</button>
Â  Â  Â  </div>
Â  Â  Â  <div style="margin-top:16px; max-height: 400px; overflow-y: auto;">
Â  Â  Â  Â  <ul id="resources-list" style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;">
Â  Â  Â  Â  Â  <li style="background:var(--glass);padding:12px;border-radius:8px;">
Â  Â  Â  Â  Â  Â  <div style="font-weight:700;color:var(--text)">Understanding Stress vs. Anxiety</div>
Â  Â  Â  Â  Â  Â  <div class="muted" style="font-size:12px; margin-top:4px;">Learn the key differences and how your body responds to each.</div>
Â  Â  Â  Â  Â  Â  <a href="#" onclick="alert('Placeholder: This would link to a real article.')" style="color:var(--accent);font-size:12px;font-weight:700;margin-top:6px;display:inline-block;">Read More</a>
Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </div>
Â  Â  </div></div>

Â  </div>

Â  <div class="chat-floating" id="chatFab" title="Open Gemini Assistant">ğŸ’¬</div>
Â  <div class="chat-panel" id="chatPanel">
Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  <div style="font-weight:800">Gemini Assistant</div>
Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  <button id="closeChatBtn" class="btn ghost">X</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="chat-messages" id="chatMessages">
Â  Â  Â  <div class="muted">Start a conversation â€” Gemini can analyze your last session when you ask.</div>
Â  Â  </div>
Â  Â  <div class="chat-input" style="margin-top:8px">
Â  Â  Â  <input id="chatInput" placeholder="Ask something (e.g., 'Is my stress high?')" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;color:var(--text)" />
Â  Â  Â  <button id="sendChatBtn" class="btn primary">Send</button>
Â  Â  </div>
Â  </div>

<script>
/* =========================
Â  CONFIG / CONSTANTS
Â  ========================= */
const SERVICE_UUIDÂ  Â  = "4fafc201-1fb5-459e-8fcc-c5c9c331914b"; // <-- Lowercase Fixed
const CHAR_DATA_UUIDÂ  Â  = "beb5483e-36e1-4688-b7f5-ea07361b26a8"; // <-- Lowercase Fixed
const CHAR_COMMAND_UUID = "a88a02e0-8422-42b0-a555-5203361a832a";
const TEST_DURATION_S = 40; // Test duration in seconds

const GEMINI_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=";
const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // 
/* ========================= */

let bleDevice = null;
let gattServer = null;
let dataCharacteristic = null;
let commandCharacteristic = null;
const textDecoder = new TextDecoder('utf-8');
const textEncoder = new TextEncoder();

/* UI refs */
const bleStatus = document.getElementById('bleStatus');
const startBtn = document.getElementById('startBtn');
const bleStatusText = document.getElementById('bleStatusText');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('count');
const analysisSection = document.getElementById('analysis-section');
const finalLevelText = document.getElementById('finalLevel');
const overviewText = document.getElementById('overviewText');
const valHR = document.getElementById('valHR');
const valSp = document.getElementById('valSp');
const valGSR = document.getElementById('valGSR');
const suggestList = document.getElementById('suggestList');
const historyList = document.getElementById('history-list');
const getLocationBtn = document.getElementById('getLocationBtn');
const roomTempInput = document.getElementById('roomTemp');

const sosBtn = document.getElementById('sosBtn');
const sosModal = document.getElementById('sos-modal');
const closeSosModal = document.getElementById('close-sos-modal');

const openBreathBtn = document.getElementById('openBreathBtn');
const breatherModal = document.getElementById('breather-modal');
const closeBreatherModal = document.getElementById('close-breather-modal');
const breathCircle = document.getElementById('breathCircle');
const breathDesc = document.getElementById('breathDesc');
const breathStartBtn = document.getElementById('breathStartBtn');
const breathStopBtn = document.getElementById('breathStopBtn');
const breathSpeed = document.getElementById('breathSpeed');
const breathCyclesLabel = document.getElementById('breathCycles');

const profileBtn = document.getElementById('profileBtn');
const profileModal = document.getElementById('profile-modal');
const profileTitle = document.getElementById('profile-title');
const closeProfileModal = document.getElementById('close-profile-modal');
const saveProfileBtn = document.getElementById('save-profile-btn');

const resourcesBtn = document.getElementById('resourcesBtn');
const resourcesModal = document.getElementById('resources-modal');
const closeResourcesModal = document.getElementById('close-resources-modal');

const nameInput = document.getElementById('userName');
const ageInput = document.getElementById('userAge');
const genderInput = document.getElementById('userGender');
const themeToggle = document.getElementById('themeToggle');
const themeLabel = document.getElementById('themeLabel');
const chartToggle = document.getElementById('chartToggle');
const resetHistoryBtn = document.getElementById('resetHistoryBtn');
const askGeminiBtn = document.getElementById('askGeminiBtn');

const hbToggle = document.getElementById('hbToggle');
const hbLabel = document.getElementById('hbLabel');

/* Gemini chat */
const chatFab = document.getElementById('chatFab');
const chatPanel = document.getElementById('chatPanel');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');

/* Charts */
const MAX_POINTS = 40;
let hrChart, spChart, gsrChart;

/* --- NEW: Data collection arrays --- */
let liveHrReadings = [];
let liveGsrReadings = [];
let liveSpo2Readings = [];
let testTimerInterval = null;

let spLast = null, spFlatCount = 0;
const SP_FLAT_LIMIT = 6;

const HISTORY_KEY = 'stressHistory';
const MAX_HISTORY = 10;

/* =========================
Â  THEME + PERSISTENCE
Â  ========================= */
function applyTheme(){
Â  const isLight = localStorage.getItem('theme') === 'light';
Â  if (isLight) document.body.classList.add('light'); else document.body.classList.remove('light');
Â  themeLabel.textContent = isLight ? 'Light' : 'Dark';
}
themeToggle.addEventListener('click', () => {
Â  const isLight = document.body.classList.toggle('light');
Â  localStorage.setItem('theme', isLight ? 'light' : 'dark');
Â  applyTheme();
});
applyTheme();

/* =========================
Â  AUDIO SYSTEMS
Â  ========================= */

/* --- Ambient (Breathing) Audio --- */
let ambientAudioCtx = null, ambientMasterGain = null, droneOsc = null, ambientLfo = null;
let ambientAudioPlaying = false;

function initAmbientAudio(){
Â  if (ambientAudioCtx) return;
Â  ambientAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
Â  ambientMasterGain = ambientAudioCtx.createGain();
Â  ambientMasterGain.gain.value = 0.0;
Â  ambientMasterGain.connect(ambientAudioCtx.destination);
Â  droneOsc = ambientAudioCtx.createOscillator();
Â  droneOsc.type = 'sine';
Â  droneOsc.frequency.value = 110;
Â  const droneGain = ambientAudioCtx.createGain();
Â  droneGain.gain.value = 0.0;
Â  ambientLfo = ambientAudioCtx.createOscillator();
Â  ambientLfo.type = 'sine';
Â  ambientLfo.frequency.value = 0.08;
Â  const lfoGain = ambientAudioCtx.createGain();
Â  lfoGain.gain.value = 0.25;
Â  ambientLfo.connect(lfoGain);
Â  lfoGain.connect(droneGain.gain);
Â  droneOsc.connect(droneGain);
Â  droneGain.connect(ambientMasterGain);
Â  const hp = ambientAudioCtx.createBiquadFilter();
Â  hp.type = 'highpass';
Â  hp.frequency.value = 20;
Â  const lp = ambientAudioCtx.createBiquadFilter();
Â  lp.type = 'lowpass';
Â  lp.frequency.value = 1200;
Â  droneGain.connect(hp);
Â  hp.connect(lp);
Â  lp.connect(ambientMasterGain);
Â  droneOsc.start();
Â  ambientLfo.start();
}

function setAmbientAudio(play) {
Â  Â  if (!ambientAudioCtx) initAmbientAudio();
Â  Â  if (play && !ambientAudioPlaying) {
Â  Â  Â  Â  ambientAudioCtx.resume().then(() => {
Â  Â  Â  Â  Â  Â  ambientMasterGain.gain.exponentialRampToValueAtTime(0.22, ambientAudioCtx.currentTime + 1.2);
Â  Â  Â  Â  Â  Â  ambientAudioPlaying = true;
Â  Â  Â  Â  });
Â  Â  } else if (!play && ambientAudioPlaying) {
Â  Â  Â  Â  ambientMasterGain.gain.exponentialRampToValueAtTime(0.0001, ambientAudioCtx.currentTime + 1.0);
Â  Â  Â  Â  ambientAudioPlaying = false;
Â  Â  }
}

/* --- Heartbeat Audio --- */
let hbAudioCtx = null, hbMasterGain = null;
let hbAudioPlaying = false;
let hbInterval = null;

function initHeartbeatAudio() {
Â  Â  if (hbAudioCtx) return;
Â  Â  hbAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
Â  Â  hbMasterGain = hbAudioCtx.createGain();
Â  Â  hbMasterGain.gain.value = 0.0; // Start silent
Â  Â  hbMasterGain.connect(hbAudioCtx.destination);
}

function playHeartbeatSound() {
Â  Â  if (!hbAudioCtx) return;
Â  Â  const now = hbAudioCtx.currentTime;
Â  Â Â 
Â  Â  // Thump 1 (BA)
Â  Â  const thumpOsc1 = hbAudioCtx.createOscillator();
Â  Â  thumpOsc1.type = 'sine';
Â  Â  thumpOsc1.frequency.setValueAtTime(70, now);
Â  Â  thumpOsc1.frequency.exponentialRampToValueAtTime(50, now + 0.1);
Â  Â  const thumpGain1 = hbAudioCtx.createGain();
Â  Â  thumpGain1.gain.setValueAtTime(0, now);
Â  Â  thumpGain1.gain.linearRampToValueAtTime(0.5, now + 0.02);
Â  Â  thumpGain1.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
Â  Â  thumpOsc1.connect(thumpGain1).connect(hbMasterGain);
Â  Â  thumpOsc1.start(now);
Â  Â  thumpOsc1.stop(now + 0.15);
Â  Â Â 
Â  Â  // Thump 2 (DUM)
Â  Â  const dumpTime = now + 0.12;
Â  Â  const thumpOsc2 = hbAudioCtx.createOscillator();
Â  Â  thumpOsc2.type = 'sine';
Â  Â  thumpOsc2.frequency.setValueAtTime(60, dumpTime);
Â  Â  thumpOsc2.frequency.exponentialRampToValueAtTime(40, dumpTime + 0.15);
Â  Â  const thumpGain2 = hbAudioCtx.createGain();
Â  Â  thumpGain2.gain.setValueAtTime(0, dumpTime);
Â  Â  thumpGain2.gain.linearRampToValueAtTime(0.4, dumpTime + 0.02);
Â  Â  thumpGain2.gain.exponentialRampToValueAtTime(0.001, dumpTime + 0.15);
Â  Â  thumpOsc2.connect(thumpGain2).connect(hbMasterGain);
Â  Â  thumpOsc2.start(dumpTime);
Â  Â  thumpOsc2.stop(dumpTime + 0.2);
}

hbToggle.addEventListener('click', () => {
Â  Â  if (!hbAudioCtx) initHeartbeatAudio();
Â  Â Â 
Â  Â  hbAudioPlaying = !hbAudioPlaying;
Â  Â  if (hbAudioPlaying) {
Â  Â  Â  Â  hbAudioCtx.resume().then(() => {
Â  Â  Â  Â  Â  Â  hbMasterGain.gain.exponentialRampToValueAtTime(0.3, hbAudioCtx.currentTime + 1.0);
Â  Â  Â  Â  Â  Â  playHeartbeatSound(); // Play one immediately
Â  Â  Â  Â  Â  Â  hbInterval = setInterval(playHeartbeatSound, 850); // ~70 bpm
Â  Â  Â  Â  Â  Â  hbLabel.textContent = 'HB On';
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  hbMasterGain.gain.exponentialRampToValueAtTime(0.0001, hbAudioCtx.currentTime + 1.0);
Â  Â  Â  Â  if (hbInterval) clearInterval(hbInterval);
Â  Â  Â  Â  hbInterval = null;
Â  Â  Â  Â  hbLabel.textContent = 'HB Off';
Â  Â  }
});

/* =========================
Â  CHARTS
Â  ========================= */
function createCharts(){
Â  const css = getComputedStyle(document.documentElement);
Â  const bad = css.getPropertyValue('--bad').trim() || '#f87171';
Â  const accent = css.getPropertyValue('--accent').trim() || '#22d3ee';
Â  const warn = css.getPropertyValue('--warn').trim() || '#facc15';

Â  function cfg(label, color){
Â  Â  return {
Â  Â  Â  type:'line',
Â  Â  Â  data:{labels:[],datasets:[{
Â  Â  Â  Â  label, data:[], borderColor:color,Â 
Â  Â  Â  Â  borderWidth:2.5,Â 
Â  Â  Â  Â  pointRadius:0,Â 
Â  Â  Â  Â  tension:0.4,Â 
Â  Â  Â  Â  fill:true,
Â  Â  Â  Â  backgroundColor: (ctx)=>{
Â  Â  Â  Â  Â  const chart = ctx.chart;
Â  Â  Â  Â  Â  const gradient = chart.ctx.createLinearGradient(0,0,0,chart.height);
Â  Â  Â  Â  Â  gradient.addColorStop(0, color + '33');
Â  Â  Â  Â  Â  gradient.addColorStop(1, color + '05');
Â  Â  Â  Â  Â  return gradient;
Â  Â  Â  Â  }
Â  Â  Â  }]},
Â  Â  Â  options:{
Â  Â  Â  Â  responsive:true, maintainAspectRatio:false, animation:false,
Â  Â  Â  Â  plugins:{legend:{display:false}},
Â  Â  Â  Â  scales:{
Â  Â  Â  Â  Â  x:{display:false, grid:{display:false}},
Â  Â  Â  Â  Â  y:{ticks:{color:css.getPropertyValue('--text-body')}, grid:{color:css.getPropertyValue('--card-border')}}
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  };
Â  }

Â  hrChart = new Chart(document.getElementById('hrChart'), cfg('Heart Rate', bad || '#f87171'));
Â  spChart = new Chart(document.getElementById('spChart'), cfg('SpO2', accent || '#22d3ee'));
Â  gsrChart = new Chart(document.getElementById('gsrChart'), cfg('GSR', warn || '#facc15'));

Â  spChart.options.scales.y.min = 80;
Â  spChart.options.scales.y.max = 100;
}
function updateChart(chart, value){
Â  if(!chart || !chart.data) return;
Â  if (!document.getElementById('chartToggle').checked) return;
Â  chart.data.labels.push('');
Â  chart.data.datasets[0].data.push(value);
Â  if (chart.data.labels.length > MAX_POINTS){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
Â  chart.update('none');
}
window.addEventListener('load', createCharts);

/* =========================
Â  WEATHER (geolocation helper)
Â  ========================= */
getLocationBtn.addEventListener('click', () => {
Â  if (navigator.geolocation){
Â  Â  getLocationBtn.disabled = true; getLocationBtn.textContent = '...';
Â  Â  navigator.geolocation.getCurrentPosition(fetchWeather, (e)=>{ alert('Location error: ' + e.message); getLocationBtn.disabled=false; getLocationBtn.textContent='ğŸ“'; });
Â  } else alert('Geolocation not supported.');
});
async function fetchWeather(position){
Â  try{
Â  Â  const {latitude,longitude} = position.coords;
Â  Â  const api = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
Â  Â  const r = await fetch(api); const data = await r.json();
Â  Â  if (data.current_weather && typeof data.current_weather.temperature === 'number'){
Â  Â  Â  roomTempInput.value = Math.round(data.current_weather.temperature);
Â  Â  }
Â  }catch(e){ console.error(e) } finally { getLocationBtn.disabled=false; getLocationBtn.textContent='ğŸ“'; }
}

/* =========================
Â  BLE CONNECT & DATA
Â  ========================= */

async function connectToDevice() {
Â  startBtn.disabled = true;
Â  startBtn.textContent = 'Connecting...';
Â Â 
Â  try {
Â  Â  if (!bleDevice || !bleDevice.gatt.connected) {
Â  Â  Â  setBLEStatus('Requesting device...', 'warn');
Â  Â  Â  bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }], optionalServices: [SERVICE_UUID] });
Â  Â  Â  bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
Â  Â  Â  setBLEStatus('Connecting...', 'warn');
Â  Â  Â  gattServer = await bleDevice.gatt.connect();
Â  Â  Â  setBLEStatus('Getting service...', 'warn');
Â  Â  Â  const service = await gattServer.getPrimaryService(SERVICE_UUID);
Â  Â  Â  setBLEStatus('Getting chars...', 'warn');
Â  Â  Â  dataCharacteristic = await service.getCharacteristic(CHAR_DATA_UUID);
Â  Â  Â  commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID);
Â  Â  Â  await dataCharacteristic.startNotifications();
Â  Â  Â  dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotification);
Â  Â  Â  setBLEStatus('Connected', 'good');
Â  Â  }
Â  Â Â 
Â  Â  // --- MODIFIED: Open modal *after* connecting ---
Â  Â  profileTitle.textContent = 'Profile for New Test';
Â  Â  saveProfileBtn.textContent = 'Save & Start Test';
Â  Â  document.body.dataset.startTestOnSave = 'true';
Â  Â  profileModal.classList.add('active');

Â  } catch (err) {
Â  Â  console.error('BLE Err', err);
Â  Â  setBLEStatus('Error', 'bad');
Â  Â  if (bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect();
Â  } finally {
Â  Â  startBtn.disabled = false;
Â  Â  startBtn.textContent = 'Connect & Start Test';
Â  }
}

// --- NEW: Function to start the JS timer ---
function startJsTimer() {
Â  let timeLeft = TEST_DURATION_S;
Â  statusText.textContent = 'MEASURING';
Â  countText.textContent = timeLeft;
Â Â 
Â  if (testTimerInterval) clearInterval(testTimerInterval); // Clear any old timer
Â Â 
Â  testTimerInterval = setInterval(() => {
Â  Â  timeLeft--;
Â  Â  countText.textContent = timeLeft;
Â  Â Â 
Â  Â  if (timeLeft <= 0) {
Â  Â  Â  clearInterval(testTimerInterval);
Â  Â  Â  testTimerInterval = null;
Â  Â  Â  stopTest(); // Call stop function when timer ends
Â  Â  }
Â  }, 1000);
}

// --- NEW: Function to stop the test and process data ---
async function stopTest() {
Â  statusText.textContent = 'CALCULATING...';
Â  countText.textContent = '0';
Â Â 
Â  // 1. Tell ESP32 to stop streaming and turn off buzzer
Â  try {
Â  Â  const command = JSON.stringify({ command: "stop" });
Â  Â  await commandCharacteristic.writeValue(textEncoder.encode(command));
Â  } catch (err) {
Â  Â  console.warn("Failed to send STOP command", err);
Â  }
Â Â 
Â  // 2. Process the collected data
Â  const hr_avg = calculateAverage(liveHrReadings.filter(hr => hr > 35)); // Filter out 0s
Â  const gsr_avg = calculateAverage(liveGsrReadings.filter(gsr => gsr > 0)); // Filter out 0s
Â  const spo2_avg = calculateAverage(liveSpo2Readings.filter(sp => sp > 80)); // Filter out -1s
Â Â 
Â  console.log("Final Averages:", { hr_avg, gsr_avg, spo2_avg });
Â  console.log("Collected Data:", { liveHrReadings, liveGsrReadings, liveSpo2Readings });

Â  // 3. Get profile data
Â  const age = parseInt(ageInput.value || '30', 10);
Â  const gender = genderInput.value || 'male';
Â  const temp = parseInt(roomTempInput.value || '30', 10);
Â Â 
Â  // 4. Calculate stress level in JavaScript
Â  const { level, overview } = calculateStressLevel(hr_avg, gsr_avg, age, gender, temp);
Â Â 
Â  // 5. Display results
Â  analysisSection.style.display = 'block';
Â  finalLevelText.textContent = level;
Â  finalLevelText.className = `level-${level}`;
Â  overviewText.textContent = overview;
Â  overviewText.style.display = 'block';
Â Â 
Â  // 6. Save to history
Â  saveSession({
Â  Â  level: level,
Â  Â  hr: hr_avg > 0 ? Math.round(hr_avg) : '--',
Â  Â  spo2: spo2_avg > 0 ? Math.round(spo2_avg) : '--',
Â  Â  gsr: gsr_avg >= 0 ? Math.round(gsr_avg) : '--',
Â  Â  date: new Date().toLocaleString('en-IN'),
Â  Â  name: nameInput.value || 'â€”',
Â  Â  age: ageInput.value || 'â€”'
Â  });
Â Â 
Â  renderStaticSuggestions(level);
}

// --- NEW: Helper function to average arrays ---
function calculateAverage(arr) {
Â  if (!arr || arr.length === 0) return 0;
Â  const sum = arr.reduce((a, b) => a + b, 0);
Â  return sum / arr.length;
}


// "Connect & Start" button now connects, *then* opens modal
startBtn.addEventListener('click', connectToDevice);

function onDisconnected(){
Â  setBLEStatus('Disconnected','bad');
Â  statusText.textContent = 'IDLE';
Â  countText.textContent = '0';
Â  if (testTimerInterval) clearInterval(testTimerInterval); // Stop timer on disconnect
Â  analysisSection.style.display = 'none';
Â  bleDevice = null;
Â  startBtn.textContent = 'Connect & Start Test';
}

let statusTimeout = null;
function setBLEStatus(message, level){
Â  bleStatusText.textContent = message;
Â  let colorVar = '--bad';
Â  if (level === 'good') colorVar = '--good';
Â  else if (level === 'warn') colorVar = '--warn';
Â  bleStatusText.style.color = getComputedStyle(document.documentElement).getPropertyValue(colorVar);
Â Â 
Â  if(message === 'Receiving...'){
Â  Â  bleStatus.classList.add('pulse-receiving');
Â  Â  if(statusTimeout) clearTimeout(statusTimeout);
Â  Â  statusTimeout = setTimeout(() => {
Â  Â  Â  Â  setBLEStatus('Connected', 'good');
Â  Â  Â  Â  bleStatus.classList.remove('pulse-receiving');
Â  Â  }, 500);
Â  } else {
Â  Â  if(statusTimeout) clearTimeout(statusTimeout);
Â  Â  bleStatus.classList.remove('pulse-receiving');
Â  }
}

/* =========================
Â  Data handling (now much simpler)
Â  ========================= */
function handleDataNotification(event){
Â  if (bleStatusText.textContent === 'Connected') {
Â  Â  Â  setBLEStatus('Receiving...', 'good');
Â  }
Â Â 
Â  const jsonString = textDecoder.decode(event.target.value);
Â  try {
Â  Â  const data = JSON.parse(jsonString);

Â  Â  // --- This function now ONLY updates live UI and stores data ---
Â  Â Â 
Â  Â  const hrRaw = Number(data.hr) || 0;
Â  Â  const spo2Raw = Number(data.spo2) || -1;
Â  Â  const gsrRaw = Number(data.gsr) || 0;

Â  Â  // Update UI
Â  Â  valHR.textContent = hrRaw > 0 ? hrRaw : '--';
Â  Â  valSp.textContent = (spo2Raw > 0) ? spo2Raw : '--';
Â  Â  valGSR.textContent = gsrRaw >= 0 ? gsrRaw : '--';

Â  Â  // Add to charts
Â  Â  if (hrRaw > 0 && hrRaw < 220) updateChart(hrChart, hrRaw);
Â  Â  if (spo2Raw > 0 && spo2Raw <= 100) updateChart(spChart, spo2Raw);
Â  Â  if (gsrRaw >= 0) updateChart(gsrChart, gsrRaw);
Â  Â Â 
Â  Â  // --- Store raw values for final calculation ---
Â  Â  liveHrReadings.push(hrRaw);
Â  Â  liveGsrReadings.push(gsrRaw);
Â  Â  liveSpo2Readings.push(spo2Raw);

Â  Â  // Pulse animation
Â  Â  if (hrRaw > 0 && !valHR.classList.contains('pulsing')) {
Â  Â  Â  Â  valHR.classList.add('pulsing');
Â  Â  Â  Â  valHR.addEventListener('animationend', () => {
Â  Â  Â  Â  Â  Â  valHR.classList.remove('pulsing');
Â  Â  Â  Â  }, { once: true });
Â  Â  }

Â  Â  detectFlatSpO2(spo2Raw);

Â  } catch (err) {
Â  Â  console.error('Data Parse Error! Check ESP32 JSON format.', err);
Â  Â  console.error('Received problematic string:', jsonString);
Â  }
}

/* =========================
Â  NEW STRESS CALCULATION LOGIC
Â  ========================= */
function calculateStressLevel(hr_avg, gsr_avg, age, gender, temp) {
Â  Â  console.log(`Calculating stress with: HR:${hr_avg}, GSR:${gsr_avg}, Age:${age}, Gender:${gender}, Temp:${temp}`);
Â  Â  let overview = "";
Â  Â Â 
Â  Â  // --- 1. Get HR Baseline (Based on research) ---
Â  Â  let baselineHR = 70; // Default average
Â  Â  if (age >= 18 && age <= 25) baselineHR = 70;
Â  Â  else if (age >= 26 && age <= 35) baselineHR = 71;
Â  Â  else if (age >= 36 && age <= 45) baselineHR = 72;
Â  Â  else if (age >= 46 && age <= 55) baselineHR = 73;
Â  Â  else if (age >= 56 && age <= 65) baselineHR = 72;
Â  Â  else if (age > 65) baselineHR = 70;

Â  Â  // Adjust for gender (on avg, female RHR is 2-7bpm higher)
Â  Â  if (gender === 'female') {
Â  Â  Â  Â  baselineHR += 3;
Â  Â  }

Â  Â  // --- 2. Calculate HR Score ---
Â  Â  const hr_delta = hr_avg - baselineHR;
Â  Â  let hr_score = 0;
Â  Â  if (hr_delta > 25) hr_score = 100; // e.g., 72 -> 97+
Â  Â  else if (hr_delta > 15) hr_score = 70; // e.g., 72 -> 87
Â  Â  else if (hr_delta > 5) hr_score = 40;Â  // e.g., 72 -> 77
Â  Â  else hr_score = 10;
Â  Â Â 
Â  Â  if (hr_delta > 15) overview += `Your heart rate was notably elevated for your age and gender. `;
Â  Â  else if (hr_delta > 5) overview += `Your heart rate was slightly elevated. `;
Â  Â  else overview += `Your heart rate was in a calm range. `;

Â  Â  // --- 3. Calculate GSR Score (and apply temp modifier) ---
Â  Â  // (These values are in kOhms from a typical 10-bit ADC, ~0-1023)
Â  Â  // A *higher* gsr_avg value means *lower* stress (more resistance).
Â  Â  // A *lower* gsr_avg value means *higher* stress (less resistance, more sweat).
Â  Â Â 
Â  Â  let gsr_mod = 0;
Â  Â  if (temp > 28) gsr_mod = 50; // Hot room: expect more sweat. Be *less* sensitive. (add 50 to gsr)
Â  Â  if (temp < 20) gsr_mod = -50; // Cold room: expect less sweat. Be *more* sensitive. (sub 50 from gsr)
Â  Â Â 
Â  Â  const gsr_modified = gsr_avg + gsr_mod;
Â  Â Â 
Â  Â  let gsr_score = 0;
Â  Â  if (gsr_modified < 300) gsr_score = 100; // Very high stress
Â  Â  else if (gsr_modified < 450) gsr_score = 70; // High stress
Â  Â  else if (gsr_modified < 600) gsr_score = 40; // Moderate stress
Â  Â  else gsr_score = 10; // Low stress
Â  Â Â 
Â  Â  if (gsr_score > 70) overview += `Your skin conductance was high, indicating a strong physiological arousal.`;
Â  Â  else if (gsr_score > 40) overview += `Your skin conductance showed signs of arousal.`;
Â  Â  else overview += `Your skin activity appears low and calm.`;

Â  Â  // --- 4. Final Weighted Score ---
Â  Â  const final_score = (hr_score * 0.6) + (gsr_score * 0.4);

Â  Â  // --- 5. Determine Level ---
Â  Â  let level = "LOW";
Â  Â  if (final_score > 75) level = "HIGH";
Â  Â  else if (final_score > 45) level = "MODERATE";
Â  Â Â 
Â  Â  console.log(`Scores: HR_Score=${hr_score}, GSR_Score=${gsr_score}, Final=${final_score}, Level=${level}`);
Â  Â  return { level, overview };
}
/* ========================= */


function detectFlatSpO2(spo2Raw){
Â  if (typeof spo2Raw !== 'number') return;
Â  if (spo2Raw === spLast && spo2Raw > 0){
Â  Â  spFlatCount++;
Â  } else {
Â  Â  spFlatCount = 0;
Â  Â  spLast = spo2Raw;
Â  }

Â  if (spFlatCount >= SP_FLAT_LIMIT){
Â  Â  suggestList.innerHTML = `<li>âš ï¸ SpOâ‚‚ is not varying â€” sensor may not detect pulse. Tips:
Â  Â  Â  <ul style="margin:6px 0 0 18px">
Â  Â  Â  Â  <li>Fully cover sensor with finger; moderate pressure.</li>
Â  Â  Â  Â  <li>Reduce ambient light; cover sensor housing.</li>
Â  Â  Â  </ul>
Â  Â  </li>`;
Â  Â  spFlatCount = 0;Â 
Â  }
}

/* =========================
Â  Local suggestions & history
Â  ========================= */
const staticSuggestions = {
Â  LOW: [
Â  Â  "ğŸ˜Œ You're in a calm state. Great job. Take a moment to acknowledge this feeling.",
Â  Â  "ğŸ§˜ Try a simple 3-minute mindfulness exercise to maintain this calm.",
Â  Â  "ğŸ’§ Remember to stay hydrated. A glass of water can help maintain balance."
Â  ],
Â  MODERATE: [
Â  Â  "âš ï¸ Slight stress detected. Try the '4-7-8' breathing technique: inhale for 4s, hold for 7s, exhale for 8s. Repeat 3 times.",
Â  Â  "ğŸš¶ Take a 5-minute walk, focusing on your surroundings. Notice 3 things you can see and 2 things you can hear.",
Â  Â  "ğŸ¥¤ Drink some water. Dehydration can sometimes mimic or contribute to feelings of stress."
Â  ],
Â  HIGH: [
Â  Â  "ğŸ›‘ High stress detected. Please pause what you are doing. Your well-being is the priority.",
Â  Â  "ğŸ§˜â€â™€ï¸ Use the '5-4-3-2-1' grounding technique: Name 5 things you see, 4 things you feel, 3 things you hear, 2 things you smell, and 1 thing you taste.",
Â  Â  "ğŸ—£ If possible, step away from your current situation for a few minutes. A change of scenery can help."
Â  ]
};

function renderStaticSuggestions(level){
Â  suggestList.innerHTML = '';
Â  const all = staticSuggestions[level] || staticSuggestions.MODERATE;
Â Â 
Â  const shuffled = [...all].sort(() => 0.5 - Math.random());
Â  const count = Math.min(3, all.length);
Â  const selected = shuffled.slice(0, count);Â 
Â Â 
Â  selected.forEach(s => {
Â  Â  const li = document.createElement('li');Â 
Â  Â  li.innerHTML = s;
Â  Â  suggestList.appendChild(li);
Â  });
}

function saveSession(sessionData){
Â  let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
Â  history.unshift(sessionData);
Â  if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
Â  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
Â  renderHistory();
}
function renderHistory(){
Â  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
Â  if (!history.length){
Â  Â  historyList.innerHTML = `<li style="text-align:center;color:var(--text-body);padding:12px">No sessions recorded yet.</li>`; return;
Â  }
Â  historyList.innerHTML = history.map(h => `
Â  Â  <li class="history-item">
Â  Â  Â  <div style="flex:1"><div style="font-weight:700">${h.name || 'â€”'}</div><div class="muted" style="font-size:12px">${h.date}</div></div>
Â  Â  Â  <div style="min-width:80px;text-align:right"><div style="font-weight:700">${h.level}</div><div class="muted" style="font-size:12px">HR:${h.hr}</div></div>
Â  Â  </li>
Â  `).join('');
}
resetHistoryBtn.addEventListener('click', ()=>{ localStorage.removeItem(HISTORY_KEY); renderHistory(); });
renderHistory();

/* =========================
Â  Profile Management
Â  ========================= */
function saveProfile() {
Â  Â  localStorage.setItem('nw_profile', JSON.stringify({Â 
Â  Â  Â  Â  name: nameInput.value||'',Â 
Â  Â  Â  Â  age: ageInput.value||'',
Â  Â  Â  Â  gender: genderInput.value||''
Â  Â  }));
}
[nameInput, ageInput, genderInput].forEach(el => el.addEventListener('change', saveProfile));

// Load saved profile on page load
(() => {
Â  const p = JSON.parse(localStorage.getItem('nw_profile') || '{}');
Â  if (p.name) nameInput.value = p.name;
Â  if (p.age) ageInput.value = p.age;
Â  if (p.gender) genderInput.value = p.gender;
})();

/* =========================
Â  MODIFICATION: Breathing exercise JS
Â  ========================= */
let breathInterval = null, breathRunning = false;
function startBreathing(cycles = 6, inhale = 3, hold = 4, exhale = 6){
Â  stopBreathing(); 
Â  breathRunning = true;
Â  let step = 'inhale';
Â  let cycleCount = 0;
Â  breathCyclesLabel.textContent = cycles;
Â  breathDesc.textContent = `Follow the circle for ${cycles} cycles`;

Â  function doBreathStep() {
Â  Â  if (!breathRunning) return;
Â  Â  
Â  Â  if (step === 'inhale') {
Â  Â  Â  breathCircle.textContent = 'Inhale';
Â  Â  Â  breathCircle.className = 'breath-circle inhaling';
Â  Â  Â  breathCircle.style.transitionDuration = `${inhale}s`;
Â  Â  Â  breathInterval = setTimeout(() => {
Â  Â  Â  Â  step = 'hold';
Â  Â  Â  Â  doBreathStep();
Â  Â  Â  }, inhale * 1000);
Â  Â  } else if (step === 'hold') {
Â  Â  Â  breathCircle.textContent = 'Hold';
Â  Â  Â  // Stays in .inhaling state (large)
Â  Â  Â  breathInterval = setTimeout(() => {
Â  Â  Â  Â  step = 'exhale';
Â  Â  Â  Â  doBreathStep();
Â  Â  Â  }, hold * 1000);
Â  Â  } else if (step === 'exhale') {
Â  Â  Â  cycleCount++;
Â  Â  Â  if (cycleCount >= cycles) { stopBreathing(); return; }
Â  Â  Â  breathCyclesLabel.textContent = cycles - cycleCount;
Â  Â  Â  breathCircle.textContent = 'Exhale';
Â  Â  Â  breathCircle.className = 'breath-circle exhaling';
Â  Â  Â  breathCircle.style.transitionDuration = `${exhale}s`;
Â  Â  Â  breathInterval = setTimeout(() => {
Â  Â  Â  Â  step = 'inhale';
Â  Â  Â  Â  doBreathStep();
Â  Â  Â  }, exhale * 1000);
Â  Â  }
Â  }
Â  
Â  // Start the first step
Â  breathCircle.textContent = 'Get Ready...';
Â  breathCircle.className = 'breath-circle exhaling'; // Start in exhaled state
Â  breathCircle.style.transitionDuration = `1s`;
Â  setTimeout(doBreathStep, 1000); // Give 1s to get ready
}

function stopBreathing(){Â 
Â  Â  if (breathInterval) clearTimeout(breathInterval);Â 
Â  Â  breathInterval = null;Â 
Â  Â  breathRunning = false;Â 
Â  Â  breathCircle.className = 'breath-circle exhaling'; // Reset to exhaled state
Â  Â  breathCircle.style.transitionDuration = '1s'; // Smoothly stop
Â  Â  breathCircle.textContent = 'Stopped';Â 
}

openBreathBtn.addEventListener('click', ()=> {Â 
Â  Â  breatherModal.classList.add('active');Â 
Â  Â  setAmbientAudio(true);s
});
closeBreatherModal.addEventListener('click', ()=> {Â 
Â  Â  breatherModal.classList.remove('active');Â 
Â  Â  stopBreathing();Â 
Â  Â  setAmbientAudio(false);
});

breathStartBtn.addEventListener('click', ()=> {
Â  // Get timings from the dropdown
Â  const [inhale, hold, exhale] = breathSpeed.value.split(',').map(Number);
Â  startBreathing(6, inhale, hold, exhale);
});

breathStopBtn.addEventListener('click', ()=> {Â 
Â  Â  stopBreathing();Â 
});
/* --- END MODIFICATION --- */


/* =========================
Â  Gemini integration (AI)
Â  ========================= */

async function fetchWithBackoff(url, options, retries = 3, delay = 1000){
Â  try {
Â  Â  const resp = await fetch(url, options);
Â  Â  if (!resp.ok && retries > 0 && (resp.status === 429 || resp.status >= 500)) {
Â  Â  Â  await new Promise(r => setTimeout(r, delay));
Â  Â  Â  return fetchWithBackoff(url, options, retries - 1, delay * 2);
Â  Â  }
Â  Â  return resp;
Â  } catch (err) {
Â  Â  if (retries > 0){
Â  Â  Â  await new Promise(r => setTimeout(r, delay));
Â  Â  Â  return fetchWithBackoff(url, options, retries - 1, delay * 2);
Â  Â  }
Â  Â  throw err;
Â  }
}

async function askGeminiAnalysis(userQuestion='Please analyze my last session and give tips.') {
Â  if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
Â  Â  appendChatMessage('system', 'Gemini API key not set. Paste your API key into the HTML file (at the top of the <script> block) to enable this feature.');
Â  Â  const lastLevel = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]')[0]?.level || 'MODERATE';
Â  Â  renderStaticSuggestions(lastLevel);
Â  Â  return;
Â  }

Â  appendChatMessage('user', userQuestion);

Â  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
Â  const last = history[0] || null;
Â  const systemPrompt = `You are a compassionate wellness assistant. Provide concise, actionable advice based on sensor readings. Keep your analysis to 2-3 sentences and provide 3-4 very short, actionable bullet points as suggestions.`;
Â Â 
Â  const userPrompt = last ? `My name is ${last.name || 'not given'} and my age is ${last.age || 'not given'}.
My last session data was:
- Stress Level: ${last.level}
- Avg HR: ${last.hr} bpm
- Avg SpO2: ${last.spo2} %
- Avg GSR: ${last.gsr} (raw value)

My question is: ${userQuestion}` : userQuestion;

Â  const payload = {
Â  Â  "contents": [{ "parts": [{ "text": userPrompt }] }],
Â  Â  "systemInstruction": { "parts": [{ "text": systemPrompt }] },
Â  Â  "generationConfig": { "temperature": 0.5, "maxOutputTokens": 450 }
Â  };

Â  try {
Â  Â  appendChatMessage('system', 'Thinking...');
Â  Â  const resp = await fetchWithBackoff(GEMINI_BASE + GEMINI_API_KEY, {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  }, 3, 1000);

Â  Â  if (!resp.ok) throw new Error(`Gemini error ${resp.status}`);

Â  Â  const result = await resp.json();
Â  Â  const candidate = result.candidates?.[0];
Â  Â  const text = candidate?.content?.parts?.[0]?.text || candidate?.content?.[0]?.text || JSON.stringify(result);
Â  Â Â 
Â  Â  appendChatMessage('assistant', text);
Â  Â Â 
Â  Â  const parts = text.split('\n').filter(s => s.trim().length > 0);
Â  Â  suggestList.innerHTML = parts.map(s => `<li>${escapeHtml(s)}</li>`).join('');

Â  } catch (err) {
Â  Â  console.error('Gemini error', err);
Â  Â  appendChatMessage('assistant', 'Sorry â€” the AI analysis failed. Here are some general suggestions based on your results instead.');
Â  Â  const lastLevel = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]')[0]?.level || 'MODERATE';
Â  Â  renderStaticSuggestions(lastLevel);
Â  }
}

/* chat helpers */
function appendChatMessage(who, text){
Â  const div = document.createElement('div');
Â  if (who === 'user') div.style.textAlign = 'right', div.innerHTML = `<div style="display:inline-block;background:var(--accent);color:var(--bg);padding:8px;border-radius:8px;margin:6px">${escapeHtml(text)}</div>`;
Â  else if (who === 'assistant') div.innerHTML = `<div style="display:inline-block;background:var(--glass);color:var(--text);padding:8px;border-radius:8px;margin:6px">${text.replace(/\n/g, '<br>')}</div>`;
Â  else div.innerHTML = `<div style="display:inline-block;color:var(--text-body);padding:6px;margin:6px">${escapeHtml(text)}</div>`;
Â  chatMessages.appendChild(div);
Â  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

chatFab.addEventListener('click', ()=> chatPanel.classList.toggle('active'));
closeChatBtn.addEventListener('click', ()=> chatPanel.classList.remove('active'));
sendChatBtn.addEventListener('click', ()=> {
Â  const q = chatInput.value.trim();
Â  if (!q) return;
Â  askGeminiAnalysis(q);
Â  chatInput.value = '';
});

askGeminiBtn.addEventListener('click', ()=> {
Â  Â  analysisSection.style.display = 'block';
Â  Â  askGeminiAnalysis('Please analyze my last session and give tips.');
});

/* =========================
Â  Modal UI listeners
Â  ========================= */
sosBtn.addEventListener('click', ()=> document.getElementById('sos-modal').classList.add('active'));
closeSosModal.addEventListener('click', ()=> document.getElementById('sos-modal').classList.remove('active'));

resourcesBtn.addEventListener('click', () => resourcesModal.classList.add('active'));
closeResourcesModal.addEventListener('click', () => resourcesModal.classList.remove('active'));

profileBtn.addEventListener('click', () => {
Â  Â  profileTitle.textContent = 'Your Profile';
Â  Â  saveProfileBtn.textContent = 'Save & Close';
Â  Â  document.body.dataset.startTestOnSave = 'false';
Â  Â  profileModal.classList.add('active');
});

closeProfileModal.addEventListener('click', () => {
Â  Â  profileModal.classList.remove('active');
Â  Â  document.body.dataset.startTestOnSave = 'false';
});

saveProfileBtn.addEventListener('click', async () => {
Â  Â  saveProfile();
Â  Â  profileModal.classList.remove('active');
Â  Â Â 
Â  Â  if (document.body.dataset.startTestOnSave === 'true') {
Â  Â  Â  document.body.dataset.startTestOnSave = 'false';
Â  Â  Â Â 
Â  Â  Â  // --- NEW: Start the test by sending the START command ---
Â  Â  Â  try {
Â  Â  Â  Â  const temp = parseInt(roomTempInput.value || '30', 10);
Â  Â  Â  Â  let irThr = 20000;
Â  Â  Â  Â  if (temp < 20) irThr = 15000;
Â  Â  Â  Â  else if (temp >= 28) irThr = 25000;

Â  Â  Â  Â  // Clear old data
Â  Â  Â  Â  liveHrReadings = [];
Â  Â  Â  Â  liveGsrReadings = [];
Â  Â  Â  Â  liveSpo2Readings = [];
Â  Â  Â  Â  [hrChart, spChart, gsrChart].forEach(c => { if (c) { c.data.labels = []; c.data.datasets[0].data = []; c.update(); } });
Â  Â  Â  Â  analysisSection.style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Send start command
Â  Â  Â  Â  const command = JSON.stringify({Â 
Â  Â  Â  Â  Â  Â  command: "start",
Â  Â  Â  Â  Â  Â  irThreshold: irThrÂ 
Â  Â  Â  Â  });
Â  Â  Â  Â  await commandCharacteristic.writeValue(textEncoder.encode(command));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Start the webpage timer
Â  Â  Â  Â  startJsTimer();
Â  Â  Â  Â Â 
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Failed to send START command", err);
Â  Â  Â  Â  setBLEStatus('Command Failed', 'bad');
Â  Â  Â  }
Â  Â  }
});

/* =========================
Â  Utility helpers
Â  ========================= */
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* =========================
Â  Final note / warning about API keys
Â  ========================= */
if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
Â  Â  console.warn("************************************************************");
Â  Â  console.warn("GEMINI_API_KEY is not set!");
Â  Â  console.warn("Paste your key at the top of the <script> block in this HTML file.");
Â  Â  console.warn("************************************************************");
} else {
Â  Â  console.log("NeuroWell dashboard loaded. Gemini key is set.");
}

/* End of script */
</script>
</body>
</html>
